<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Reactor - 核心特征 | Haoyuan&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_3114978_qe0b39no76.css">
    <noscript><meta http-equiv="refresh" content="0; url=/noscript.html"><style>.theme-vdoing-content { display:none }</style></noscript>
    <script src="https://cdn.jsdelivr.net/npm/twikoo@1.6.41/dist/twikoo.all.min.js"></script>
    <script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?720c7013e4bdca4370c380ffa206fbd7";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script>
    <meta name="description" content="Somnus Haoyuan个人博客, VuePress搭建, 使用了 Vdoing 主题, 学习Java, AI大模型等相关知识, 记录生活和技术路程, 同时分享编程技巧。">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="keywords" content="Web个人学习博客，学习是一件快乐的事情。">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.6aa5acdd.css" as="style"><link rel="preload" href="/assets/js/app.40d6eb57.js" as="script"><link rel="preload" href="/assets/js/2.84f16386.js" as="script"><link rel="preload" href="/assets/js/244.dffff977.js" as="script"><link rel="preload" href="/assets/js/15.107d5767.js" as="script"><link rel="preload" href="/assets/js/5.1ffba6c1.js" as="script"><link rel="preload" href="/assets/js/9.dba8a9bf.js" as="script"><link rel="preload" href="/assets/js/12.3f1ed9aa.js" as="script"><link rel="prefetch" href="/assets/js/10.2faf032d.js"><link rel="prefetch" href="/assets/js/100.20bf2323.js"><link rel="prefetch" href="/assets/js/101.58e9195d.js"><link rel="prefetch" href="/assets/js/102.934f4e2d.js"><link rel="prefetch" href="/assets/js/103.2e1edf2f.js"><link rel="prefetch" href="/assets/js/104.f11cb866.js"><link rel="prefetch" href="/assets/js/105.f031400c.js"><link rel="prefetch" href="/assets/js/106.8c306f6f.js"><link rel="prefetch" href="/assets/js/107.4cbb12e2.js"><link rel="prefetch" href="/assets/js/108.013594b5.js"><link rel="prefetch" href="/assets/js/109.855fb1f7.js"><link rel="prefetch" href="/assets/js/11.8d4c884c.js"><link rel="prefetch" href="/assets/js/110.169f17cd.js"><link rel="prefetch" href="/assets/js/111.f3bffe9c.js"><link rel="prefetch" href="/assets/js/112.b05741ea.js"><link rel="prefetch" href="/assets/js/113.c4ea6307.js"><link rel="prefetch" href="/assets/js/114.70c200f9.js"><link rel="prefetch" href="/assets/js/115.10d6bcd7.js"><link rel="prefetch" href="/assets/js/116.0929f9ea.js"><link rel="prefetch" href="/assets/js/117.61aa7090.js"><link rel="prefetch" href="/assets/js/118.eccb075c.js"><link rel="prefetch" href="/assets/js/119.fef47816.js"><link rel="prefetch" href="/assets/js/120.372cb96d.js"><link rel="prefetch" href="/assets/js/121.2560116c.js"><link rel="prefetch" href="/assets/js/122.726e3fde.js"><link rel="prefetch" href="/assets/js/123.6de6a113.js"><link rel="prefetch" href="/assets/js/124.d52d8b46.js"><link rel="prefetch" href="/assets/js/125.409b7367.js"><link rel="prefetch" href="/assets/js/126.c4e734c2.js"><link rel="prefetch" href="/assets/js/127.13e37428.js"><link rel="prefetch" href="/assets/js/128.f035adf7.js"><link rel="prefetch" href="/assets/js/129.fefb2424.js"><link rel="prefetch" href="/assets/js/13.06f0d806.js"><link rel="prefetch" href="/assets/js/130.bb7d196c.js"><link rel="prefetch" href="/assets/js/131.7850d655.js"><link rel="prefetch" href="/assets/js/132.1009bf67.js"><link rel="prefetch" href="/assets/js/133.a61ca829.js"><link rel="prefetch" href="/assets/js/134.83670718.js"><link rel="prefetch" href="/assets/js/135.476146e2.js"><link rel="prefetch" href="/assets/js/136.1593b8d9.js"><link rel="prefetch" href="/assets/js/137.9bc3b9a4.js"><link rel="prefetch" href="/assets/js/138.05c298a8.js"><link rel="prefetch" href="/assets/js/139.baa0f361.js"><link rel="prefetch" href="/assets/js/14.e8a14911.js"><link rel="prefetch" href="/assets/js/140.f7a1498f.js"><link rel="prefetch" href="/assets/js/141.d1117262.js"><link rel="prefetch" href="/assets/js/142.b990b892.js"><link rel="prefetch" href="/assets/js/143.3e0e3d6c.js"><link rel="prefetch" href="/assets/js/144.3c99f5d1.js"><link rel="prefetch" href="/assets/js/145.9efc9743.js"><link rel="prefetch" href="/assets/js/146.1b85bb65.js"><link rel="prefetch" href="/assets/js/147.552bbe6f.js"><link rel="prefetch" href="/assets/js/148.38c079c9.js"><link rel="prefetch" href="/assets/js/149.8a32fdf3.js"><link rel="prefetch" href="/assets/js/150.d73e6d70.js"><link rel="prefetch" href="/assets/js/151.139e669e.js"><link rel="prefetch" href="/assets/js/152.6fe2e61f.js"><link rel="prefetch" href="/assets/js/153.e88f4410.js"><link rel="prefetch" href="/assets/js/154.143abe60.js"><link rel="prefetch" href="/assets/js/155.35c81a23.js"><link rel="prefetch" href="/assets/js/156.f0e2d6ad.js"><link rel="prefetch" href="/assets/js/157.468fb051.js"><link rel="prefetch" href="/assets/js/158.cd86d09f.js"><link rel="prefetch" href="/assets/js/159.833f916a.js"><link rel="prefetch" href="/assets/js/16.f07b2571.js"><link rel="prefetch" href="/assets/js/160.aa4c01ba.js"><link rel="prefetch" href="/assets/js/161.bbc9ee08.js"><link rel="prefetch" href="/assets/js/162.41293d9d.js"><link rel="prefetch" href="/assets/js/163.cbfb7d74.js"><link rel="prefetch" href="/assets/js/164.aad4d4b8.js"><link rel="prefetch" href="/assets/js/165.3b69b465.js"><link rel="prefetch" href="/assets/js/166.646fb23c.js"><link rel="prefetch" href="/assets/js/167.c874eb18.js"><link rel="prefetch" href="/assets/js/168.cf29dd2c.js"><link rel="prefetch" href="/assets/js/169.d10f2b80.js"><link rel="prefetch" href="/assets/js/17.84d94fc1.js"><link rel="prefetch" href="/assets/js/170.69f2f0de.js"><link rel="prefetch" href="/assets/js/171.d05e324a.js"><link rel="prefetch" href="/assets/js/172.213b6735.js"><link rel="prefetch" href="/assets/js/173.bdb037f2.js"><link rel="prefetch" href="/assets/js/174.90dd7a19.js"><link rel="prefetch" href="/assets/js/175.65e79e89.js"><link rel="prefetch" href="/assets/js/176.6e21166e.js"><link rel="prefetch" href="/assets/js/177.efb7d4d2.js"><link rel="prefetch" href="/assets/js/178.2500c230.js"><link rel="prefetch" href="/assets/js/179.9d6c29aa.js"><link rel="prefetch" href="/assets/js/18.bb0be2bd.js"><link rel="prefetch" href="/assets/js/180.8935ec8e.js"><link rel="prefetch" href="/assets/js/181.0ba3667a.js"><link rel="prefetch" href="/assets/js/182.1527192a.js"><link rel="prefetch" href="/assets/js/183.e32e0b1a.js"><link rel="prefetch" href="/assets/js/184.f16730e1.js"><link rel="prefetch" href="/assets/js/185.6817fe7e.js"><link rel="prefetch" href="/assets/js/186.06f91832.js"><link rel="prefetch" href="/assets/js/187.b2e68c56.js"><link rel="prefetch" href="/assets/js/188.c459a7b2.js"><link rel="prefetch" href="/assets/js/189.c5dc9c9a.js"><link rel="prefetch" href="/assets/js/19.babf254d.js"><link rel="prefetch" href="/assets/js/190.539ad7b9.js"><link rel="prefetch" href="/assets/js/191.d4fa3d3f.js"><link rel="prefetch" href="/assets/js/192.904f7b4f.js"><link rel="prefetch" href="/assets/js/193.cc14cf04.js"><link rel="prefetch" href="/assets/js/194.11881e6e.js"><link rel="prefetch" href="/assets/js/195.78172201.js"><link rel="prefetch" href="/assets/js/196.79388c52.js"><link rel="prefetch" href="/assets/js/197.93ca4c41.js"><link rel="prefetch" href="/assets/js/198.452abacb.js"><link rel="prefetch" href="/assets/js/199.6ef2d196.js"><link rel="prefetch" href="/assets/js/20.5e77ec48.js"><link rel="prefetch" href="/assets/js/200.0656fb6f.js"><link rel="prefetch" href="/assets/js/201.19f892f2.js"><link rel="prefetch" href="/assets/js/202.ece43be4.js"><link rel="prefetch" href="/assets/js/203.d5298504.js"><link rel="prefetch" href="/assets/js/204.3d2dc50d.js"><link rel="prefetch" href="/assets/js/205.d24257e6.js"><link rel="prefetch" href="/assets/js/206.bacdf227.js"><link rel="prefetch" href="/assets/js/207.6fd49f37.js"><link rel="prefetch" href="/assets/js/208.c4d1371e.js"><link rel="prefetch" href="/assets/js/209.efc2bdb7.js"><link rel="prefetch" href="/assets/js/21.b614b7ce.js"><link rel="prefetch" href="/assets/js/210.ff884ca2.js"><link rel="prefetch" href="/assets/js/211.579d567a.js"><link rel="prefetch" href="/assets/js/212.b23d9c7a.js"><link rel="prefetch" href="/assets/js/213.f972e645.js"><link rel="prefetch" href="/assets/js/214.677ab8e4.js"><link rel="prefetch" href="/assets/js/215.8317429b.js"><link rel="prefetch" href="/assets/js/216.fe793ca1.js"><link rel="prefetch" href="/assets/js/217.d15bd553.js"><link rel="prefetch" href="/assets/js/218.f2476c1a.js"><link rel="prefetch" href="/assets/js/219.5de46d42.js"><link rel="prefetch" href="/assets/js/22.e14f8d0d.js"><link rel="prefetch" href="/assets/js/220.c49bbd40.js"><link rel="prefetch" href="/assets/js/221.4004aa7d.js"><link rel="prefetch" href="/assets/js/222.5d16df13.js"><link rel="prefetch" href="/assets/js/223.cb628b00.js"><link rel="prefetch" href="/assets/js/224.a6d24d03.js"><link rel="prefetch" href="/assets/js/225.d2bacd2b.js"><link rel="prefetch" href="/assets/js/226.8d5b24c0.js"><link rel="prefetch" href="/assets/js/227.76f901fc.js"><link rel="prefetch" href="/assets/js/228.9fe5796a.js"><link rel="prefetch" href="/assets/js/229.441566ae.js"><link rel="prefetch" href="/assets/js/23.ffcd828d.js"><link rel="prefetch" href="/assets/js/230.af5be7d3.js"><link rel="prefetch" href="/assets/js/231.836eacb5.js"><link rel="prefetch" href="/assets/js/232.e71d875f.js"><link rel="prefetch" href="/assets/js/233.c0f4811a.js"><link rel="prefetch" href="/assets/js/234.393292da.js"><link rel="prefetch" href="/assets/js/235.f0410328.js"><link rel="prefetch" href="/assets/js/236.c8e24b2a.js"><link rel="prefetch" href="/assets/js/237.c7511291.js"><link rel="prefetch" href="/assets/js/238.dcf9d74f.js"><link rel="prefetch" href="/assets/js/239.89c3f7fb.js"><link rel="prefetch" href="/assets/js/24.d2488dd7.js"><link rel="prefetch" href="/assets/js/240.6a231b35.js"><link rel="prefetch" href="/assets/js/241.9518dd8b.js"><link rel="prefetch" href="/assets/js/242.49fee092.js"><link rel="prefetch" href="/assets/js/243.99b57f78.js"><link rel="prefetch" href="/assets/js/245.cdcb59f8.js"><link rel="prefetch" href="/assets/js/246.ee61d776.js"><link rel="prefetch" href="/assets/js/247.03b13721.js"><link rel="prefetch" href="/assets/js/248.5a48e87f.js"><link rel="prefetch" href="/assets/js/249.cd1b3546.js"><link rel="prefetch" href="/assets/js/25.c4ac0557.js"><link rel="prefetch" href="/assets/js/250.204cda9d.js"><link rel="prefetch" href="/assets/js/251.cf5a43ea.js"><link rel="prefetch" href="/assets/js/252.e87cba9e.js"><link rel="prefetch" href="/assets/js/253.31cd4b77.js"><link rel="prefetch" href="/assets/js/254.bc198d0d.js"><link rel="prefetch" href="/assets/js/255.555f461c.js"><link rel="prefetch" href="/assets/js/256.35549c82.js"><link rel="prefetch" href="/assets/js/257.eb8b7f14.js"><link rel="prefetch" href="/assets/js/258.079163a3.js"><link rel="prefetch" href="/assets/js/259.855bf637.js"><link rel="prefetch" href="/assets/js/26.bbaa3da7.js"><link rel="prefetch" href="/assets/js/260.8dbdaa34.js"><link rel="prefetch" href="/assets/js/261.3a3a3d48.js"><link rel="prefetch" href="/assets/js/262.ff4335e2.js"><link rel="prefetch" href="/assets/js/263.4e2cc7b6.js"><link rel="prefetch" href="/assets/js/264.8bf179e4.js"><link rel="prefetch" href="/assets/js/265.a0d8d94a.js"><link rel="prefetch" href="/assets/js/266.c7cb4303.js"><link rel="prefetch" href="/assets/js/267.cd833024.js"><link rel="prefetch" href="/assets/js/268.18023bf7.js"><link rel="prefetch" href="/assets/js/269.d698565e.js"><link rel="prefetch" href="/assets/js/27.cbc4cccc.js"><link rel="prefetch" href="/assets/js/270.4f42ac21.js"><link rel="prefetch" href="/assets/js/271.01513156.js"><link rel="prefetch" href="/assets/js/272.89b02542.js"><link rel="prefetch" href="/assets/js/273.d97ca2b8.js"><link rel="prefetch" href="/assets/js/274.2d44453c.js"><link rel="prefetch" href="/assets/js/275.0454b122.js"><link rel="prefetch" href="/assets/js/276.2a798428.js"><link rel="prefetch" href="/assets/js/277.1b773039.js"><link rel="prefetch" href="/assets/js/278.85318522.js"><link rel="prefetch" href="/assets/js/279.0b9b7dd0.js"><link rel="prefetch" href="/assets/js/28.2811fe35.js"><link rel="prefetch" href="/assets/js/280.34d99bb9.js"><link rel="prefetch" href="/assets/js/281.50efe138.js"><link rel="prefetch" href="/assets/js/282.730115fe.js"><link rel="prefetch" href="/assets/js/283.51e62999.js"><link rel="prefetch" href="/assets/js/284.a366d7e9.js"><link rel="prefetch" href="/assets/js/285.9f0bb34b.js"><link rel="prefetch" href="/assets/js/286.723a14e7.js"><link rel="prefetch" href="/assets/js/287.787b390a.js"><link rel="prefetch" href="/assets/js/288.3eab7c63.js"><link rel="prefetch" href="/assets/js/289.eb4897c8.js"><link rel="prefetch" href="/assets/js/29.553c7a36.js"><link rel="prefetch" href="/assets/js/290.3f12b330.js"><link rel="prefetch" href="/assets/js/291.aecfc068.js"><link rel="prefetch" href="/assets/js/292.cf2ea18c.js"><link rel="prefetch" href="/assets/js/293.a7576751.js"><link rel="prefetch" href="/assets/js/294.59a2ea07.js"><link rel="prefetch" href="/assets/js/295.21aafb3b.js"><link rel="prefetch" href="/assets/js/296.9d03ef74.js"><link rel="prefetch" href="/assets/js/297.e5333eaa.js"><link rel="prefetch" href="/assets/js/298.6b331403.js"><link rel="prefetch" href="/assets/js/299.aed7fe75.js"><link rel="prefetch" href="/assets/js/3.91d9010e.js"><link rel="prefetch" href="/assets/js/30.f752542d.js"><link rel="prefetch" href="/assets/js/300.4b43249a.js"><link rel="prefetch" href="/assets/js/301.8a2d29aa.js"><link rel="prefetch" href="/assets/js/302.2ebd826a.js"><link rel="prefetch" href="/assets/js/303.4bf03f68.js"><link rel="prefetch" href="/assets/js/304.842e0021.js"><link rel="prefetch" href="/assets/js/305.0689927e.js"><link rel="prefetch" href="/assets/js/306.9fe73451.js"><link rel="prefetch" href="/assets/js/307.d6dfc95b.js"><link rel="prefetch" href="/assets/js/308.f6b5fa22.js"><link rel="prefetch" href="/assets/js/309.f0a9e8bf.js"><link rel="prefetch" href="/assets/js/31.efc35430.js"><link rel="prefetch" href="/assets/js/310.b6a97346.js"><link rel="prefetch" href="/assets/js/311.e09ede20.js"><link rel="prefetch" href="/assets/js/312.9ede7559.js"><link rel="prefetch" href="/assets/js/313.70d997db.js"><link rel="prefetch" href="/assets/js/314.8f1cb40a.js"><link rel="prefetch" href="/assets/js/315.3dcbc212.js"><link rel="prefetch" href="/assets/js/316.503dd0d9.js"><link rel="prefetch" href="/assets/js/317.a2628cdc.js"><link rel="prefetch" href="/assets/js/318.79498962.js"><link rel="prefetch" href="/assets/js/319.6383a4d8.js"><link rel="prefetch" href="/assets/js/32.2e7f0ecf.js"><link rel="prefetch" href="/assets/js/320.df7b195d.js"><link rel="prefetch" href="/assets/js/321.a3a665d5.js"><link rel="prefetch" href="/assets/js/322.5f4bb853.js"><link rel="prefetch" href="/assets/js/323.08fc2754.js"><link rel="prefetch" href="/assets/js/324.2ee64ecf.js"><link rel="prefetch" href="/assets/js/325.0645a604.js"><link rel="prefetch" href="/assets/js/326.510326c5.js"><link rel="prefetch" href="/assets/js/327.58ead103.js"><link rel="prefetch" href="/assets/js/328.9c763bc9.js"><link rel="prefetch" href="/assets/js/329.8d27c776.js"><link rel="prefetch" href="/assets/js/33.0fb3ddd2.js"><link rel="prefetch" href="/assets/js/330.4b69506d.js"><link rel="prefetch" href="/assets/js/331.f4e9123c.js"><link rel="prefetch" href="/assets/js/332.decc5f74.js"><link rel="prefetch" href="/assets/js/333.e729cfe0.js"><link rel="prefetch" href="/assets/js/334.a6d25832.js"><link rel="prefetch" href="/assets/js/335.863ce340.js"><link rel="prefetch" href="/assets/js/336.e1fdfcce.js"><link rel="prefetch" href="/assets/js/337.7ec69ad4.js"><link rel="prefetch" href="/assets/js/338.6279e3b4.js"><link rel="prefetch" href="/assets/js/339.9b23235d.js"><link rel="prefetch" href="/assets/js/34.19748377.js"><link rel="prefetch" href="/assets/js/340.7b6c78dc.js"><link rel="prefetch" href="/assets/js/341.1e4bac65.js"><link rel="prefetch" href="/assets/js/342.b79997de.js"><link rel="prefetch" href="/assets/js/343.db33f886.js"><link rel="prefetch" href="/assets/js/344.13b20d62.js"><link rel="prefetch" href="/assets/js/345.c334203e.js"><link rel="prefetch" href="/assets/js/346.536c03d6.js"><link rel="prefetch" href="/assets/js/347.2184fbfa.js"><link rel="prefetch" href="/assets/js/348.57ccabdc.js"><link rel="prefetch" href="/assets/js/349.99b549fc.js"><link rel="prefetch" href="/assets/js/35.80d3df6e.js"><link rel="prefetch" href="/assets/js/350.a46457f1.js"><link rel="prefetch" href="/assets/js/351.9da55b6a.js"><link rel="prefetch" href="/assets/js/352.f3798216.js"><link rel="prefetch" href="/assets/js/353.f7b95ddb.js"><link rel="prefetch" href="/assets/js/354.436f104a.js"><link rel="prefetch" href="/assets/js/355.8951e7a3.js"><link rel="prefetch" href="/assets/js/356.d2f3e4eb.js"><link rel="prefetch" href="/assets/js/357.c14203c7.js"><link rel="prefetch" href="/assets/js/358.299282e3.js"><link rel="prefetch" href="/assets/js/359.c9bed611.js"><link rel="prefetch" href="/assets/js/36.1013dc0b.js"><link rel="prefetch" href="/assets/js/360.ccfb13a8.js"><link rel="prefetch" href="/assets/js/361.05ec179c.js"><link rel="prefetch" href="/assets/js/362.427072fc.js"><link rel="prefetch" href="/assets/js/363.0ee122f9.js"><link rel="prefetch" href="/assets/js/364.0017ecc8.js"><link rel="prefetch" href="/assets/js/365.1230ac7c.js"><link rel="prefetch" href="/assets/js/366.f6914c2e.js"><link rel="prefetch" href="/assets/js/367.9fe0341d.js"><link rel="prefetch" href="/assets/js/368.a21bf199.js"><link rel="prefetch" href="/assets/js/369.39fe53ec.js"><link rel="prefetch" href="/assets/js/37.9a45ef0a.js"><link rel="prefetch" href="/assets/js/370.e701eeda.js"><link rel="prefetch" href="/assets/js/371.b90c9d30.js"><link rel="prefetch" href="/assets/js/372.a97bf0b2.js"><link rel="prefetch" href="/assets/js/373.4a798498.js"><link rel="prefetch" href="/assets/js/374.85ab3af8.js"><link rel="prefetch" href="/assets/js/375.43495a72.js"><link rel="prefetch" href="/assets/js/376.6b3cc970.js"><link rel="prefetch" href="/assets/js/377.03779254.js"><link rel="prefetch" href="/assets/js/378.34d40bb8.js"><link rel="prefetch" href="/assets/js/379.ca3a6942.js"><link rel="prefetch" href="/assets/js/38.d845e6b5.js"><link rel="prefetch" href="/assets/js/380.339b99c0.js"><link rel="prefetch" href="/assets/js/381.854ec26a.js"><link rel="prefetch" href="/assets/js/382.479978e6.js"><link rel="prefetch" href="/assets/js/383.01dc63bc.js"><link rel="prefetch" href="/assets/js/384.cb97ac09.js"><link rel="prefetch" href="/assets/js/385.f36cf5f6.js"><link rel="prefetch" href="/assets/js/386.7de0ab17.js"><link rel="prefetch" href="/assets/js/387.39f59b7c.js"><link rel="prefetch" href="/assets/js/388.95497a30.js"><link rel="prefetch" href="/assets/js/389.b448ed5e.js"><link rel="prefetch" href="/assets/js/39.77876eda.js"><link rel="prefetch" href="/assets/js/390.a66c4fc4.js"><link rel="prefetch" href="/assets/js/391.48062b7a.js"><link rel="prefetch" href="/assets/js/392.6e57278e.js"><link rel="prefetch" href="/assets/js/393.234e1194.js"><link rel="prefetch" href="/assets/js/394.b7d318c1.js"><link rel="prefetch" href="/assets/js/395.c164d904.js"><link rel="prefetch" href="/assets/js/396.1fc871e1.js"><link rel="prefetch" href="/assets/js/397.97aba7d4.js"><link rel="prefetch" href="/assets/js/398.f220283d.js"><link rel="prefetch" href="/assets/js/399.c59ca5b2.js"><link rel="prefetch" href="/assets/js/4.f1d08658.js"><link rel="prefetch" href="/assets/js/40.fb9333c4.js"><link rel="prefetch" href="/assets/js/400.da8d06aa.js"><link rel="prefetch" href="/assets/js/401.0d789e46.js"><link rel="prefetch" href="/assets/js/402.4de6e357.js"><link rel="prefetch" href="/assets/js/403.790f264a.js"><link rel="prefetch" href="/assets/js/404.82e81932.js"><link rel="prefetch" href="/assets/js/405.441ea069.js"><link rel="prefetch" href="/assets/js/406.bfadbb65.js"><link rel="prefetch" href="/assets/js/407.38f3a5ec.js"><link rel="prefetch" href="/assets/js/408.ecbffdd6.js"><link rel="prefetch" href="/assets/js/409.cd8ec16c.js"><link rel="prefetch" href="/assets/js/41.206dc183.js"><link rel="prefetch" href="/assets/js/410.3eae7a5b.js"><link rel="prefetch" href="/assets/js/411.4f3a7f1b.js"><link rel="prefetch" href="/assets/js/412.69bf0344.js"><link rel="prefetch" href="/assets/js/413.8c53eacf.js"><link rel="prefetch" href="/assets/js/414.d61f85f6.js"><link rel="prefetch" href="/assets/js/415.89165bcc.js"><link rel="prefetch" href="/assets/js/416.4e791dfd.js"><link rel="prefetch" href="/assets/js/417.45f0c4b2.js"><link rel="prefetch" href="/assets/js/418.48807d9c.js"><link rel="prefetch" href="/assets/js/419.4152ed23.js"><link rel="prefetch" href="/assets/js/42.15a1375e.js"><link rel="prefetch" href="/assets/js/420.96e4dc4d.js"><link rel="prefetch" href="/assets/js/421.f2aa7333.js"><link rel="prefetch" href="/assets/js/422.eb34edb8.js"><link rel="prefetch" href="/assets/js/423.c775b42f.js"><link rel="prefetch" href="/assets/js/424.585c7a0f.js"><link rel="prefetch" href="/assets/js/425.01403622.js"><link rel="prefetch" href="/assets/js/426.7755d4a2.js"><link rel="prefetch" href="/assets/js/427.9f553119.js"><link rel="prefetch" href="/assets/js/428.c8dd4f0c.js"><link rel="prefetch" href="/assets/js/429.3ed285c0.js"><link rel="prefetch" href="/assets/js/43.a03afca7.js"><link rel="prefetch" href="/assets/js/430.467c7eaa.js"><link rel="prefetch" href="/assets/js/431.3cbbe034.js"><link rel="prefetch" href="/assets/js/432.9c40e1ea.js"><link rel="prefetch" href="/assets/js/433.9add6475.js"><link rel="prefetch" href="/assets/js/434.b6cff804.js"><link rel="prefetch" href="/assets/js/435.b1fd54d5.js"><link rel="prefetch" href="/assets/js/436.dcb99738.js"><link rel="prefetch" href="/assets/js/437.9562e869.js"><link rel="prefetch" href="/assets/js/438.1b87f7a1.js"><link rel="prefetch" href="/assets/js/439.51a7f392.js"><link rel="prefetch" href="/assets/js/44.08819acf.js"><link rel="prefetch" href="/assets/js/440.ba244e0b.js"><link rel="prefetch" href="/assets/js/441.6247c292.js"><link rel="prefetch" href="/assets/js/442.317331fe.js"><link rel="prefetch" href="/assets/js/443.66412722.js"><link rel="prefetch" href="/assets/js/444.f12bd7bb.js"><link rel="prefetch" href="/assets/js/445.8dd4cba1.js"><link rel="prefetch" href="/assets/js/446.dc2f7fe1.js"><link rel="prefetch" href="/assets/js/447.4024dc6d.js"><link rel="prefetch" href="/assets/js/448.9f473a57.js"><link rel="prefetch" href="/assets/js/449.2fde71a1.js"><link rel="prefetch" href="/assets/js/45.dbfa99cc.js"><link rel="prefetch" href="/assets/js/450.caa7dbd8.js"><link rel="prefetch" href="/assets/js/451.0509ac4e.js"><link rel="prefetch" href="/assets/js/452.f4535c29.js"><link rel="prefetch" href="/assets/js/453.8feab1b9.js"><link rel="prefetch" href="/assets/js/454.b85825f2.js"><link rel="prefetch" href="/assets/js/455.8398d19c.js"><link rel="prefetch" href="/assets/js/456.b50f3dd0.js"><link rel="prefetch" href="/assets/js/457.ada86b83.js"><link rel="prefetch" href="/assets/js/458.7f24755f.js"><link rel="prefetch" href="/assets/js/459.a5e5c3eb.js"><link rel="prefetch" href="/assets/js/46.8cad9b71.js"><link rel="prefetch" href="/assets/js/460.b42f4a81.js"><link rel="prefetch" href="/assets/js/461.67f0b35b.js"><link rel="prefetch" href="/assets/js/462.1ab358db.js"><link rel="prefetch" href="/assets/js/463.0ac7350c.js"><link rel="prefetch" href="/assets/js/464.45c469a9.js"><link rel="prefetch" href="/assets/js/465.cdd85a89.js"><link rel="prefetch" href="/assets/js/466.81d406f8.js"><link rel="prefetch" href="/assets/js/467.d566f183.js"><link rel="prefetch" href="/assets/js/468.50345fae.js"><link rel="prefetch" href="/assets/js/469.1c7dbd36.js"><link rel="prefetch" href="/assets/js/47.b613df2f.js"><link rel="prefetch" href="/assets/js/470.5cfc2898.js"><link rel="prefetch" href="/assets/js/48.7dd353ac.js"><link rel="prefetch" href="/assets/js/49.c6acb8a5.js"><link rel="prefetch" href="/assets/js/50.f98e787a.js"><link rel="prefetch" href="/assets/js/51.fca7ece9.js"><link rel="prefetch" href="/assets/js/52.dfd2418a.js"><link rel="prefetch" href="/assets/js/53.0547a2da.js"><link rel="prefetch" href="/assets/js/54.77c456cb.js"><link rel="prefetch" href="/assets/js/55.2ea7947c.js"><link rel="prefetch" href="/assets/js/56.93aa6440.js"><link rel="prefetch" href="/assets/js/57.e1c7aaa6.js"><link rel="prefetch" href="/assets/js/58.5368de52.js"><link rel="prefetch" href="/assets/js/59.fb2e12ff.js"><link rel="prefetch" href="/assets/js/6.fe5e508e.js"><link rel="prefetch" href="/assets/js/60.b8e6a986.js"><link rel="prefetch" href="/assets/js/61.fe69b359.js"><link rel="prefetch" href="/assets/js/62.74e87082.js"><link rel="prefetch" href="/assets/js/63.75ce37b4.js"><link rel="prefetch" href="/assets/js/64.3b4f72ef.js"><link rel="prefetch" href="/assets/js/65.3f53a9a4.js"><link rel="prefetch" href="/assets/js/66.8403887b.js"><link rel="prefetch" href="/assets/js/67.a2a1488d.js"><link rel="prefetch" href="/assets/js/68.f1c01bf8.js"><link rel="prefetch" href="/assets/js/69.ef3591d4.js"><link rel="prefetch" href="/assets/js/7.a65affc1.js"><link rel="prefetch" href="/assets/js/70.df41328b.js"><link rel="prefetch" href="/assets/js/71.d8cd75fb.js"><link rel="prefetch" href="/assets/js/72.e781e7e1.js"><link rel="prefetch" href="/assets/js/73.aaf45776.js"><link rel="prefetch" href="/assets/js/74.2a35588a.js"><link rel="prefetch" href="/assets/js/75.e8adcf85.js"><link rel="prefetch" href="/assets/js/76.16da36dd.js"><link rel="prefetch" href="/assets/js/77.201f553d.js"><link rel="prefetch" href="/assets/js/78.bb374675.js"><link rel="prefetch" href="/assets/js/79.7b92c1ff.js"><link rel="prefetch" href="/assets/js/8.08fdf9a5.js"><link rel="prefetch" href="/assets/js/80.273f2594.js"><link rel="prefetch" href="/assets/js/81.4fbbe071.js"><link rel="prefetch" href="/assets/js/82.4d39e160.js"><link rel="prefetch" href="/assets/js/83.24e0a19d.js"><link rel="prefetch" href="/assets/js/84.0c030198.js"><link rel="prefetch" href="/assets/js/85.00fc1248.js"><link rel="prefetch" href="/assets/js/86.7bd1bf53.js"><link rel="prefetch" href="/assets/js/87.5b28d027.js"><link rel="prefetch" href="/assets/js/88.8c5037f4.js"><link rel="prefetch" href="/assets/js/89.a06dc5bd.js"><link rel="prefetch" href="/assets/js/90.2df5d8ba.js"><link rel="prefetch" href="/assets/js/91.c3326db3.js"><link rel="prefetch" href="/assets/js/92.57931d85.js"><link rel="prefetch" href="/assets/js/93.bcda9957.js"><link rel="prefetch" href="/assets/js/94.43d71792.js"><link rel="prefetch" href="/assets/js/95.65bbe7b0.js"><link rel="prefetch" href="/assets/js/96.4d8b933c.js"><link rel="prefetch" href="/assets/js/97.9ef35d1d.js"><link rel="prefetch" href="/assets/js/98.94a4172c.js"><link rel="prefetch" href="/assets/js/99.9db6ba1a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6aa5acdd.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/index/book.png" alt="Haoyuan's blog" class="logo"> <span class="site-name can-hide">Haoyuan's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/navigation/" class="nav-link">导航站</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/java/" class="link-title">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/se/" class="nav-link">Java基础</a></li><li class="dropdown-subitem"><a href="/java/collection/" class="nav-link">Java集合</a></li><li class="dropdown-subitem"><a href="/java/se/reflect/" class="nav-link">Java反射</a></li><li class="dropdown-subitem"><a href="/java/juc/" class="nav-link">JavaJUC</a></li><li class="dropdown-subitem"><a href="/java/jvm/" class="nav-link">JavaJVM</a></li></ul></li><li class="dropdown-item"><h4>Java容器</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/javaweb/concept/" class="nav-link">JavaWeb</a></li></ul></li><li class="dropdown-item"><h4>Java版本新特性</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/new-features/" class="nav-link">Java新特性</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/database/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>SQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mysql/" class="nav-link">MySQL</a></li><li class="dropdown-subitem"><a href="/oracle/" class="nav-link">Oracle</a></li></ul></li><li class="dropdown-item"><h4>NoSQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/redis/" class="nav-link">Redis</a></li><li class="dropdown-subitem"><a href="/es/" class="nav-link">ElasticSearch</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><a href="/frames/" class="link-title">框架</a> <span class="title" style="display:none;">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mybatis/" class="nav-link">MyBatis</a></li><li class="dropdown-subitem"><a href="/mybatis-plus/" class="nav-link">MyBatis-Plus</a></li></ul></li><li class="dropdown-item"><h4>消息中间件</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/activemq/" class="nav-link">ActiveMQ</a></li><li class="dropdown-subitem"><a href="/rabbitmq/" class="nav-link">RabbitMQ</a></li><li class="dropdown-subitem"><a href="/rocketmq/" class="nav-link">RocketMQ</a></li><li class="dropdown-subitem"><a href="/kafka/" class="nav-link">Kafka</a></li></ul></li><li class="dropdown-item"><h4>进阶服务</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/nginx/" class="nav-link">Nginx</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring生态" class="dropdown-title"><a href="/spring-ecology/" class="link-title">Spring生态</a> <span class="title" style="display:none;">Spring生态</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/spring/" class="nav-link">Spring</a></li><li class="dropdown-item"><!----> <a href="/spring-boot/" class="nav-link">Spring Boot</a></li><li class="dropdown-item"><!----> <a href="/spring-security/" class="nav-link">Spring Security</a></li><li class="dropdown-item"><!----> <a href="/spring-cloud/" class="nav-link">Spring Cloud</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发" class="dropdown-title"><a href="/dev-guide/" class="link-title">开发</a> <span class="title" style="display:none;">开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/design-pattern/" class="nav-link">设计模式</a></li><li class="dropdown-item"><!----> <a href="/algorithm/" class="nav-link">算法</a></li><li class="dropdown-item"><!----> <a href="/knowledge/" class="nav-link">知识</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><a href="/tool/" class="link-title">工具</a> <span class="title" style="display:none;">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>管理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/maven/" class="nav-link">Maven</a></li><li class="dropdown-subitem"><a href="/git/" class="nav-link">Git</a></li></ul></li><li class="dropdown-item"><h4>部署</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/linux/" class="nav-link">Linux</a></li><li class="dropdown-subitem"><a href="/docker/" class="nav-link">Docker</a></li><li class="dropdown-subitem"><a href="/jenkins/" class="nav-link">Jenkins</a></li><li class="dropdown-subitem"><a href="/kubernetes/" class="nav-link">Kubernetes</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/front/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>进阶</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/typescript/" class="nav-link">TypeScript</a></li></ul></li><li class="dropdown-item"><h4>框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/react/" class="nav-link">React</a></li><li class="dropdown-subitem"><a href="/vue2/" class="nav-link">Vue2</a></li><li class="dropdown-subitem"><a href="/vue3/" class="nav-link">Vue3</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/whells-use/" class="nav-link">轮子工具</a></li><li class="dropdown-item"><!----> <a href="/projects/" class="nav-link">项目工程</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>本站</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-subitem"><a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-subitem"><a href="/archives/" class="nav-link">归档</a></li></ul></li><li class="dropdown-item"><h4>我的</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/whell/web/" class="nav-link">收藏</a></li><li class="dropdown-subitem"><a href="/about/mdskill/" class="nav-link">关于</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/message-area/" class="nav-link">留言区</a></div> <a href="https://github.com/Somnus711/Somnus711.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.jsdelivr.net/gh/Somnus711/picx-image-hosting@master/blog-pic/avatar.2b7e13idyy9s.webp"> <div class="blogger-info"><h3>Somnus Haoyuan</h3> <span>Word is cheap, show me the code.</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/navigation/" class="nav-link">导航站</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/java/" class="link-title">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/se/" class="nav-link">Java基础</a></li><li class="dropdown-subitem"><a href="/java/collection/" class="nav-link">Java集合</a></li><li class="dropdown-subitem"><a href="/java/se/reflect/" class="nav-link">Java反射</a></li><li class="dropdown-subitem"><a href="/java/juc/" class="nav-link">JavaJUC</a></li><li class="dropdown-subitem"><a href="/java/jvm/" class="nav-link">JavaJVM</a></li></ul></li><li class="dropdown-item"><h4>Java容器</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/javaweb/concept/" class="nav-link">JavaWeb</a></li></ul></li><li class="dropdown-item"><h4>Java版本新特性</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/new-features/" class="nav-link">Java新特性</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/database/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>SQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mysql/" class="nav-link">MySQL</a></li><li class="dropdown-subitem"><a href="/oracle/" class="nav-link">Oracle</a></li></ul></li><li class="dropdown-item"><h4>NoSQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/redis/" class="nav-link">Redis</a></li><li class="dropdown-subitem"><a href="/es/" class="nav-link">ElasticSearch</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><a href="/frames/" class="link-title">框架</a> <span class="title" style="display:none;">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mybatis/" class="nav-link">MyBatis</a></li><li class="dropdown-subitem"><a href="/mybatis-plus/" class="nav-link">MyBatis-Plus</a></li></ul></li><li class="dropdown-item"><h4>消息中间件</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/activemq/" class="nav-link">ActiveMQ</a></li><li class="dropdown-subitem"><a href="/rabbitmq/" class="nav-link">RabbitMQ</a></li><li class="dropdown-subitem"><a href="/rocketmq/" class="nav-link">RocketMQ</a></li><li class="dropdown-subitem"><a href="/kafka/" class="nav-link">Kafka</a></li></ul></li><li class="dropdown-item"><h4>进阶服务</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/nginx/" class="nav-link">Nginx</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring生态" class="dropdown-title"><a href="/spring-ecology/" class="link-title">Spring生态</a> <span class="title" style="display:none;">Spring生态</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/spring/" class="nav-link">Spring</a></li><li class="dropdown-item"><!----> <a href="/spring-boot/" class="nav-link">Spring Boot</a></li><li class="dropdown-item"><!----> <a href="/spring-security/" class="nav-link">Spring Security</a></li><li class="dropdown-item"><!----> <a href="/spring-cloud/" class="nav-link">Spring Cloud</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发" class="dropdown-title"><a href="/dev-guide/" class="link-title">开发</a> <span class="title" style="display:none;">开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/design-pattern/" class="nav-link">设计模式</a></li><li class="dropdown-item"><!----> <a href="/algorithm/" class="nav-link">算法</a></li><li class="dropdown-item"><!----> <a href="/knowledge/" class="nav-link">知识</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><a href="/tool/" class="link-title">工具</a> <span class="title" style="display:none;">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>管理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/maven/" class="nav-link">Maven</a></li><li class="dropdown-subitem"><a href="/git/" class="nav-link">Git</a></li></ul></li><li class="dropdown-item"><h4>部署</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/linux/" class="nav-link">Linux</a></li><li class="dropdown-subitem"><a href="/docker/" class="nav-link">Docker</a></li><li class="dropdown-subitem"><a href="/jenkins/" class="nav-link">Jenkins</a></li><li class="dropdown-subitem"><a href="/kubernetes/" class="nav-link">Kubernetes</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/front/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>进阶</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/typescript/" class="nav-link">TypeScript</a></li></ul></li><li class="dropdown-item"><h4>框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/react/" class="nav-link">React</a></li><li class="dropdown-subitem"><a href="/vue2/" class="nav-link">Vue2</a></li><li class="dropdown-subitem"><a href="/vue3/" class="nav-link">Vue3</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/whells-use/" class="nav-link">轮子工具</a></li><li class="dropdown-item"><!----> <a href="/projects/" class="nav-link">项目工程</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>本站</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-subitem"><a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-subitem"><a href="/archives/" class="nav-link">归档</a></li></ul></li><li class="dropdown-item"><h4>我的</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/whell/web/" class="nav-link">收藏</a></li><li class="dropdown-subitem"><a href="/about/mdskill/" class="nav-link">关于</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/message-area/" class="nav-link">留言区</a></div> <a href="https://github.com/Somnus711/Somnus711.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MyBatis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MyBatis-Plus</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>中间件 - ActiveMQ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>中间件 - RabbitMQ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>中间件 - RocketMQ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>中间件 - Kafka</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>高性能服务器 - Nginx</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>响应式框架 - Reactor</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/reactor/quick-start/" class="sidebar-link">Reactor - 快速上手</a></li><li><a href="/reactor/reactive-programming/" class="sidebar-link">Reactor - 响应式编程</a></li><li><a href="/reactor/core-features/" aria-current="page" class="active sidebar-link">Reactor - 核心特征</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/reactor/core-features/#reactor-核心特性" class="sidebar-link">Reactor 核心特性</a></li><li class="sidebar-sub-header level2"><a href="/reactor/core-features/#flux-包含-0-n-个元素的异步序列" class="sidebar-link">Flux 包含 0-N 个元素的异步序列</a></li><li class="sidebar-sub-header level2"><a href="/reactor/core-features/#mono-异步的-0-1-结果" class="sidebar-link">Mono 异步的 0-1 结果</a></li><li class="sidebar-sub-header level2"><a href="/reactor/core-features/#简单的创建和订阅-flux-或-mono-的方法" class="sidebar-link">简单的创建和订阅 Flux 或 Mono 的方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/reactor/core-features/#subscribe-方法示例" class="sidebar-link">subscribe 方法示例</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/reactor/core-features/#可编程式地创建一个序列" class="sidebar-link">可编程式地创建一个序列</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/reactor/core-features/#generate" class="sidebar-link">Generate</a></li><li class="sidebar-sub-header level3"><a href="/reactor/core-features/#create" class="sidebar-link">Create</a></li><li class="sidebar-sub-header level4"><a href="/reactor/core-features/#推送-push-模式" class="sidebar-link">推送（push）模式</a></li><li class="sidebar-sub-header level4"><a href="/reactor/core-features/#推送-拉取-push-pull-混合模式" class="sidebar-link">推送/拉取（push/pull）混合模式</a></li><li class="sidebar-sub-header level4"><a href="/reactor/core-features/#清理-cleaning-up" class="sidebar-link">清理（Cleaning up）</a></li><li class="sidebar-sub-header level3"><a href="/reactor/core-features/#handle" class="sidebar-link">Handle</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/reactor/core-features/#调度器-schedulers" class="sidebar-link">调度器（Schedulers）</a></li><li class="sidebar-sub-header level2"><a href="/reactor/core-features/#线程模型" class="sidebar-link">线程模型</a></li><li class="sidebar-sub-header level2"><a href="/reactor/core-features/#处理错误" class="sidebar-link">处理错误</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/reactor/core-features/#错误处理方法" class="sidebar-link">错误处理方法</a></li><li class="sidebar-sub-header level4"><a href="/reactor/core-features/#动态候补值" class="sidebar-link">动态候补值</a></li><li class="sidebar-sub-header level4"><a href="/reactor/core-features/#捕获并重新抛出" class="sidebar-link">捕获并重新抛出</a></li><li class="sidebar-sub-header level4"><a href="/reactor/core-features/#记录错误日志" class="sidebar-link">记录错误日志</a></li><li class="sidebar-sub-header level4"><a href="/reactor/core-features/#使用资源和-try-catch-代码块" class="sidebar-link">使用资源和 try-catch 代码块</a></li><li class="sidebar-sub-header level4"><a href="/reactor/core-features/#演示终止方法-onerror" class="sidebar-link">演示终止方法 onError</a></li><li class="sidebar-sub-header level4"><a href="/reactor/core-features/#重试" class="sidebar-link">重试</a></li><li class="sidebar-sub-header level3"><a href="/reactor/core-features/#在操作符或函数式中处理异常" class="sidebar-link">在操作符或函数式中处理异常</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/reactor/core-features/#processors" class="sidebar-link">Processors</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/reactor/core-features/#我是否需要使用-processor" class="sidebar-link">我是否需要使用 Processor</a></li><li class="sidebar-sub-header level3"><a href="/reactor/core-features/#使用-sink-门面对象来线程安全地生成流" class="sidebar-link">使用 Sink 门面对象来线程安全地生成流</a></li><li class="sidebar-sub-header level3"><a href="/reactor/core-features/#现有的-processors-总览" class="sidebar-link">现有的 Processors 总览</a></li><li class="sidebar-sub-header level4"><a href="/reactor/core-features/#directprocessor" class="sidebar-link">DirectProcessor</a></li><li class="sidebar-sub-header level4"><a href="/reactor/core-features/#unicastprocessor" class="sidebar-link">UnicastProcessor</a></li><li class="sidebar-sub-header level4"><a href="/reactor/core-features/#emitterprocessor" class="sidebar-link">EmitterProcessor</a></li><li class="sidebar-sub-header level4"><a href="/reactor/core-features/#replayprocessor" class="sidebar-link">ReplayProcessor</a></li><li class="sidebar-sub-header level4"><a href="/reactor/core-features/#topicprocessor" class="sidebar-link">TopicProcessor</a></li><li class="sidebar-sub-header level4"><a href="/reactor/core-features/#workqueueprocessor" class="sidebar-link">WorkQueueProcessor</a></li></ul></li></ul></li><li><a href="/reactor/kotlin-support/" class="sidebar-link">Reactor - 对 Kotlin 的支持</a></li><li><a href="/reactor/unit-test/" class="sidebar-link">Reactor - 单元测试</a></li><li><a href="/reactor/debug/" class="sidebar-link">Reactor - 调试 Reactor</a></li><li><a href="/reactor/advanced-features-and-concepts/" class="sidebar-link">Reactor - 高级特性与概念</a></li><li><a href="/reactor/operators-summary/" class="sidebar-link">Reactor - 操作符总结</a></li><li><a href="/reactor/best-practices/" class="sidebar-link">Reactor - 最佳实践</a></li><li><a href="/reactor/extensibility/" class="sidebar-link">Reactor - 扩展性</a></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=%E6%A1%86%E6%9E%B6" title="分类" data-v-06225672>框架</a></li><li data-v-06225672><a href="/categories/?category=%E5%93%8D%E5%BA%94%E5%BC%8F%E6%A1%86%E6%9E%B6%20-%20Reactor" title="分类" data-v-06225672>响应式框架 - Reactor</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://www.denghaoyuan.com/" target="_blank" title="作者" class="beLink" data-v-06225672>Haoyuan</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-11-02</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">Reactor - 核心特征<!----></h1> <!----> <div class="theme-vdoing-content content__default"><p></p><div class="table-of-contents"><ul><li><a href="#reactor-核心特性">Reactor 核心特性</a></li><li><a href="#flux-包含-0-n-个元素的异步序列">Flux 包含 0-N 个元素的异步序列</a></li><li><a href="#mono-异步的-0-1-结果">Mono 异步的 0-1 结果</a></li><li><a href="#简单的创建和订阅-flux-或-mono-的方法">简单的创建和订阅 Flux 或 Mono 的方法</a><ul><li><a href="#subscribe-方法示例">subscribe 方法示例</a></li></ul></li><li><a href="#可编程式地创建一个序列">可编程式地创建一个序列</a><ul><li><a href="#generate">Generate</a></li><li><a href="#create">Create</a></li><li><a href="#handle">Handle</a></li></ul></li><li><a href="#调度器-schedulers">调度器（Schedulers）</a></li><li><a href="#线程模型">线程模型</a></li><li><a href="#处理错误">处理错误</a><ul><li><a href="#错误处理方法">错误处理方法</a></li><li><a href="#在操作符或函数式中处理异常">在操作符或函数式中处理异常</a></li></ul></li><li><a href="#processors">Processors</a><ul><li><a href="#我是否需要使用-processor">我是否需要使用 Processor</a></li><li><a href="#使用-sink-门面对象来线程安全地生成流">使用 Sink 门面对象来线程安全地生成流</a></li><li><a href="#现有的-processors-总览">现有的 Processors 总览</a></li></ul></li></ul></div><p></p> <h2 id="reactor-核心特性"><a href="#reactor-核心特性" class="header-anchor">#</a> Reactor 核心特性</h2> <p>Reactor 项目的主要 artifact 是 <code>reactor-core</code>，这是一个基于 Java 8 的实现了响应式流规范 （Reactive Streams specification）的响应式库。</p> <p>Reactor 引入了实现 <code>Publisher</code> 的响应式类 <code>Flux</code> 和 <code>Mono</code>，以及丰富的操作方式。 一个 <code>Flux</code> 对象代表一个包含 0..N 个元素的响应式序列，而一个 <code>Mono</code> 对象代表一个包含 零/一个（0..1）元素的结果。</p> <p>这种区别为这俩类型带来了语义上的信息——表明了异步处理逻辑所面对的元素基数。比如， 一个 HTTP 请求产生一个响应，所以对其进行 <code>count</code> 操作是没有多大意义的。表示这样一个 结果的话，应该用 <code>Mono&lt;HttpResponse&gt;</code> 而不是 <code>Flux&lt;HttpResponse&gt;</code>，因为要置于其上的 操作通常只用于处理 0/1 个元素。</p> <p>有些操作可以改变基数，从而需要切换类型。比如，<code>count</code> 操作用于 <code>Flux</code>，但是操作 返回的结果是 <code>Mono&lt;Long&gt;</code>。</p> <h2 id="flux-包含-0-n-个元素的异步序列"><a href="#flux-包含-0-n-个元素的异步序列" class="header-anchor">#</a> Flux 包含 0-N 个元素的异步序列</h2> <p><img src="https://cdn.jsdelivr.net/gh/Kele-Bingtang/static/img/MapStructPlus/20241102010254.png" alt="image-20241102010252633"></p> <p><code>Flux&lt;T&gt;</code> 是一个能够发出 0 到 N 个元素的标准的 <code>Publisher&lt;T&gt;</code>，它会被一个「错误（error）」 或「完成（completion）」信号终止。因此，一个 flux 的可能结果是一个 value、completion 或 error。 就像在响应式流规范中规定的那样，这三种类型的信号被翻译为面向下游的 <code>onNext</code>，<code>onComplete</code>和<code>onError</code>方法。</p> <p>由于多种不同的信号可能性，<code>Flux</code> 可以作为一种通用的响应式类型。注意，所有的信号事件， 包括代表终止的信号事件都是可选的：如果没有 <code>onNext</code> 事件但是有一个 <code>onComplete</code> 事件， 那么发出的就是 <em>空的</em> 有限序列，但是去掉 <code>onComplete</code> 那么得到的就是一个 <em>无限的</em> 空序列。 当然，无限序列也可以不是空序列，比如，<code>Flux.interval(Duration)</code> 生成的是一个 <code>Flux&lt;Long&gt;</code>， 这就是一个无限地周期性发出规律 tick 的时钟序列。</p> <h2 id="mono-异步的-0-1-结果"><a href="#mono-异步的-0-1-结果" class="header-anchor">#</a> Mono 异步的 0-1 结果</h2> <p><img src="https://cdn.jsdelivr.net/gh/Kele-Bingtang/static/img/MapStructPlus/20241102010321.png" alt="image-20241102010320385"></p> <p><code>Mono&lt;T&gt;</code> 是一种特殊的 <code>Publisher&lt;T&gt;</code>， 它最多发出一个元素，然后终止于一个 <code>onComplete</code> 信号或一个 <code>onError</code> 信号。</p> <p>它只适用其中一部分可用于 <code>Flux</code> 的操作。比如，（两个 <code>Mono</code> 的）结合类操作可以忽略其中之一 而发出另一个 <code>Mono</code>，也可以将两个都发出，对于后一种情况会切换为一个 <code>Flux</code>。</p> <p>例如，<code>Mono#concatWith(Publisher)</code> 返回一个 <code>Flux</code>，而 <code>Mono#then(Mono)</code> 返回另一个 <code>Mono</code>。</p> <p>注意，<code>Mono</code> 可以用于表示「空」的只有完成概念的异步处理（比如 <code>Runnable</code>）。这种用 <code>Mono&lt;Void&gt;</code> 来创建。</p> <h2 id="简单的创建和订阅-flux-或-mono-的方法"><a href="#简单的创建和订阅-flux-或-mono-的方法" class="header-anchor">#</a> 简单的创建和订阅 Flux 或 Mono 的方法</h2> <p>最简单的上手 <code>Flux</code> 和 <code>Mono</code> 的方式就是使用相应类提供的多种工厂方法之一。</p> <p>比如，如果要创建一个 <code>String</code> 的序列，你可以直接列举它们，或者将它们放到一个集合里然后用来创建 Flux，如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> seq1 <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;foobar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> iterable <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;foobar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> seq2 <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">fromIterable</span><span class="token punctuation">(</span>iterable<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>工厂方法的其他例子如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> noData <span class="token operator">=</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>

<span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> numbersFromFiveToSeven <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol><li>注意，即使没有值，工厂方法仍然采用通用的返回类型</li> <li>第一个参数是 range 的开始，第二个参数是要生成的元素个数</li></ol> <p>在订阅（subscribe）的时候，<code>Flux</code> 和 <code>Mono</code> 使用 Java 8 lambda 表达式。 <code>.subscribe()</code> 方法有多种不同的方法签名，你可以传入各种不同的 lambda 形式的参数来定义回调。如下所示：</p> <blockquote><p>基于 lambda 的对 <code>Flux</code> 的订阅（subscribe）</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>

<span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>

<span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> consumer<span class="token punctuation">,</span>
          <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">Throwable</span><span class="token punctuation">&gt;</span></span> errorConsumer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>

<span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> consumer<span class="token punctuation">,</span>
          <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">Throwable</span><span class="token punctuation">&gt;</span></span> errorConsumer<span class="token punctuation">,</span>
          <span class="token class-name">Runnable</span> completeConsumer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4</span>

<span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> consumer<span class="token punctuation">,</span>
          <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">Throwable</span><span class="token punctuation">&gt;</span></span> errorConsumer<span class="token punctuation">,</span>
          <span class="token class-name">Runnable</span> completeConsumer<span class="token punctuation">,</span>
          <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">Subscription</span><span class="token punctuation">&gt;</span></span> subscriptionConsumer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><ol><li>订阅并触发序列</li> <li>对每一个生成的元素进行消费</li> <li>对正常元素进行消费，也对错误进行响应</li> <li>对正常元素和错误均有响应，还定义了序列正常完成后的回调</li> <li>对正常元素、错误和完成信号均有响应，同时也定义了对该 <code>subscribe</code> 方法返回的 <code>Subscription</code> 执行的回调。</li></ol> <p>以上方法会返回一个 <code>Subscription</code> 的引用，如果不再需要更多元素你可以通过它来取消订阅。 取消订阅时，源头会停止生成新的数据，并清理相关资源。取消和清理的操作在 Reactor 中是在 接口 <code>Disposable</code> 中定义的。</p> <h3 id="subscribe-方法示例"><a href="#subscribe-方法示例" class="header-anchor">#</a> subscribe 方法示例</h3> <p>下面对 <code>subscribe</code> 的 5 个不同签名的方法的示例，如下是一个无参的基本方法的使用：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> ints <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
ints<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol><li>配置一个在订阅时会产生3个值的 <code>Flux</code></li> <li>最简单的订阅方式</li></ol> <p>第二行代码没有任何输出，但是它确实执行了。<code>Flux</code> 产生了 3 个值。如果我们传入一个 lambda，我们就可以看到这几个值，如下一个列子：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> ints <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
ints<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol><li>配置一个在订阅时会产生3个值的 <code>Flux</code></li> <li>订阅它并打印值</li></ol> <p>第二行代码会输入如下内容：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">1</span>
<span class="token number">2</span>
<span class="token number">3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>为了演示下一个方法签名，我们故意引入一个错误，如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> ints <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">// 1</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 2</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">return</span> i<span class="token punctuation">;</span> <span class="token comment">// 3</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Got to 4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ints<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 5</span>
      error <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Error: &quot;</span> <span class="token operator">+</span> error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol><li>配置一个在订阅时会产生4个值的 <code>Flux</code></li> <li>为了对元素进行处理，我们需要一个 map 操作</li> <li>对于多数元素，返回值本身</li> <li>对其中一个元素抛出错误</li> <li>订阅的时候定义如何进行错误处理</li></ol> <p>现在我们有两个 lambda 表达式：一个是用来处理正常数据，一个用来处理错误。 刚才的代码输出如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">1</span>
<span class="token number">2</span>
<span class="token number">3</span>
<span class="token class-name">Error</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>RuntimeException</span><span class="token operator">:</span> <span class="token class-name">Got</span> <span class="token keyword">to</span> <span class="token number">4</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>下一个 <code>subscribe</code> 方法的签名既有错误处理，还有一个完成后的处理，如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> ints <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
ints<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span>
    error <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Error &quot;</span> <span class="token operator">+</span> error<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Done&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol><li>配置一个在订阅时会产生4个值的 <code>Flux</code></li> <li>订阅时定义错误和完成信号的处理</li></ol> <p>错误和完成信号都是终止信号，并且二者只会出现其中之一。为了能够最终全部正常完成，你必须处理错误信号。</p> <p>用于处理完成信号的 lambda 是一对空的括号，因为它实际上匹配的是 <code>Runnalbe</code> 接口中的 <code>run</code> 方法， 不接受参数。刚才的代码输出如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">1</span>
<span class="token number">2</span>
<span class="token number">3</span>
<span class="token number">4</span>
<span class="token class-name">Done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>最后一个 <code>subscribe</code> 方法签名包含一个自定义的 <code>subscriber</code>（下一节会介绍到）：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">SampleSubscriber</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> ss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SampleSubscriber</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> ints <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ints<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span>
    error <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Error &quot;</span> <span class="token operator">+</span> error<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Done&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    s <span class="token operator">-&gt;</span> ss<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ints<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>上面这个例子中，我们把一个自定义的 <code>Subscriber</code> 作为 <code>subscribe</code> 方法的最后一个参数。 下边的例子是这个自定义的 <code>Subscriber</code>，这是一个对 <code>Subscriber</code> 的最简单实现：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">io<span class="token punctuation">.</span>projectreactor<span class="token punctuation">.</span>samples</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>reactivestreams<span class="token punctuation">.</span></span><span class="token class-name">Subscription</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span><span class="token class-name">BaseSubscriber</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SampleSubscriber</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">BaseSubscriber</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">hookOnSubscribe</span><span class="token punctuation">(</span><span class="token class-name">Subscription</span> subscription<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Subscribed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">request</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">hookOnNext</span><span class="token punctuation">(</span><span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">request</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><code>SampleSubscriber</code> 类继承自 <code>BaseSubscriber</code>，在 Reactor 中, 推荐用户扩展它来实现自定义的 <code>Subscriber</code>。这个类提供了一些 hook 方法，我们可以通过重写它们来调整 subscriber 的行为。 默认情况下，它会触发一个无限个数的请求，但是当你想自定义请求元素的个数的时候，扩展 <code>BaseSubscriber</code> 就很方便了。</p> <p>扩展的时候通常至少要覆盖 <code>hookOnSubscribe(Subscription subscription)</code> 和 <code>hookOnNext(T value)</code> 这两个方法。这个例子中， <code>hookOnSubscribe</code> 方法打印一段话到标准输出，然后进行第一次请求。 然后 <code>hookOnNext</code> 同样进行了打印，同时逐个处理剩余请求。</p> <p><code>SampleSubscriber</code> 输出如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Subscribed</span>
<span class="token number">1</span>
<span class="token number">2</span>
<span class="token number">3</span>
<span class="token number">4</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><blockquote><p>建议你同时重写 <code>hookOnError</code>、<code>hookOnCancel</code>，以及 <code>hookOnComplete</code> 方法。 你最好也重写 <code>hookFinally</code> 方法。<code>SampleSubscribe</code> 确实是一个最简单的实现了 请求有限个数元素的 <code>Subscriber</code>。</p></blockquote> <blockquote><p>后边还会再讨论 <code>BaseSubscriber</code>。</p></blockquote> <p>响应式流规范定义了另一个 <code>subscribe</code> 方法的签名，它只接收一个自定义的 <code>Subscriber</code>， 没有其他的参数，如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Subscriber</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> subscriber<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果你已经有一个 <code>Subscriber</code>，那么这个方法签名还是挺有用的。况且，你可能还会用到它 来做一些订阅相关（subscription-related）的回调。比如，你想要自定义「背压（backpressure）」 并且自己来触发请求。</p> <p>在这种情况下，使用 <code>BaseSubscriber</code> 抽象类就很方便，因为它提供了很好的配置「背压」 的方法。</p> <p>使用 <code>BaseSubscriber</code> 来配置「背压」</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> source <span class="token operator">=</span> <span class="token function">someStringSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

source<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token operator">::</span><span class="token function">toUpperCase</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BaseSubscriber</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 1</span>
          <span class="token annotation punctuation">@Override</span>
          <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">hookOnSubscribe</span><span class="token punctuation">(</span><span class="token class-name">Subscription</span> subscription<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// 2</span>
              <span class="token function">request</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
          <span class="token punctuation">}</span>

          <span class="token annotation punctuation">@Override</span>
          <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">hookOnNext</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">request</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// 5</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ol><li><code>BaseSubscriber</code> 是一个抽象类，所以我们创建一个匿名内部类</li> <li><code>BaseSubscriber</code> 定义了多种用于处理不同信号的 hook。它还定义了一些捕获 <code>Subscription</code> 对象的现成方法，这些方法可以用在 hook 中</li> <li><code>request(n)</code> 就是这样一个方法。它能够在任何 hook 中，通过 subscription 向上游传递 背压请求。这里我们在开始这个流的时候请求1个元素值</li> <li>随着接收到新的值，我们继续以每次请求一个元素的节奏从源头请求值</li> <li>其他 hooks 有 <code>hookOnComplete</code>, <code>hookOnError</code>, <code>hookOnCancel</code>, and <code>hookFinally</code> （它会在流终止的时候被调用，传入一个 <code>SignalType</code> 作为参数）</li></ol> <blockquote><p>当你修改请求操作的时候，你必须注意让 subscriber 向上提出足够的需求， 否则上游的 Flux 可能会被「卡住」。所以 <code>BaseSubscriber</code> 在进行扩展的时候要覆盖 <code>hookOnSubscribe</code> 和 <code>onNext</code>，这样你至少会调用 <code>request</code> 一次。</p></blockquote> <p><code>BaseSubscriber</code> 还提供了 <code>requestUnbounded()</code> 方法来切换到「无限」模式（等同于 <code>request(Long.MAX_VALUE)</code>）。</p> <h2 id="可编程式地创建一个序列"><a href="#可编程式地创建一个序列" class="header-anchor">#</a> 可编程式地创建一个序列</h2> <p>在这一小节，我们介绍如何通过定义相对应的事件（<code>onNext</code>、<code>onError</code>和<code>onComplete</code>） 创建一个 <code>Flux</code> 或 <code>Mono</code>。所有这些方法都通过 API 来触发我们叫做 <strong>sink（池）</strong> 的事件。 sink 的类型不多，我们快速过一下。</p> <h3 id="generate"><a href="#generate" class="header-anchor">#</a> Generate</h3> <p>最简单的创建 <code>Flux</code> 的方式就是使用 <code>generate</code> 方法。</p> <p>这是一种 <strong>同步地</strong>， <strong>逐个地</strong> 产生值的方法，意味着 sink 是一个 <code>SynchronousSink</code> 而且其 <code>next()</code> 方法在每次回调的时候最多只能被调用一次。你也可以调用 <code>error(Throwable)</code> 或者 <code>complete()</code>，不过是可选的。</p> <p>最有用的一种方式就是同时能够记录一个状态值（state），从而在使用 sink 发出下一个元素的时候能够 基于这个状态值去产生元素。此时生成器（generator）方法就是一个 <code>BiFunction&lt;S, SynchronousSink&lt;T&gt;, S&gt;</code>， 其中 <code>&lt;S&gt;</code> 是状态对象的类型。你需要提供一个 <code>Supplier&lt;S&gt;</code> 来初始化状态值，而生成器需要 在每一「回合」生成元素后返回新的状态值（供下一回合使用）。</p> <p>例如我们使用一个 <code>int</code> 作为状态值。</p> <p><strong>基于状态值的 <code>generate</code> 示例</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> flux <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 1</span>
    <span class="token punctuation">(</span>state<span class="token punctuation">,</span> sink<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
      sink<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token string">&quot;3 x &quot;</span> <span class="token operator">+</span> state <span class="token operator">+</span> <span class="token string">&quot; = &quot;</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token operator">*</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span> sink<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
      <span class="token keyword">return</span> state <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 4</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol><li>初始化状态值（state）为 0</li> <li>我们基于状态值 state 来生成下一个值（state 乘以 3）</li> <li>我们也可以用状态值来决定什么时候终止序列</li> <li>返回一个新的状态值 state，用于下一次调用</li></ol> <p>上面的代码生成了「3 x」的乘法表：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">3</span> x <span class="token number">0</span> <span class="token operator">=</span> <span class="token number">0</span>
<span class="token number">3</span> x <span class="token number">1</span> <span class="token operator">=</span> <span class="token number">3</span>
<span class="token number">3</span> x <span class="token number">2</span> <span class="token operator">=</span> <span class="token number">6</span>
<span class="token number">3</span> x <span class="token number">3</span> <span class="token operator">=</span> <span class="token number">9</span>
<span class="token number">3</span> x <span class="token number">4</span> <span class="token operator">=</span> <span class="token number">12</span>
<span class="token number">3</span> x <span class="token number">5</span> <span class="token operator">=</span> <span class="token number">15</span>
<span class="token number">3</span> x <span class="token number">6</span> <span class="token operator">=</span> <span class="token number">18</span>
<span class="token number">3</span> x <span class="token number">7</span> <span class="token operator">=</span> <span class="token number">21</span>
<span class="token number">3</span> x <span class="token number">8</span> <span class="token operator">=</span> <span class="token number">24</span>
<span class="token number">3</span> x <span class="token number">9</span> <span class="token operator">=</span> <span class="token number">27</span>
<span class="token number">3</span> x <span class="token number">10</span> <span class="token operator">=</span> <span class="token number">30</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>我们也可以使用可变（mutable）类型（如上例，原生类型及其包装类，以及 String 等属于不可变类型） 的 <code>&lt;S&gt;</code>。上边的例子也可以用 <code>AtomicLong</code> 作为状态值，在每次生成后改变它的值。</p> <p><strong>可变类型的状态变量</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> flux <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>
    <span class="token class-name">AtomicLong</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">,</span> <span class="token comment">// 1</span>
    <span class="token punctuation">(</span>state<span class="token punctuation">,</span> sink<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">long</span> i <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
      sink<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token string">&quot;3 x &quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot; = &quot;</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token operator">*</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span> sink<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> state<span class="token punctuation">;</span> <span class="token comment">// 3</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol><li>这次我们初始化一个可变类型的状态值</li> <li>改变状态值</li> <li>返回 <strong>同一个</strong> 实例作为新的状态值</li></ol> <p>如果状态对象需要清理资源，可以使用 <code>generate(Supplier&lt;S&gt;, BiFunction, Consumer&lt;S&gt;)</code> 这个签名方法来清理状态对象（Consumer 在序列终止才被调用）。</p> <p>下面是一个在 generate 方法中增加 <code>Consumer</code> 的例子：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> flux <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>
    <span class="token class-name">AtomicLong</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span>state<span class="token punctuation">,</span> sink<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 1</span>
      <span class="token keyword">long</span> i <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
      sink<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token string">&quot;3 x &quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot; = &quot;</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token operator">*</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span> sink<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> state<span class="token punctuation">;</span> <span class="token comment">// 3</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;state: &quot;</span> <span class="token operator">+</span> state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ol><li>同样，初始化一个可变对象作为状态变量</li> <li>改变状态</li> <li>返回 <strong>同一个</strong> 实例作为新的状态</li> <li>我们会看到最后一个状态值（11）会被这个 <code>Consumer</code> lambda 输出</li></ol> <p>如果 state 使用了数据库连接或者其他需要最终进行清理的资源，这个 <code>Consumer</code> lambda 可以用来在最后关闭连接或完成相关的其他清理任务。</p> <h3 id="create"><a href="#create" class="header-anchor">#</a> Create</h3> <p>作为一个更高级的创建 <code>Flux</code> 的方式， <code>create</code> 方法的生成方式既可以是同步， 也可以是异步的，并且还可以每次发出多个元素。</p> <p>该方法用到了 <code>FluxSink</code>，后者同样提供 <code>next</code>，<code>error</code> 和 <code>complete</code> 等方法。 与 <code>generate</code> 不同的是，<code>create</code> 不需要状态值，另一方面，它可以在回调中触发 多个事件（即使是在未来的某个时间）。</p> <blockquote><p><code>create</code> 有个好处就是可以将现有的 API 转为响应式，比如监听器的异步方法。</p></blockquote> <p>假设你有一个监听器 API，它按 chunk 处理数据，有两种事件：（1）一个 chunk 数据准备好的事件；（2）处理结束的事件。如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">interface</span> <span class="token class-name">MyEventListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">onDataChunk</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">processComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>你可以使用 <code>create</code> 方法将其转化为响应式类型 <code>Flux&lt;T&gt;</code>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> bridge <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>sink <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    myEventProcessor<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span> <span class="token comment">// 4</span>
      <span class="token keyword">new</span> <span class="token class-name">MyEventListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 1</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDataChunk</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> chunk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">String</span> s <span class="token operator">:</span> chunk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sink<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sink<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><ol><li>桥接 <code>MyEventListener</code></li> <li>每一个 chunk 的数据转化为 <code>Flux</code> 中的一个元素</li> <li><code>processComplete</code> 事件转换为 <code>onComplete</code></li> <li>所有这些都是在 <code>myEventProcessor</code> 执行时异步执行的</li></ol> <p>此外，既然 <code>create</code> 可以是异步地，并且能够控制背压，你可以通过提供一个 <code>OverflowStrategy</code> 来定义背压行为。</p> <ul><li><code>IGNORE</code>： 完全忽略下游背压请求，这可能会在下游队列积满的时候导致 <code>IllegalStateException</code></li> <li><code>ERROR</code>： 当下游跟不上节奏的时候发出一个 <code>IllegalStateException</code> 的错误信号</li> <li><code>DROP</code>：当下游没有准备好接收新的元素的时候抛弃这个元素</li> <li><code>LATEST</code>：让下游只得到上游最新的元素</li> <li><code>BUFFER</code>：（默认的）缓存所有下游没有来得及处理的元素（这个不限大小的缓存可能导致 <code>OutOfMemoryError</code>）</li></ul> <blockquote><p><code>Mono</code> 也有一个用于 <code>create</code> 的生成器（generator）—— <code>MonoSink</code>，它不能生成多个元素， 因此会抛弃第一个元素之后的所有元素。</p></blockquote> <h4 id="推送-push-模式"><a href="#推送-push-模式" class="header-anchor">#</a> 推送（push）模式</h4> <p><code>create</code> 的一个变体是 <code>push</code>，适合生成事件流。与 <code>create</code>类似，<code>push</code> 也可以是异步地， 并且能够使用以上各种溢出策略（overflow strategies）管理背压。每次只有一个生成线程可以调用 <code>next</code>，<code>complete</code> 或 <code>error</code>。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> bridge <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sink <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    myEventProcessor<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">SingleThreadEventListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 1</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDataChunk</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> chunk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">String</span> s <span class="token operator">:</span> chunk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sink<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sink<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processError</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sink<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><ol><li>桥接 <code>SingleThreadEventListener</code> API</li> <li>在监听器所在线程中，事件通过调用 <code>next</code> 被推送到 sink</li> <li><code>complete</code> 事件也在同一个线程中</li> <li><code>error</code> 事件也在同一个线程中</li></ol> <h4 id="推送-拉取-push-pull-混合模式"><a href="#推送-拉取-push-pull-混合模式" class="header-anchor">#</a> 推送/拉取（push/pull）混合模式</h4> <p>不像 <code>push</code>，<code>create</code> 可以用于 <code>push</code> 或 <code>pull</code> 模式，因此适合桥接监听器的 的 API，因为事件消息会随时异步地到来。回调方法 <code>onRequest</code> 可以被注册到 <code>FluxSink</code> 以便跟踪请求。这个回调可以被用于从源头请求更多数据，或者通过在下游请求到来 的时候传递数据给 sink 以实现背压管理。这是一种推送/拉取混合的模式， 因为下游可以从上游拉取已经就绪的数据，上游也可以在数据就绪的时候将其推送到下游。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> bridge <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>sink <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    myMessageProcessor<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">MyMessageListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> messages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">String</span> s <span class="token operator">:</span> messages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sink<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sink<span class="token punctuation">.</span><span class="token function">onRequest</span><span class="token punctuation">(</span>n <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> messages <span class="token operator">=</span> myMessageProcessor<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">String</span> s <span class="token operator">:</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           sink<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ol><li>当有请求的时候取出一个 message</li> <li>如果有就绪的 message，就发送到 sink</li> <li>后续异步到达的 message 也会被发送给 sink</li></ol> <h4 id="清理-cleaning-up"><a href="#清理-cleaning-up" class="header-anchor">#</a> 清理（Cleaning up）</h4> <p><code>onDispose</code> 和 <code>onCancel</code> 这两个回调用于在被取消和终止后进行清理工作。 <code>onDispose</code> 可用于在 <code>Flux</code> 完成，有错误出现或被取消的时候执行清理。 <code>onCancel</code> 只用于针对「取消」信号执行相关操作，会先于 <code>onDispose</code> 执行。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> bridge <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>sink <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    sink<span class="token punctuation">.</span><span class="token function">onRequest</span><span class="token punctuation">(</span>n <span class="token operator">-&gt;</span> channel<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onCancel</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> channel<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 1</span>
        <span class="token punctuation">.</span><span class="token function">onDispose</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 2</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol><li><code>onCancel</code> 在取消时被调用。</li> <li><code>onDispose</code> 在有完成、错误和取消时被调用</li></ol> <h3 id="handle"><a href="#handle" class="header-anchor">#</a> Handle</h3> <p><code>handle</code> 方法有些不同，它在 <code>Mono</code> 和 <code>Flux</code> 中都有。然而，它是一个实例方法 （instance method），意思就是它要链接在一个现有的源后使用（与其他操作符一样）。</p> <p>它与 <code>generate</code> 比较类似，因为它也使用 <code>SynchronousSink</code>，并且只允许元素逐个发出。 然而，<code>handle</code> 可被用于基于现有数据源中的元素生成任意值，有可能还会跳过一些元素。 这样，可以把它当做 <code>map</code> 与 <code>filter</code> 的组合。<code>handle</code> 方法签名如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">BiConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">SynchronousSink</span><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>举个例子，响应式流规范允许 <code>null</code> 这样的值出现在序列中。假如你想执行一个类似 <code>map</code> 的操作，你想利用一个现有的具有映射功能的方法，但是它会返回 null，这时候怎么办呢？</p> <p>例如，下边的方法可以用于 Integer 序列，映射为字母或 null 。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">alphabet</span><span class="token punctuation">(</span><span class="token keyword">int</span> letterNumber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>letterNumber <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">||</span> letterNumber <span class="token operator">&gt;</span> <span class="token number">26</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> letterIndexAscii <span class="token operator">=</span> <span class="token char">'A'</span> <span class="token operator">+</span> letterNumber <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> letterIndexAscii<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>我们可以使用 <code>handle</code> 来去掉其中的 null。</p> <p>将 <code>handle</code> 用于一个 &quot;映射 + 过滤 null&quot; 的场景</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> alphabet <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> sink<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> letter <span class="token operator">=</span> <span class="token function">alphabet</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>letter <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// 2</span>
            sink<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>letter<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

alphabet<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol><li>映射到字母。</li> <li>如果返回的是 null</li> <li>就不会调用 <code>sink.next</code> 从而过滤掉</li></ol> <p>输出如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">M</span>
<span class="token class-name">I</span>
<span class="token class-name">T</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="调度器-schedulers"><a href="#调度器-schedulers" class="header-anchor">#</a> 调度器（Schedulers）</h2> <p>Reactor， 就像 RxJava，也可以被认为是 <strong>并发无关（concurrency agnostic）</strong> 的。意思就是， 它并不强制要求任何并发模型。更进一步，它将选择权交给开发者。不过，它还是提供了一些方便 进行并发执行的库。</p> <p>在 Reactor 中，执行模式以及执行过程取决于所使用的 <code>Scheduler</code>。 <a href="https://projectreactor.io/docs/core/release/api/reactor/core/scheduler/Scheduler.html" target="_blank" rel="noopener noreferrer"><code>Scheduler</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是一个拥有广泛实现类的抽象接口。 <a href="https://projectreactor.io/docs/core/release/api/reactor/core/scheduler/Schedulers.html" target="_blank" rel="noopener noreferrer"><code>Schedulers</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 类提供的静态方法用于达成如下的执行环境：</p> <ul><li>当前线程（<code>Schedulers.immediate()</code>）</li> <li>可重用的单线程（<code>Schedulers.single()</code>）。注意，这个方法对所有调用者都提供同一个线程来使用， 直到该调度器（Scheduler）被废弃。如果你想使用专一的线程，就对每一个调用使用 <code>Schedulers.newSingle()</code></li> <li>弹性线程池（<code>Schedulers.elastic()</code>。它根据需要创建一个线程池，重用空闲线程。线程池如果空闲时间过长 （默认为 60s）就会被废弃。对于 I/O 阻塞的场景比较适用。 <code>Schedulers.elastic()</code> 能够方便地给一个阻塞 的任务分配它自己的线程，从而不会妨碍其他任务和资源，见 <a href="/reactor/best-practices/#如何包装一个同步阻塞的调用">如何包装一个同步阻塞的调用？</a></li> <li>固定大小线程池（<code>Schedulers.parallel()</code>）。所创建线程池的大小与 CPU 个数等同</li></ul> <p>此外，你还可以使用 <code>Schedulers.fromExecutorService(ExecutorService)</code> 基于现有的 <code>ExecutorService</code> 创建 <code>Scheduler</code>。（虽然不太建议，不过你也可以使用 <code>Executor</code> 来创建）。你也可以使用 <code>newXXX</code> 方法来创建不同的调度器。比如 <code>Schedulers.newElastic(yourScheduleName)</code> 创建一个新的名为 <code>yourScheduleName</code> 的弹性调度器。</p> <blockquote><p>操作符基于非阻塞算法实现，从而可以利用到某些调度器的工作窃取（work stealing） 特性的好处。</p></blockquote> <p>一些操作符默认会使用一个指定的调度器（通常也允许开发者调整为其他调度器）例如， 通过工厂方法 <code>Flux.interval(Duration.ofMillis(300))</code> 生成的每 300ms 打点一次的 <code>Flux&lt;Long&gt;</code>， 默认情况下使用的是 <code>Schedulers.parallel()</code>，下边的代码演示了如何将其装换为 <code>Schedulers.single()</code>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">interval</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Schedulers</span><span class="token punctuation">.</span><span class="token function">newSingle</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Reactor 提供了两种在响应式链中调整调度器 <code>Scheduler</code> 的方法：<code>publishOn</code> 和 <code>subscribeOn</code>。 它们都接受一个 <code>Scheduler</code> 作为参数，从而可以改变调度器。但是 <code>publishOn</code> 在链中出现的位置 是有讲究的，而 <code>subscribeOn</code> 则无所谓。要理解它们的不同，你首先要理解 <a href="/reactor/reactive-programming/#subscribe-之前什么都不会发生">subscribe() 之前什么都不会发生</a>。</p> <p>在 Reactor 中，当你在操作链上添加操作符的时候，你可以根据需要在 <code>Flux</code> 和 <code>Mono</code> 的实现中包装其他的 <code>Flux</code> 和 <code>Mono</code>。一旦你订阅（subscribe）了它，一个 <code>Subscriber</code> 的链 就被创建了，一直向上到第一个 publisher 。这些对开发者是不可见的，开发者所能看到的是最外一层的 <code>Flux</code> （或 <code>Mono</code>）和 <code>Subscription</code>，但是具体的任务是在中间这些跟操作符相关的 subscriber 上处理的。</p> <p>基于此，我们仔细研究一下 <code>publishOn</code> 和 <code>subscribeOn</code> 这两个操作符：</p> <ul><li><code>publishOn</code> 的用法和处于订阅链（subscriber chain）中的其他操作符一样。它将上游 信号传给下游，同时执行指定的调度器 <code>Scheduler</code> 的某个工作线程上的回调。 它会 <strong>改变后续的操作符的执行所在线程</strong> （直到下一个 <code>publishOn</code> 出现在这个链上）。</li> <li><code>subscribeOn</code> 用于订阅（subscription）过程，作用于那个向上的订阅链（发布者在被订阅 时才激活，订阅的传递方向是向上游的）。所以，无论你把 <code>subscribeOn</code> 至于操作链的什么位置， <strong>它都会影响到源头的线程执行环境（context）</strong>。 但是，它不会影响到后续的 <code>publishOn</code>，后者仍能够切换其后操作符的线程执行环境。</li></ul> <blockquote><p>只有操作链中最早的 <code>subscribeOn</code> 调用才算数。</p></blockquote> <h2 id="线程模型"><a href="#线程模型" class="header-anchor">#</a> 线程模型</h2> <p><code>Flux</code> 和 <code>Mono</code> 不会创建线程。一些操作符，比如 <code>publishOn</code>，会创建线程。同时，作为一种任务共享形式， 这些操作符可能会从其他任务池（work pool）——如果其他任务池是空闲的话——那里「偷」线程。因此， 无论是 <code>Flux</code>、<code>Mono</code> 还是 <code>Subscriber</code> 都应该精于线程处理。它们依赖这些操作符来管理线程和任务池。</p> <p><code>publishOn</code> 强制下一个操作符（很可能包括下一个的下一个…）来运行在一个不同的线程上。 类似的，<code>subscribeOn</code> 强制上一个操作符（很可能包括上一个的上一个…）来运行在一个不同的线程上。 记住，在你订阅（subscribe）前，你只是定义了处理流程，而没有启动发布者。基于此，Reactor 可以使用这些规则来决定如何执行操作链。然后，一旦你订阅了，整个流程就开始工作了。</p> <p>下边的例子演示了支持任务共享的多线程模型：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span> <span class="token comment">// 1</span>
    <span class="token punctuation">.</span><span class="token function">publishOn</span><span class="token punctuation">(</span><span class="token class-name">Schedulers</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 2</span>
    <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token comment">// 3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol><li>创建一个有 10,000 个元素的 <code>Flux</code></li> <li>创建等同于 CPU 个数的线程（最小为4）</li> <li><code>subscribe()</code> 之前什么都不会发生</li></ol> <p><code>Scheduler.parallel()</code> 创建一个基于单线程 <code>ExecutorService</code> 的固定大小的任务线程池。 因为可能会有一个或两个线程导致问题，它总是至少创建 4 个线程。然后 publishOn 方法便共享了这些任务线程， 当 <code>publishOn</code> 请求元素的时候，会从任一个正在发出元素的线程那里获取元素。这样， 就是进行了任务共享（一种资源共享方式）。Reactor 还提供了好几种共享资源的方式，请参考 <a href="https://projectreactor.io/docs/core/release/api/reactor/core/scheduler/Schedulers.html" target="_blank" rel="noopener noreferrer">Schedulers<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p><code>Scheduler.elastic()</code> 也能创建线程，它能够很方便地创建专门的线程（以便跑一些可能会阻塞资源的任务， 比如一个同步服务），请见 <a href="/reactor/best-practices/#如何包装一个同步阻塞的调用">如何包装一个同步阻塞的调用？</a>。</p> <p>内部机制保证了这些操作符能够借助自增计数器（incremental counters）和警戒条件（guard conditions） 以线程安全的方式工作。例如，如果我们有四个线程处理一个流（就像上边的例子），每一个请求会让计数器自增， 这样后续的来自不同线程的请求就能拿到正确的元素。</p> <h2 id="处理错误"><a href="#处理错误" class="header-anchor">#</a> 处理错误</h2> <p>如果想了解有哪些可用于错误处理的操作符，请参考 <a href="/reactor/operators-summary/#错误处理">错误处理</a>。</p> <p>在响应式流中，错误（error）是终止（terminal）事件。当有错误发生时，它会导致流序列停止， 并且错误信号会沿着操作链条向下传递，直至遇到你定义的 <code>Subscriber</code> 及其 <code>onError</code> 方法。</p> <p>这样的错误还是应该在应用层面解决的。比如，你可能会将错误信息显示在用户界面，或者通过某个 REST 端点（endpoint）发出。因此，订阅者（subscriber）的 <code>onError</code> 方法是应该定义的。</p> <blockquote><p>如果没有定义，<code>onError</code> 会抛出 <code>UnsupportedOperationException</code>。你可以接下来再 检测错误，并通过 <code>Exceptions.isErrorCallbackNotImplemented</code> 方法捕获和处理它。</p></blockquote> <p>Reactor 还提供了其他的用于在链中处理错误的方法，即 <strong>错误处理操作（error-handling operators）</strong>。</p> <blockquote><p>在你了解错误处理操作符之前，你必须牢记 <strong>响应式流中的任何错误都是一个终止事件</strong>。 即使用了错误处理操作符，也不会让源头流序列继续。而是将 <code>onError</code> 信号转化为一个 <strong>新的</strong> 序列 的开始。换句话说，它代替了被终结的 <em>上游</em> 流序列。</p></blockquote> <p>现在我们来逐个看看错误处理的方法。需要的时候我们会同时用到命令式编程风格的 <code>try</code> 代码块来作比较。</p> <h3 id="错误处理方法"><a href="#错误处理方法" class="header-anchor">#</a> 错误处理方法</h3> <p>你也许熟悉在 try-catch 代码块中处理异常的几种方法。常见的包括如下几种：</p> <ol><li>捕获并返回一个静态的缺省值。</li> <li>捕获并执行一个异常处理方法。</li> <li>捕获并动态计算一个候补值来顶替。</li> <li>捕获，并再包装为某一个 <code>业务相关的异常</code>，然后再抛出业务异常。</li> <li>捕获，记录错误日志，然后继续抛出。</li> <li>使用 <code>finally</code> 来清理资源，或使用 Java 7 引入的 &quot;try-with-resource&quot;。</li></ol> <p>以上所有这些在 Reactor 都有相应的基于 error-handling 操作符处理方式。</p> <p>在开始研究这些操作符之前，我们先准备好响应式链（reactive chain）方式和 try-catch 代码块方式（以便对比）。</p> <p>当订阅的时候，位于链结尾的 <code>onError</code> 回调方法和 <code>catch</code> 块类似，一旦有异常，执行过程会跳入到 catch：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> s <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>v <span class="token operator">-&gt;</span> <span class="token function">doSomethingDangerous</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 1</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>v <span class="token operator">-&gt;</span> <span class="token function">doSecondTransform</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
s<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>value <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;RECEIVED &quot;</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 3</span>
            error <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;CAUGHT &quot;</span> <span class="token operator">+</span> error<span class="token punctuation">)</span> <span class="token comment">// 4</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol><li>执行 map 转换，有可能抛出异常</li> <li>如果没问题，执行第二个 map 转换操作</li> <li>所有转换成功的值都打印出来</li> <li>一旦有错误，序列（sequence）终止，并打印错误信息</li></ol> <p>这与 try/catch 代码块是类似的：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">11</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> v1 <span class="token operator">=</span> <span class="token function">doSomethingDangerous</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
        <span class="token class-name">String</span> v2 <span class="token operator">=</span> <span class="token function">doSecondTransform</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;RECEIVED &quot;</span> <span class="token operator">+</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;CAUGHT &quot;</span> <span class="token operator">+</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ol><li>如果这里抛出异常</li> <li>后续的代码跳过</li> <li>执行过程直接到这</li></ol> <p>既然我们准备了两种方式做对比，我们就来看一下不同的错误处理场景，以及相应的操作符。</p> <h5 id="静态缺省值"><a href="#静态缺省值" class="header-anchor">#</a> 静态缺省值</h5> <p>与第 <strong>(1)</strong> 条（捕获并返回一个静态的缺省值）对应的是 <code>onErrorReturn</code>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">doSomethingDangerous</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">onErrorReturn</span><span class="token punctuation">(</span><span class="token string">&quot;RECOVERED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>你还可以通过判断错误信息的内容，来筛选哪些要给出缺省值，哪些仍然让错误继续传递下去：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">doSomethingDangerous</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">onErrorReturn</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;boom10&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;recovered10&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h5 id="异常处理方法"><a href="#异常处理方法" class="header-anchor">#</a> 异常处理方法</h5> <p>如果你不只是想要在发生错误的时候给出缺省值，而是希望提供一种更安全的处理数据的方式， 可以使用 <code>onErrorResume</code>。这与第 <strong>(2)</strong> 条（捕获并执行一个异常处理方法）类似。</p> <p>假设，你会尝试从一个外部的不稳定服务获取数据，但仍然会在本地缓存一份 <strong>可能</strong> 有些过期的数据， 因为缓存的读取更加可靠。可以这样来做：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">&quot;key1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;key2&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>k <span class="token operator">-&gt;</span> <span class="token function">callExternalService</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 1</span>
    <span class="token punctuation">.</span><span class="token function">onErrorResume</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> <span class="token function">getFromCache</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol><li>对于每一个 key， 异步地调用一个外部服务</li> <li>如果对外部服务的调用失败，则再去缓存中查找该 key。注意，这里无论 <code>e</code> 是什么，都会执行异常处理方法</li></ol> <p>就像 <code>onErrorReturn</code>，<code>onErrorResume</code> 也有可以用于预先过滤错误内容的方法变体，可以基于异常类或 <code>Predicate</code> 进行过滤。它实际上是用一个 <code>Function</code> 来作为参数，还可以返回一个新的流序列。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">&quot;timeout1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;unknown&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;key2&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>k <span class="token operator">-&gt;</span> <span class="token function">callExternalService</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">onErrorResume</span><span class="token punctuation">(</span>error <span class="token operator">-&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 1</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token keyword">instanceof</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">)</span> <span class="token comment">// 2</span>
            <span class="token keyword">return</span> <span class="token function">getFromCache</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token keyword">instanceof</span> <span class="token class-name">UnknownKeyException</span><span class="token punctuation">)</span> <span class="token comment">// 3</span>
            <span class="token keyword">return</span> <span class="token function">registerNewEntry</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token string">&quot;DEFAULT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol><li>这个函数式允许开发者自行决定如何处理</li> <li>如果源超时，使用本地缓存</li> <li>如果源找不到对应的 key，创建一个新的实体</li> <li>否则， 将问题「重新抛出」</li></ol> <h4 id="动态候补值"><a href="#动态候补值" class="header-anchor">#</a> 动态候补值</h4> <p>有时候并不想提供一个错误处理方法，而是想在接收到错误的时候计算一个候补的值。这类似于第 <strong>(3)</strong> 条（捕获并动态计算一个候补值）。</p> <p>例如，如果你的返回类型本身就有可能包装有异常（比如 <code>Future.complete(T success)</code> vs <code>Future.completeExceptionally(Throwable error)</code>），你有可能使用流中的错误包装起来实例化 返回值。</p> <p>这也可以使用上一种错误处理方法的方式（使用 <code>onErrorResume</code>）解决，代码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>erroringFlux<span class="token punctuation">.</span><span class="token function">onErrorResume</span><span class="token punctuation">(</span>error <span class="token operator">-&gt;</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span> <span class="token comment">// 1</span>
        myWrapper<span class="token punctuation">.</span><span class="token function">fromError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token comment">// 2</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol><li>在 <code>onErrorResume</code> 中，使用 <code>Mono.just</code> 创建一个 <code>Mono</code></li> <li>将异常包装到另一个类中</li></ol> <h4 id="捕获并重新抛出"><a href="#捕获并重新抛出" class="header-anchor">#</a> 捕获并重新抛出</h4> <p>在「错误处理方法」的例子中，基于 <code>flatMap</code> 方法的最后一行，我们可以猜到如何做到第 <strong>(4)</strong> 条（捕获，包装到一个业务相关的异常，然后抛出业务异常）：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">&quot;timeout1&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>k <span class="token operator">-&gt;</span> <span class="token function">callExternalService</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">onErrorResume</span><span class="token punctuation">(</span>original <span class="token operator">-&gt;</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token string">&quot;oops, SLA exceeded&quot;</span><span class="token punctuation">,</span> original<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>然而还有一个更加直接的方法—— <code>onErrorMap</code>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">&quot;timeout1&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>k <span class="token operator">-&gt;</span> <span class="token function">callExternalService</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">onErrorMap</span><span class="token punctuation">(</span>original <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token string">&quot;oops, SLA exceeded&quot;</span><span class="token punctuation">,</span> original<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="记录错误日志"><a href="#记录错误日志" class="header-anchor">#</a> 记录错误日志</h4> <p>如果对于错误你只是想在不改变它的情况下做出响应（如记录日志），并让错误继续传递下去， 那么可以用 <code>doOnError</code> 方法。这对应第 <strong>(5)</strong> 条（捕获，记录错误日志，并继续抛出）。 这个方法与其他以 <code>doOn</code> 开头的方法一样，只起副作用（&quot;side-effect&quot;）。它们对序列都是只读， 而不会带来任何改动。</p> <p>如下边的例子所示，我们会记录错误日志，并且还通过变量自增统计错误发生个数。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">LongAdder</span> failureStat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LongAdder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> flux <span class="token operator">=</span>
<span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">&quot;unknown&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>k <span class="token operator">-&gt;</span> <span class="token function">callExternalService</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 1</span>
    <span class="token punctuation">.</span><span class="token function">doOnError</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        failureStat<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;uh oh, falling back, service failed for key &quot;</span> <span class="token operator">+</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">onErrorResume</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> <span class="token function">getFromCache</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ol><li>对外部服务的调用失败</li> <li>记录错误日志</li> <li>然后回调错误处理方法</li></ol> <h4 id="使用资源和-try-catch-代码块"><a href="#使用资源和-try-catch-代码块" class="header-anchor">#</a> 使用资源和 try-catch 代码块</h4> <p>最后一个要与命令式编程对应的对比就是使用 Java 7 &quot;try-with-resources&quot; 或 <code>finally</code> 代码块清理资源。这是第 <strong>(6)</strong> 条（使用 <code>finally</code> 代码块清理资源或使用 Java 7 引入的 &quot;try-with-resource&quot;）。在 Reactor 中都有对应的方法： <code>using</code> 和 <code>doFinally</code>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">AtomicBoolean</span> isDisposed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Disposable</span> disposableInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Disposable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        isDisposed<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;DISPOSABLE&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> flux <span class="token operator">=</span>
<span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">using</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> disposableInstance<span class="token punctuation">,</span> <span class="token comment">// 1</span>
        disposable <span class="token operator">-&gt;</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>disposable<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 2</span>
        <span class="token class-name">Disposable</span><span class="token operator">::</span><span class="token function">dispose</span> <span class="token comment">// 3</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><ol><li>第一个 lambda 生成资源，这里我们返回模拟的（mock） <code>Disposable</code></li> <li>第二个 lambda 处理资源，返回一个 <code>Flux&lt;T&gt;</code></li> <li>第三个 lambda 在 2) 中的资源 <code>Flux</code> 终止或取消的时候，用于清理资源</li> <li>在订阅或执行流序列之后， <code>isDisposed</code> 会置为 <code>true</code></li></ol> <p>另一方面， <code>doFinally</code> 在序列终止（无论是 <code>onComplete</code>、<code>onError</code>还是取消）的时候被执行， 并且能够判断是什么类型的终止事件（完成、错误还是取消？）。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">LongAdder</span> statsCancel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LongAdder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>

<span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> flux <span class="token operator">=</span>
<span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">doFinally</span><span class="token punctuation">(</span>type <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token class-name">SignalType</span><span class="token punctuation">.</span><span class="token constant">CANCEL</span><span class="token punctuation">)</span> <span class="token comment">// 2</span>
          statsCancel<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ol><li>我们想进行统计，所以用到了 <code>LongAdder</code></li> <li><code>doFinally</code> 用 <code>SignalType</code> 检查了终止信号的类型</li> <li>如果只是取消，那么统计数据自增</li> <li><code>take(1)</code> 能够在发出 1 个元素后取消流</li></ol> <h4 id="演示终止方法-onerror"><a href="#演示终止方法-onerror" class="header-anchor">#</a> 演示终止方法 <code>onError</code></h4> <p>为了演示当错误出现的时候如何导致上游序列终止，我们使用 <code>Flux.interval</code> 构造一个更加直观的例子。 这个 interval 操作符会在每 x 单位的时间发出一个自增的 <code>Long</code> 值。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> flux <span class="token operator">=</span>
<span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">interval</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>input <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">&quot;tick &quot;</span> <span class="token operator">+</span> input<span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;boom&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">onErrorReturn</span><span class="token punctuation">(</span><span class="token string">&quot;Uh oh&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

flux<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol><li>注意 <code>interval</code> 默认基于一个 <strong>timer</strong> <code>Scheduler</code> 来执行。 如果我们想在 main 方法中运行， 我们需要调用 <code>sleep</code>，这样程序就可以在还没有产生任何值的时候就退出了</li></ol> <p>每 250ms 打印出一行信息，如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>tick <span class="token number">0</span>
tick <span class="token number">1</span>
tick <span class="token number">2</span>
<span class="token class-name">Uh</span> oh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>即使多给了 1 秒钟时间，也没有更多的 tick 信号由 <code>interval</code> 产生了，所以序列确实被错误信号终止了。</p> <h4 id="重试"><a href="#重试" class="header-anchor">#</a> 重试</h4> <p>还有一个用于错误处理的操作符你可能会用到，就是 <code>retry</code>，见文知意，用它可以对出现错误的序列进行重试。</p> <p>问题是它对于上游 <code>Flux</code> 是基于重订阅（<strong>re-subscribing</strong>）的方式。这实际上已经一个不同的序列了， 发出错误信号的序列仍然是终止了的。为了验证这一点，我们可以在继续用上边的例子，增加一个 <code>retry(1)</code> 代替 <code>onErrorReturn</code> 来重试一次。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">interval</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>input <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">&quot;tick &quot;</span> <span class="token operator">+</span> input<span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;boom&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">elapsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 1</span>
    <span class="token punctuation">.</span><span class="token function">retry</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>

<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol><li><code>elapsed</code> 会关联从当前值与上个值发出的时间间隔（如下边输出的内容中的 259/249/251）</li> <li>我们还是要看一下 <code>onError</code> 时的内容</li> <li>确保我们有足够的时间可以进行 4x2 次 tick</li></ol> <p>输出如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">259</span><span class="token punctuation">,</span>tick <span class="token number">0</span>
<span class="token number">249</span><span class="token punctuation">,</span>tick <span class="token number">1</span>
<span class="token number">251</span><span class="token punctuation">,</span>tick <span class="token number">2</span>
<span class="token number">506</span><span class="token punctuation">,</span>tick <span class="token number">0</span> <span class="token comment">// 1</span>
<span class="token number">248</span><span class="token punctuation">,</span>tick <span class="token number">1</span>
<span class="token number">253</span><span class="token punctuation">,</span>tick <span class="token number">2</span>
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>RuntimeException</span><span class="token operator">:</span> boom
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol><li>一个新的 <code>interval</code> 从 tick 0 开始。多出来的 250ms 间隔来自于第 4 次 tick， 就是导致出现异常并执行 retry 的那次</li></ol> <p>可见， <code>retry(1)</code> 不过是再一次从新订阅了原始的 <code>interval</code>，从 tick 0 开始。第二次， 由于异常再次出现，便将异常传递到下游了。</p> <p>还有一个「高配版」的 <code>retry</code> （<code>retryWhen</code>），它使用一个伴随（&quot;companion&quot;） <code>Flux</code> 来判断对某次错误是否要重试。这个伴随 <code>Flux</code> 是由操作符创建的，但是由开发者包装它， 从而实现对重试操作的配置。</p> <p>这个伴随 <code>Flux</code> 是一个 <code>Flux&lt;Throwable&gt;</code>，它作为 <code>retryWhen</code> 的唯一参数被传递给一个 <code>Function</code>，你可以定义这个 <code>Function</code> 并让它返回一个新的 <code>Publisher&lt;?&gt;</code>。重试的循环 会这样运行：</p> <ol><li>每次出现错误，错误信号会发送给伴随 <code>Flux</code>，后者已经被你用 <code>Function</code> 包装。</li> <li>如果伴随 <code>Flux</code> 发出元素，就会触发重试。</li> <li>如果伴随 <code>Flux</code> 完成（complete），重试循环也会停止，并且原始序列也会 <strong>完成（complete）</strong>。</li> <li>如果伴随 <code>Flux</code> 产生一个错误，重试循环停止，原始序列也停止 <strong>或</strong> 完成，并且这个错误会导致 原始序列失败并终止。</li></ol> <p>了解前两个场景的区别是很重要的。如果让伴随 <code>Flux</code> 完成（complete）等于吞掉了错误。如下代码用 <code>retryWhen</code> 模仿了 <code>retry(3)</code> 的效果：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> flux <span class="token operator">=</span> <span class="token class-name">Flux</span>
    <span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 1</span>
    <span class="token punctuation">.</span><span class="token function">doOnError</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span> <span class="token comment">// 2</span>
    <span class="token punctuation">.</span><span class="token function">retryWhen</span><span class="token punctuation">(</span>companion <span class="token operator">-&gt;</span> companion<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol><li>持续产生错误</li> <li>在 retry <strong>之前</strong> 的 <code>doOnError</code> 可以让我们看到错误</li> <li>这里，我们认为前 3 个错误是可以重试的（<code>take(3)</code>），再有错误就放弃</li></ol> <p>事实上，上边例子最终得到的是一个 <strong>空的</strong> <code>Flux</code>，但是却 <strong>成功</strong> 完成了。反观对同一个 <code>Flux</code> 调用 <code>retry(3)</code> 的话，最终是以最后一个 error 终止 <code>Flux</code>，故而 <code>retryWhen</code> 与之不同。</p> <p>实现同样的效果需要一些额外的技巧：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> flux <span class="token operator">=</span>
<span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">retryWhen</span><span class="token punctuation">(</span>companion <span class="token operator">-&gt;</span> companion
    <span class="token punctuation">.</span><span class="token function">zipWith</span><span class="token punctuation">(</span><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 1</span>
          <span class="token punctuation">(</span>error<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 2</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">return</span> index<span class="token punctuation">;</span> <span class="token comment">// 3</span>
            <span class="token keyword">else</span> <span class="token keyword">throw</span> <span class="token class-name">Exceptions</span><span class="token punctuation">.</span><span class="token function">propagate</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ol><li>技巧一：使用 <code>zip</code> 和一个「重试个数 + 1」的 <code>range</code></li> <li><code>zip</code> 方法让你可以在对重试次数计数的同时，仍掌握着原始的错误（error）</li> <li>允许三次重试，小于 4 的时候发出一个值</li> <li>为了使序列以错误结束。我们将原始异常在三次重试之后抛出</li></ol> <blockquote><p>类似的代码也可以被用于实现 <em>exponential backoff and retry</em> 模式 （重试指定的次数, 且每一次重试之间停顿的时间逐渐增加），参考 <a href="/reactor/best-practices/#如何用-retrywhen-来实现-retry-3-的效果">最佳实践</a>。</p></blockquote> <h3 id="在操作符或函数式中处理异常"><a href="#在操作符或函数式中处理异常" class="header-anchor">#</a> 在操作符或函数式中处理异常</h3> <p>总体来说，所有的操作符自身都可能包含触发异常的代码，或自定义的可能导致失败的代码， 所以它们都自带一些错误处理方式。</p> <p>一般来说，一个 <strong>不受检异常（Unchecked Exception）</strong> 总是由 <code>onError</code> 传递。例如， 在一个 <code>map</code> 方法中抛出 <code>RuntimeException</code> 会被翻译为一个 <code>onError</code> 事件，如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>v <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;GOT VALUE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
               e <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ERROR: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>上边代码输出如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token constant">ERROR</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>IllegalArgumentException</span><span class="token operator">:</span> foo
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p><code>Exception</code> 可以在其被传递给 <code>onError</code> 之前，使用 <a href="/reactor/advanced-features-and-concepts/#内部错误-hook">内部错误 Hook</a> 进行调整。</p></blockquote> <p>Reactor，定义了一系列的能够导致「严重失败」的错误（比如 <code>OutOfMemoryError</code>），也可参考 <code>Exceptions.throwIfFatal</code> 方法。这些错误意味着 Reactor 无力处理只能抛出，无法传递下去。</p> <blockquote><p>还有些情况下不受检异常仍然无法传递下去（多数处于subscribe 和 request 阶段）， 因为可能由于多线程竞争导致两次 <code>onError</code> 或 <code>onComplete</code> 的情况。当这种竞争发生的时候， 无法传递下去的错误信号就被「丢弃」了。这些情况仍然可以通过自定义的 hook 来搞定，见 <a href="/reactor/advanced-features-and-concepts/#丢弃事件的-hooks">丢弃事件的 Hooks</a>。</p></blockquote> <p>你可能会问：「那么 <strong>受检查异常（Checked Exceptions）</strong>？」</p> <p>如果你需要调用一个声明为 <code>throws</code> 异常的方法，你仍然需要使用 <code>try-catch</code> 代码块处理异常。 有几种方式：</p> <ol><li>捕获异常，并修复它，流序列正常继续。</li> <li>捕获异常，并把它包装（wrap）到一个 <em>不受检异常</em> 中，然后抛出（中断序列）。工具类 <code>Exceptions</code> 可用于这种方式（我们马上会讲到）。</li> <li>如果你气我返回一个 <code>Flux</code> （例如在 <code>flatMap</code> 中），将异常包装在一个产生错误的 <code>Flux</code>中： <code>return Flux.error(checkedException)</code>（流序列也会终止）。</li></ol> <p>Reactor 有一个工具类 <code>Exceptions</code>，可以确保在收到受检异常的时候将其包装（wrap）起来。</p> <ul><li>如果需要，可以使用 <code>Exceptions.propagate</code> 方法来包装异常，它同样会首先调用 <code>throwIfFatal</code>， 并且不会包装 <code>RuntimeException</code>。</li> <li>使用 <code>Exceptions.unwrap</code> 方法来得到原始的未包装的异常（追溯最初的异常）。</li></ul> <p>下面是一个 <code>map</code> 的例子，它使用的 convert 方法会抛出 <code>IOException</code>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;boom &quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">&quot;OK &quot;</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>现在想象你将这个方法用于一个 <code>map</code> 中，你必须明确捕获这个异常，并且你的 <code>map</code> 方法不能再次抛出它。 所以你可以将其以 <code>RuntimeException</code> 的形式传递给 <code>onError</code>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> converted <span class="token operator">=</span> <span class="token class-name">Flux</span>
    <span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">convert</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> <span class="token class-name">Exceptions</span><span class="token punctuation">.</span><span class="token function">propagate</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>当后边订阅上边的这个 <code>Flux</code> 并响应错误（比如在用户界面）的时候，如果你想处理 IOException， 你还可以再将其转换为原始的异常。如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>converted<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>
    v <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;RECEIVED: &quot;</span> <span class="token operator">+</span> v<span class="token punctuation">)</span><span class="token punctuation">,</span>
    e <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Exceptions</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">IOException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Something bad happened with I/O&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Something bad happened&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="processors"><a href="#processors" class="header-anchor">#</a> Processors</h2> <p>Processors 既是一种特别的发布者（<code>Publisher</code>）又是一种订阅者（<code>Subscriber</code>）。 那意味着你可以 订阅一个 <code>Processor</code>（通常它们会实现 <code>Flux</code>），也可以调用相关方法来手动 插入数据到序列，或终止序列。</p> <p>Processor 有多种类型，它们都有特别的语义规则，但是在你研究它们之前，最好问一下 自己如下几个问题：</p> <h3 id="我是否需要使用-processor"><a href="#我是否需要使用-processor" class="header-anchor">#</a> 我是否需要使用 Processor</h3> <p>多数情况下，你应该进行避免使用 <code>Processor</code>，它们较难正确使用，主要用于一些特殊场景下。</p> <p>如果你觉得 <code>Processor</code> 适合你的使用场景，请首先看一下是否尝试过以下两种替代方式：</p> <ol><li>是否有一个或多个操作符的组合能够满足需求？（见 <a href="/reactor/operators-summary/">操作符总结</a>）</li> <li><a href="#%E5%8F%AF%E7%BC%96%E7%A8%8B%E5%BC%8F%E5%9C%B0%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%BA%8F%E5%88%97">可编程式地创建一个序列</a> 操作符是否能解决问题？（通常这些操作符 可以用来桥接非响应式的 API，它们提供了一个「sink」，在生成数据流序列方面， 概念上类似于 <code>Processor</code>）</li></ol> <p>如果看了以上替代方案，你仍然觉得需要一个 <code>Processor</code>，阅读 <a href="#%E7%8E%B0%E6%9C%89%E7%9A%84-processors-%E6%80%BB%E8%A7%88">现有的 Processors 总览</a> 这一节来了解一下不同的实现吧。</p> <h3 id="使用-sink-门面对象来线程安全地生成流"><a href="#使用-sink-门面对象来线程安全地生成流" class="header-anchor">#</a> 使用 <code>Sink</code> 门面对象来线程安全地生成流</h3> <p>比起直接使用 Reactor 的 <code>Processors</code>，更好的方式是通过调用一次 <code>sink()</code> 来得到 <code>Processor</code> 的 <code>Sink</code>。</p> <p><code>FluxProcessor</code> 的 sink 是线程安全的「生产者（producer）」，因此能够在应用程序中 多线程并发地生成数据。例如，一个线程安全的序列化（serialized）的 sink 能够通过 <code>UnicastProcessor</code> 创建：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">UnicastProcessor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> processor <span class="token operator">=</span> <span class="token class-name">UnicastProcessor</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">FluxSink</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> sink <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">sink</span><span class="token punctuation">(</span>overflowStrategy<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>多个生产者线程可以并发地生成数据到以下的序列化 sink。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>sink<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>根据 <code>Processor</code> 及其配置，<code>next</code> 产生的溢出有两种可能的处理方式：</p> <ul><li>一个无限的 processor 通过丢弃或缓存自行处理溢出。</li> <li>一个有限的 processor 阻塞在 <code>IGNORE</code> 策略，或将 <code>overflowStrategy</code> 应用于 <code>sink</code>。</li></ul> <h3 id="现有的-processors-总览"><a href="#现有的-processors-总览" class="header-anchor">#</a> 现有的 Processors 总览</h3> <p>Reactor Core 内置多种 <code>Processor</code>。这些 processor 具有不同的语法，大概分为三类。 下边简要介绍一下这三种 processor：</p> <ul><li><strong>直接的（direct）</strong> （<code>DirectProcessor</code> 和 <code>UnicastProcessor</code>）：这些 processors 只能通过直接 调用 <code>Sink</code> 的方法来推送数据</li> <li><strong>同步的（synchronous）</strong> （<code>EmitterProcessor</code> 和 <code>ReplayProcessor</code>）：这些 processors 既可以 直接调用 <code>Sink</code> 方法来推送数据，也可以通过订阅到一个上游的发布者来同步地产生数据</li> <li><strong>异步的（asynchronous）</strong>（<code>WorkQueueProcessor</code> 和 <code>TopicProcessor</code>）：这些 processors 可以将从多个上游发布者得到的数据推送下去。由于使用了 <code>RingBuffer</code> 的数据结构来 缓存多个来自上游的数据，因此更加有健壮性</li></ul> <p>异步的 processor 在实例化的时候最复杂，因为有许多不同的选项。因此它们暴露出一个 <code>Builder</code> 接口。 而简单的 processors 有静态的工厂方法。</p> <h4 id="directprocessor"><a href="#directprocessor" class="header-anchor">#</a> DirectProcessor</h4> <p><code>DirectProcessor</code> 可以将信号分发给零到多个订阅者（<code>Subscriber</code>）。它是最容易实例化的，使用静态方法 <code>create()</code> 即可。另一方面，<strong>它的不足是无法处理背压</strong>。所以，当 <code>DirectProcessor</code> 推送的是 N 个元素，而至少有一个订阅者的请求个数少于 N 的时候，就会发出一个 <code>IllegalStateException</code>。</p> <p>一旦 <code>Processor</code> 终止（通常通过调用它的 <code>Sink</code> 的 <code>error(Throwable)</code> 或 <code>complete()</code> 方法）， 虽然它允许更多的订阅者订阅它，但是会立即向它们重新发送终止信号。</p> <h4 id="unicastprocessor"><a href="#unicastprocessor" class="header-anchor">#</a> UnicastProcessor</h4> <p><code>UnicastProcessor</code> 可以使用一个内置的缓存来处理背压。代价就是它最多只能有一个订阅者。</p> <p><code>UnicastProcessor</code> 有多种选项，因此提供多种不同的 <code>create</code> 静态方法。例如，它默认是 <em>无限的（unbounded）</em> ：如果你在在订阅者还没有请求数据的情况下让它推送数据，它会缓存所有数据。</p> <p>可以通过提供一个自定义的 <code>Queue</code> 的具体实现传递给 <code>create</code> 工厂方法来改变默认行为。如果给出的队列是 有限的（bounded）， 并且缓存已满，而且未收到下游的请求，processor 会拒绝推送数据。</p> <p>在上边 <em>有限的</em> 例子中，还可以在构造 processor 的时候提供一个回调方法，这个回调方法可以在每一个 被拒绝推送的元素上调用，从而让开发者有机会清理这些元素。</p> <h4 id="emitterprocessor"><a href="#emitterprocessor" class="header-anchor">#</a> EmitterProcessor</h4> <p><code>EmitterProcessor</code> 能够向多个订阅者发送数据，并且可以对每一个订阅者进行背压处理。它本身也可以订阅一个 <code>Publisher</code> 并同步获得数据。</p> <p>最初如果没有订阅者，它仍然允许推送一些数据到缓存，缓存大小由 <code>bufferSize</code> 定义。 之后如果仍然没有订阅者订阅它并消费数据，对 <code>onNext</code> 的调用会阻塞，直到有订阅者接入 （这时只能并发地订阅了）。</p> <p>因此第一个订阅者会收到最多 <code>bufferSize</code> 个元素。然而之后， processor 不会重新发送（replay） 数据给后续的订阅者。这些后续接入的订阅者只能获取到它们开始订阅 <strong>之后</strong> 推送的数据。这个内部的 缓存会继续用于背压的目的。</p> <p>默认情况下，如果所有的订阅者都取消了（基本意味着它们都不再订阅（un-subscribed）了）， 它会清空内部缓存，并且不再接受更多的订阅者。这一点可以通过 <code>create</code> 静态工厂方法的 <code>autoCancel</code> 参数来配置。</p> <h4 id="replayprocessor"><a href="#replayprocessor" class="header-anchor">#</a> ReplayProcessor</h4> <p><code>ReplayProcessor</code> 会缓存直接通过自身的 <code>Sink</code> 推送的元素，以及来自上游发布者的元素， 并且后来的订阅者也会收到重发（replay）的这些元素。</p> <p>可以通过多种配置方式创建它：</p> <ul><li>缓存一个元素（<code>cacheLast</code>）。</li> <li>缓存一定个数的历史元素（<code>create(int)</code>），所有的历史元素（<code>create()</code>）。</li> <li>缓存基于时间窗期间内的元素（<code>createTimeout(Duration)</code>）。</li> <li>缓存基于历史个数和时间窗的元素（<code>createSizeOrTimeout(int, Duration)</code>）。</li></ul> <h4 id="topicprocessor"><a href="#topicprocessor" class="header-anchor">#</a> TopicProcessor</h4> <p><code>TopicProcessor</code> 是一个异步的 processor，它能够重发来自多个上游发布者的元素， 这需要在创建它的时候配置 <code>shared</code> （见 <code>build()</code> 的 <code>share(boolean)</code> 配置）。</p> <p>注意，如果你企图在并发环境下通过并发的上游 Publisher 调用 <code>TopicProcessor</code> 的 <code>onNext</code>、 <code>onComplete</code>，或 <code>onError</code> 方法，就必须配置 shared。</p> <p>否则，并发调用就是非法的，从而 processor 是完全兼容响应式流规范的。</p> <p><code>TopicProcessor</code> 能够对多个订阅者发送数据。它通过对每一个订阅者关联一个线程来实现这一点， 这个线程会一直执行直到 processor 发出 <code>onError</code> 或 <code>onComplete</code> 信号，或关联的订阅者被取消。 最多可以接受的订阅者个数由构造者方法 <code>executor</code> 指定，通过提供一个有限线程数的 <code>ExecutorService</code> 来限制这一个数。</p> <p>这个 processor 基于一个 <code>RingBuffer</code> 数据结构来存储已发送的数据。每一个订阅者线程 自行管理其相关的数据在 <code>RingBuffer</code> 中的索引。</p> <p>这个 processor 也有一个 <code>autoCancel</code> 构造器方法：如果设置为 <code>true</code> （默认的），那么当 所有的订阅者取消之后，源 <code>Publisher</code>(s) 也就被取消了。</p> <h4 id="workqueueprocessor"><a href="#workqueueprocessor" class="header-anchor">#</a> WorkQueueProcessor</h4> <p><code>WorkQueueProcessor</code> 也是一个异步的 processor，也能够重发来自多个上游发布者的元素， 同样在创建时需要配置 <code>shared</code> （它多数构造器配置与 <code>TopicProcessor</code> 相同）。</p> <p>它放松了对响应式流规范的兼容，但是好处就在于相对于 <code>TopicProcessor</code> 来说需要更少的资源。 它仍然基于 <code>RingBuffer</code>，但是不再要求每一个订阅者都关联一个线程，因此相对于 <code>TopicProcessor</code> 来说更具扩展性。</p> <p>代价在于分发模式有些区别：来自订阅者的请求会汇总在一起，并且这个 processor 每次只对一个 订阅者发送数据，因此需要循环（round-robin）对订阅者发送数据，而不是一次全部发出的模式。</p> <blockquote><p>无法保证完全公平的循环分发。</p></blockquote> <p><code>WorkQueueProcessor</code> 多数构造器方法与 <code>TopicProcessor</code> 相同，比如 <code>autoCancel</code>、<code>share</code>， 以及 <code>waitStrategy</code>。下游订阅者的最大数目同样由构造器 <code>executor</code> 配置的 <code>ExecutorService</code> 决定。</p> <blockquote><p>你最好注意不要有太多订阅者订阅 <code>WorkQueueProcessor</code>，因为这 <strong>会锁住 processor</strong>。 如果你需要限制订阅者数量，最好使用一个 <code>ThreadPoolExecutor</code> 或 <code>ForkJoinPool</code>。这个 processor 能够检测到（线程池）容量并在订阅者过多时抛出异常。</p></blockquote></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/Somnus711/Somnus711.github.io/edit/master/docs/30.框架/60.响应式框架 - Reactor/05.Reactor - 核心特性.md" target="_blank" rel="noopener noreferrer">编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=Reactor" title="标签">#Reactor</a></div> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">2025/04/06, 01:04:59</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/reactor/reactive-programming/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Reactor - 响应式编程</div></a> <a href="/reactor/kotlin-support/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Reactor - 对 Kotlin 的支持</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/reactor/reactive-programming/" class="prev">Reactor - 响应式编程</a></span> <span class="next"><a href="/reactor/kotlin-support/">Reactor - 对 Kotlin 的支持</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/ep/magic-change/"><div>
            技术随笔 - Element Plus 修改包名
            <span class="title-tag">
              原创
            </span></div></a> <span class="date">11-02</span></dt></dl><dl><dd>02</dd> <dt><a href="/reactor/extensibility/"><div>
            Reactor - 扩展性
            <!----></div></a> <span class="date">11-02</span></dt></dl><dl><dd>03</dd> <dt><a href="/reactor/best-practices/"><div>
            Reactor - 最佳实践
            <!----></div></a> <span class="date">11-02</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:haoyuan1996@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/Somnus711" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2025
    <span>Somnus Haoyuan | <a href="https://github.com/Somnus711/Somnus711.github.io/blob/main/LICENSE" target="_blank">MIT
            License</a><br />
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010802034042"
            style="display:inline-block;text-decoration:none;height:20px;line-height:20px;"><img
                src="https://cdn.jsdelivr.net/gh/Somnus711/picx-image-hosting@master/blog-pic/备案图标.3ph98jsceq0w.webp" style="float:left;" />
            <span>京公网安备 11010802034042号</span>
        </a>
        <a target="_blank" href="https://beian.miit.gov.cn"
            style="display:inline-block;text-decoration:none;height:20px;line-height:20px;padding-left: 10px;">
            <span>京ICP备2025120692号-1</span></a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div></div><div></div><div></div><div id="tcomment"></div><!----><div></div></div></div>
    <script src="/assets/js/app.40d6eb57.js" defer></script><script src="/assets/js/2.84f16386.js" defer></script><script src="/assets/js/244.dffff977.js" defer></script><script src="/assets/js/15.107d5767.js" defer></script><script src="/assets/js/5.1ffba6c1.js" defer></script><script src="/assets/js/9.dba8a9bf.js" defer></script><script src="/assets/js/12.3f1ed9aa.js" defer></script>
  </body>
</html>
