<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>知识 - CompletableFuture | Haoyuan&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_3114978_qe0b39no76.css">
    <noscript><meta http-equiv="refresh" content="0; url=/noscript.html"><style>.theme-vdoing-content { display:none }</style></noscript>
    <script src="https://cdn.jsdelivr.net/npm/twikoo@1.6.41/dist/twikoo.all.min.js"></script>
    <script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?720c7013e4bdca4370c380ffa206fbd7";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script>
    <meta name="description" content="Somnus Haoyuan个人博客, VuePress搭建, 使用了 Vdoing 主题, 学习Java, AI大模型等相关知识, 记录生活和技术路程, 同时分享编程技巧。">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="keywords" content="Web个人学习博客，学习是一件快乐的事情。">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.6aa5acdd.css" as="style"><link rel="preload" href="/assets/js/app.40d6eb57.js" as="script"><link rel="preload" href="/assets/js/2.84f16386.js" as="script"><link rel="preload" href="/assets/js/373.4a798498.js" as="script"><link rel="preload" href="/assets/js/15.107d5767.js" as="script"><link rel="preload" href="/assets/js/5.1ffba6c1.js" as="script"><link rel="preload" href="/assets/js/9.dba8a9bf.js" as="script"><link rel="preload" href="/assets/js/12.3f1ed9aa.js" as="script"><link rel="prefetch" href="/assets/js/10.2faf032d.js"><link rel="prefetch" href="/assets/js/100.20bf2323.js"><link rel="prefetch" href="/assets/js/101.58e9195d.js"><link rel="prefetch" href="/assets/js/102.934f4e2d.js"><link rel="prefetch" href="/assets/js/103.2e1edf2f.js"><link rel="prefetch" href="/assets/js/104.f11cb866.js"><link rel="prefetch" href="/assets/js/105.f031400c.js"><link rel="prefetch" href="/assets/js/106.8c306f6f.js"><link rel="prefetch" href="/assets/js/107.4cbb12e2.js"><link rel="prefetch" href="/assets/js/108.013594b5.js"><link rel="prefetch" href="/assets/js/109.855fb1f7.js"><link rel="prefetch" href="/assets/js/11.8d4c884c.js"><link rel="prefetch" href="/assets/js/110.169f17cd.js"><link rel="prefetch" href="/assets/js/111.f3bffe9c.js"><link rel="prefetch" href="/assets/js/112.b05741ea.js"><link rel="prefetch" href="/assets/js/113.c4ea6307.js"><link rel="prefetch" href="/assets/js/114.70c200f9.js"><link rel="prefetch" href="/assets/js/115.10d6bcd7.js"><link rel="prefetch" href="/assets/js/116.0929f9ea.js"><link rel="prefetch" href="/assets/js/117.61aa7090.js"><link rel="prefetch" href="/assets/js/118.eccb075c.js"><link rel="prefetch" href="/assets/js/119.fef47816.js"><link rel="prefetch" href="/assets/js/120.372cb96d.js"><link rel="prefetch" href="/assets/js/121.2560116c.js"><link rel="prefetch" href="/assets/js/122.726e3fde.js"><link rel="prefetch" href="/assets/js/123.6de6a113.js"><link rel="prefetch" href="/assets/js/124.d52d8b46.js"><link rel="prefetch" href="/assets/js/125.409b7367.js"><link rel="prefetch" href="/assets/js/126.c4e734c2.js"><link rel="prefetch" href="/assets/js/127.13e37428.js"><link rel="prefetch" href="/assets/js/128.f035adf7.js"><link rel="prefetch" href="/assets/js/129.fefb2424.js"><link rel="prefetch" href="/assets/js/13.06f0d806.js"><link rel="prefetch" href="/assets/js/130.bb7d196c.js"><link rel="prefetch" href="/assets/js/131.7850d655.js"><link rel="prefetch" href="/assets/js/132.1009bf67.js"><link rel="prefetch" href="/assets/js/133.a61ca829.js"><link rel="prefetch" href="/assets/js/134.83670718.js"><link rel="prefetch" href="/assets/js/135.476146e2.js"><link rel="prefetch" href="/assets/js/136.1593b8d9.js"><link rel="prefetch" href="/assets/js/137.9bc3b9a4.js"><link rel="prefetch" href="/assets/js/138.05c298a8.js"><link rel="prefetch" href="/assets/js/139.baa0f361.js"><link rel="prefetch" href="/assets/js/14.e8a14911.js"><link rel="prefetch" href="/assets/js/140.f7a1498f.js"><link rel="prefetch" href="/assets/js/141.d1117262.js"><link rel="prefetch" href="/assets/js/142.b990b892.js"><link rel="prefetch" href="/assets/js/143.3e0e3d6c.js"><link rel="prefetch" href="/assets/js/144.3c99f5d1.js"><link rel="prefetch" href="/assets/js/145.9efc9743.js"><link rel="prefetch" href="/assets/js/146.1b85bb65.js"><link rel="prefetch" href="/assets/js/147.552bbe6f.js"><link rel="prefetch" href="/assets/js/148.38c079c9.js"><link rel="prefetch" href="/assets/js/149.8a32fdf3.js"><link rel="prefetch" href="/assets/js/150.d73e6d70.js"><link rel="prefetch" href="/assets/js/151.139e669e.js"><link rel="prefetch" href="/assets/js/152.6fe2e61f.js"><link rel="prefetch" href="/assets/js/153.e88f4410.js"><link rel="prefetch" href="/assets/js/154.143abe60.js"><link rel="prefetch" href="/assets/js/155.35c81a23.js"><link rel="prefetch" href="/assets/js/156.f0e2d6ad.js"><link rel="prefetch" href="/assets/js/157.468fb051.js"><link rel="prefetch" href="/assets/js/158.cd86d09f.js"><link rel="prefetch" href="/assets/js/159.833f916a.js"><link rel="prefetch" href="/assets/js/16.f07b2571.js"><link rel="prefetch" href="/assets/js/160.aa4c01ba.js"><link rel="prefetch" href="/assets/js/161.bbc9ee08.js"><link rel="prefetch" href="/assets/js/162.41293d9d.js"><link rel="prefetch" href="/assets/js/163.cbfb7d74.js"><link rel="prefetch" href="/assets/js/164.aad4d4b8.js"><link rel="prefetch" href="/assets/js/165.3b69b465.js"><link rel="prefetch" href="/assets/js/166.646fb23c.js"><link rel="prefetch" href="/assets/js/167.c874eb18.js"><link rel="prefetch" href="/assets/js/168.cf29dd2c.js"><link rel="prefetch" href="/assets/js/169.d10f2b80.js"><link rel="prefetch" href="/assets/js/17.84d94fc1.js"><link rel="prefetch" href="/assets/js/170.69f2f0de.js"><link rel="prefetch" href="/assets/js/171.d05e324a.js"><link rel="prefetch" href="/assets/js/172.213b6735.js"><link rel="prefetch" href="/assets/js/173.bdb037f2.js"><link rel="prefetch" href="/assets/js/174.90dd7a19.js"><link rel="prefetch" href="/assets/js/175.65e79e89.js"><link rel="prefetch" href="/assets/js/176.6e21166e.js"><link rel="prefetch" href="/assets/js/177.efb7d4d2.js"><link rel="prefetch" href="/assets/js/178.2500c230.js"><link rel="prefetch" href="/assets/js/179.9d6c29aa.js"><link rel="prefetch" href="/assets/js/18.bb0be2bd.js"><link rel="prefetch" href="/assets/js/180.8935ec8e.js"><link rel="prefetch" href="/assets/js/181.0ba3667a.js"><link rel="prefetch" href="/assets/js/182.1527192a.js"><link rel="prefetch" href="/assets/js/183.e32e0b1a.js"><link rel="prefetch" href="/assets/js/184.f16730e1.js"><link rel="prefetch" href="/assets/js/185.6817fe7e.js"><link rel="prefetch" href="/assets/js/186.06f91832.js"><link rel="prefetch" href="/assets/js/187.b2e68c56.js"><link rel="prefetch" href="/assets/js/188.c459a7b2.js"><link rel="prefetch" href="/assets/js/189.c5dc9c9a.js"><link rel="prefetch" href="/assets/js/19.babf254d.js"><link rel="prefetch" href="/assets/js/190.539ad7b9.js"><link rel="prefetch" href="/assets/js/191.d4fa3d3f.js"><link rel="prefetch" href="/assets/js/192.904f7b4f.js"><link rel="prefetch" href="/assets/js/193.cc14cf04.js"><link rel="prefetch" href="/assets/js/194.11881e6e.js"><link rel="prefetch" href="/assets/js/195.78172201.js"><link rel="prefetch" href="/assets/js/196.79388c52.js"><link rel="prefetch" href="/assets/js/197.93ca4c41.js"><link rel="prefetch" href="/assets/js/198.452abacb.js"><link rel="prefetch" href="/assets/js/199.6ef2d196.js"><link rel="prefetch" href="/assets/js/20.5e77ec48.js"><link rel="prefetch" href="/assets/js/200.0656fb6f.js"><link rel="prefetch" href="/assets/js/201.19f892f2.js"><link rel="prefetch" href="/assets/js/202.ece43be4.js"><link rel="prefetch" href="/assets/js/203.d5298504.js"><link rel="prefetch" href="/assets/js/204.3d2dc50d.js"><link rel="prefetch" href="/assets/js/205.d24257e6.js"><link rel="prefetch" href="/assets/js/206.bacdf227.js"><link rel="prefetch" href="/assets/js/207.6fd49f37.js"><link rel="prefetch" href="/assets/js/208.c4d1371e.js"><link rel="prefetch" href="/assets/js/209.efc2bdb7.js"><link rel="prefetch" href="/assets/js/21.b614b7ce.js"><link rel="prefetch" href="/assets/js/210.ff884ca2.js"><link rel="prefetch" href="/assets/js/211.579d567a.js"><link rel="prefetch" href="/assets/js/212.b23d9c7a.js"><link rel="prefetch" href="/assets/js/213.f972e645.js"><link rel="prefetch" href="/assets/js/214.677ab8e4.js"><link rel="prefetch" href="/assets/js/215.8317429b.js"><link rel="prefetch" href="/assets/js/216.fe793ca1.js"><link rel="prefetch" href="/assets/js/217.d15bd553.js"><link rel="prefetch" href="/assets/js/218.f2476c1a.js"><link rel="prefetch" href="/assets/js/219.5de46d42.js"><link rel="prefetch" href="/assets/js/22.e14f8d0d.js"><link rel="prefetch" href="/assets/js/220.c49bbd40.js"><link rel="prefetch" href="/assets/js/221.4004aa7d.js"><link rel="prefetch" href="/assets/js/222.5d16df13.js"><link rel="prefetch" href="/assets/js/223.cb628b00.js"><link rel="prefetch" href="/assets/js/224.a6d24d03.js"><link rel="prefetch" href="/assets/js/225.d2bacd2b.js"><link rel="prefetch" href="/assets/js/226.8d5b24c0.js"><link rel="prefetch" href="/assets/js/227.76f901fc.js"><link rel="prefetch" href="/assets/js/228.9fe5796a.js"><link rel="prefetch" href="/assets/js/229.441566ae.js"><link rel="prefetch" href="/assets/js/23.ffcd828d.js"><link rel="prefetch" href="/assets/js/230.af5be7d3.js"><link rel="prefetch" href="/assets/js/231.836eacb5.js"><link rel="prefetch" href="/assets/js/232.e71d875f.js"><link rel="prefetch" href="/assets/js/233.c0f4811a.js"><link rel="prefetch" href="/assets/js/234.393292da.js"><link rel="prefetch" href="/assets/js/235.f0410328.js"><link rel="prefetch" href="/assets/js/236.c8e24b2a.js"><link rel="prefetch" href="/assets/js/237.c7511291.js"><link rel="prefetch" href="/assets/js/238.dcf9d74f.js"><link rel="prefetch" href="/assets/js/239.89c3f7fb.js"><link rel="prefetch" href="/assets/js/24.d2488dd7.js"><link rel="prefetch" href="/assets/js/240.6a231b35.js"><link rel="prefetch" href="/assets/js/241.9518dd8b.js"><link rel="prefetch" href="/assets/js/242.49fee092.js"><link rel="prefetch" href="/assets/js/243.99b57f78.js"><link rel="prefetch" href="/assets/js/244.dffff977.js"><link rel="prefetch" href="/assets/js/245.cdcb59f8.js"><link rel="prefetch" href="/assets/js/246.ee61d776.js"><link rel="prefetch" href="/assets/js/247.03b13721.js"><link rel="prefetch" href="/assets/js/248.5a48e87f.js"><link rel="prefetch" href="/assets/js/249.cd1b3546.js"><link rel="prefetch" href="/assets/js/25.c4ac0557.js"><link rel="prefetch" href="/assets/js/250.204cda9d.js"><link rel="prefetch" href="/assets/js/251.cf5a43ea.js"><link rel="prefetch" href="/assets/js/252.e87cba9e.js"><link rel="prefetch" href="/assets/js/253.31cd4b77.js"><link rel="prefetch" href="/assets/js/254.bc198d0d.js"><link rel="prefetch" href="/assets/js/255.555f461c.js"><link rel="prefetch" href="/assets/js/256.35549c82.js"><link rel="prefetch" href="/assets/js/257.eb8b7f14.js"><link rel="prefetch" href="/assets/js/258.079163a3.js"><link rel="prefetch" href="/assets/js/259.855bf637.js"><link rel="prefetch" href="/assets/js/26.bbaa3da7.js"><link rel="prefetch" href="/assets/js/260.8dbdaa34.js"><link rel="prefetch" href="/assets/js/261.3a3a3d48.js"><link rel="prefetch" href="/assets/js/262.ff4335e2.js"><link rel="prefetch" href="/assets/js/263.4e2cc7b6.js"><link rel="prefetch" href="/assets/js/264.8bf179e4.js"><link rel="prefetch" href="/assets/js/265.a0d8d94a.js"><link rel="prefetch" href="/assets/js/266.c7cb4303.js"><link rel="prefetch" href="/assets/js/267.cd833024.js"><link rel="prefetch" href="/assets/js/268.18023bf7.js"><link rel="prefetch" href="/assets/js/269.d698565e.js"><link rel="prefetch" href="/assets/js/27.cbc4cccc.js"><link rel="prefetch" href="/assets/js/270.4f42ac21.js"><link rel="prefetch" href="/assets/js/271.01513156.js"><link rel="prefetch" href="/assets/js/272.89b02542.js"><link rel="prefetch" href="/assets/js/273.d97ca2b8.js"><link rel="prefetch" href="/assets/js/274.2d44453c.js"><link rel="prefetch" href="/assets/js/275.0454b122.js"><link rel="prefetch" href="/assets/js/276.2a798428.js"><link rel="prefetch" href="/assets/js/277.1b773039.js"><link rel="prefetch" href="/assets/js/278.85318522.js"><link rel="prefetch" href="/assets/js/279.0b9b7dd0.js"><link rel="prefetch" href="/assets/js/28.2811fe35.js"><link rel="prefetch" href="/assets/js/280.34d99bb9.js"><link rel="prefetch" href="/assets/js/281.50efe138.js"><link rel="prefetch" href="/assets/js/282.730115fe.js"><link rel="prefetch" href="/assets/js/283.51e62999.js"><link rel="prefetch" href="/assets/js/284.a366d7e9.js"><link rel="prefetch" href="/assets/js/285.9f0bb34b.js"><link rel="prefetch" href="/assets/js/286.723a14e7.js"><link rel="prefetch" href="/assets/js/287.787b390a.js"><link rel="prefetch" href="/assets/js/288.3eab7c63.js"><link rel="prefetch" href="/assets/js/289.eb4897c8.js"><link rel="prefetch" href="/assets/js/29.553c7a36.js"><link rel="prefetch" href="/assets/js/290.3f12b330.js"><link rel="prefetch" href="/assets/js/291.aecfc068.js"><link rel="prefetch" href="/assets/js/292.cf2ea18c.js"><link rel="prefetch" href="/assets/js/293.a7576751.js"><link rel="prefetch" href="/assets/js/294.59a2ea07.js"><link rel="prefetch" href="/assets/js/295.21aafb3b.js"><link rel="prefetch" href="/assets/js/296.9d03ef74.js"><link rel="prefetch" href="/assets/js/297.e5333eaa.js"><link rel="prefetch" href="/assets/js/298.6b331403.js"><link rel="prefetch" href="/assets/js/299.aed7fe75.js"><link rel="prefetch" href="/assets/js/3.91d9010e.js"><link rel="prefetch" href="/assets/js/30.f752542d.js"><link rel="prefetch" href="/assets/js/300.4b43249a.js"><link rel="prefetch" href="/assets/js/301.8a2d29aa.js"><link rel="prefetch" href="/assets/js/302.2ebd826a.js"><link rel="prefetch" href="/assets/js/303.4bf03f68.js"><link rel="prefetch" href="/assets/js/304.842e0021.js"><link rel="prefetch" href="/assets/js/305.0689927e.js"><link rel="prefetch" href="/assets/js/306.9fe73451.js"><link rel="prefetch" href="/assets/js/307.d6dfc95b.js"><link rel="prefetch" href="/assets/js/308.f6b5fa22.js"><link rel="prefetch" href="/assets/js/309.f0a9e8bf.js"><link rel="prefetch" href="/assets/js/31.efc35430.js"><link rel="prefetch" href="/assets/js/310.b6a97346.js"><link rel="prefetch" href="/assets/js/311.e09ede20.js"><link rel="prefetch" href="/assets/js/312.9ede7559.js"><link rel="prefetch" href="/assets/js/313.70d997db.js"><link rel="prefetch" href="/assets/js/314.8f1cb40a.js"><link rel="prefetch" href="/assets/js/315.3dcbc212.js"><link rel="prefetch" href="/assets/js/316.503dd0d9.js"><link rel="prefetch" href="/assets/js/317.a2628cdc.js"><link rel="prefetch" href="/assets/js/318.79498962.js"><link rel="prefetch" href="/assets/js/319.6383a4d8.js"><link rel="prefetch" href="/assets/js/32.2e7f0ecf.js"><link rel="prefetch" href="/assets/js/320.df7b195d.js"><link rel="prefetch" href="/assets/js/321.a3a665d5.js"><link rel="prefetch" href="/assets/js/322.5f4bb853.js"><link rel="prefetch" href="/assets/js/323.08fc2754.js"><link rel="prefetch" href="/assets/js/324.2ee64ecf.js"><link rel="prefetch" href="/assets/js/325.0645a604.js"><link rel="prefetch" href="/assets/js/326.510326c5.js"><link rel="prefetch" href="/assets/js/327.58ead103.js"><link rel="prefetch" href="/assets/js/328.9c763bc9.js"><link rel="prefetch" href="/assets/js/329.8d27c776.js"><link rel="prefetch" href="/assets/js/33.0fb3ddd2.js"><link rel="prefetch" href="/assets/js/330.4b69506d.js"><link rel="prefetch" href="/assets/js/331.f4e9123c.js"><link rel="prefetch" href="/assets/js/332.decc5f74.js"><link rel="prefetch" href="/assets/js/333.e729cfe0.js"><link rel="prefetch" href="/assets/js/334.a6d25832.js"><link rel="prefetch" href="/assets/js/335.863ce340.js"><link rel="prefetch" href="/assets/js/336.e1fdfcce.js"><link rel="prefetch" href="/assets/js/337.7ec69ad4.js"><link rel="prefetch" href="/assets/js/338.6279e3b4.js"><link rel="prefetch" href="/assets/js/339.9b23235d.js"><link rel="prefetch" href="/assets/js/34.19748377.js"><link rel="prefetch" href="/assets/js/340.7b6c78dc.js"><link rel="prefetch" href="/assets/js/341.1e4bac65.js"><link rel="prefetch" href="/assets/js/342.b79997de.js"><link rel="prefetch" href="/assets/js/343.db33f886.js"><link rel="prefetch" href="/assets/js/344.13b20d62.js"><link rel="prefetch" href="/assets/js/345.c334203e.js"><link rel="prefetch" href="/assets/js/346.536c03d6.js"><link rel="prefetch" href="/assets/js/347.2184fbfa.js"><link rel="prefetch" href="/assets/js/348.57ccabdc.js"><link rel="prefetch" href="/assets/js/349.99b549fc.js"><link rel="prefetch" href="/assets/js/35.80d3df6e.js"><link rel="prefetch" href="/assets/js/350.a46457f1.js"><link rel="prefetch" href="/assets/js/351.9da55b6a.js"><link rel="prefetch" href="/assets/js/352.f3798216.js"><link rel="prefetch" href="/assets/js/353.f7b95ddb.js"><link rel="prefetch" href="/assets/js/354.436f104a.js"><link rel="prefetch" href="/assets/js/355.8951e7a3.js"><link rel="prefetch" href="/assets/js/356.d2f3e4eb.js"><link rel="prefetch" href="/assets/js/357.c14203c7.js"><link rel="prefetch" href="/assets/js/358.299282e3.js"><link rel="prefetch" href="/assets/js/359.c9bed611.js"><link rel="prefetch" href="/assets/js/36.1013dc0b.js"><link rel="prefetch" href="/assets/js/360.ccfb13a8.js"><link rel="prefetch" href="/assets/js/361.05ec179c.js"><link rel="prefetch" href="/assets/js/362.427072fc.js"><link rel="prefetch" href="/assets/js/363.0ee122f9.js"><link rel="prefetch" href="/assets/js/364.0017ecc8.js"><link rel="prefetch" href="/assets/js/365.1230ac7c.js"><link rel="prefetch" href="/assets/js/366.f6914c2e.js"><link rel="prefetch" href="/assets/js/367.9fe0341d.js"><link rel="prefetch" href="/assets/js/368.a21bf199.js"><link rel="prefetch" href="/assets/js/369.39fe53ec.js"><link rel="prefetch" href="/assets/js/37.9a45ef0a.js"><link rel="prefetch" href="/assets/js/370.e701eeda.js"><link rel="prefetch" href="/assets/js/371.b90c9d30.js"><link rel="prefetch" href="/assets/js/372.a97bf0b2.js"><link rel="prefetch" href="/assets/js/374.85ab3af8.js"><link rel="prefetch" href="/assets/js/375.43495a72.js"><link rel="prefetch" href="/assets/js/376.6b3cc970.js"><link rel="prefetch" href="/assets/js/377.03779254.js"><link rel="prefetch" href="/assets/js/378.34d40bb8.js"><link rel="prefetch" href="/assets/js/379.ca3a6942.js"><link rel="prefetch" href="/assets/js/38.d845e6b5.js"><link rel="prefetch" href="/assets/js/380.339b99c0.js"><link rel="prefetch" href="/assets/js/381.854ec26a.js"><link rel="prefetch" href="/assets/js/382.479978e6.js"><link rel="prefetch" href="/assets/js/383.01dc63bc.js"><link rel="prefetch" href="/assets/js/384.cb97ac09.js"><link rel="prefetch" href="/assets/js/385.f36cf5f6.js"><link rel="prefetch" href="/assets/js/386.7de0ab17.js"><link rel="prefetch" href="/assets/js/387.39f59b7c.js"><link rel="prefetch" href="/assets/js/388.95497a30.js"><link rel="prefetch" href="/assets/js/389.b448ed5e.js"><link rel="prefetch" href="/assets/js/39.77876eda.js"><link rel="prefetch" href="/assets/js/390.a66c4fc4.js"><link rel="prefetch" href="/assets/js/391.48062b7a.js"><link rel="prefetch" href="/assets/js/392.6e57278e.js"><link rel="prefetch" href="/assets/js/393.234e1194.js"><link rel="prefetch" href="/assets/js/394.b7d318c1.js"><link rel="prefetch" href="/assets/js/395.c164d904.js"><link rel="prefetch" href="/assets/js/396.1fc871e1.js"><link rel="prefetch" href="/assets/js/397.97aba7d4.js"><link rel="prefetch" href="/assets/js/398.f220283d.js"><link rel="prefetch" href="/assets/js/399.c59ca5b2.js"><link rel="prefetch" href="/assets/js/4.f1d08658.js"><link rel="prefetch" href="/assets/js/40.fb9333c4.js"><link rel="prefetch" href="/assets/js/400.da8d06aa.js"><link rel="prefetch" href="/assets/js/401.0d789e46.js"><link rel="prefetch" href="/assets/js/402.4de6e357.js"><link rel="prefetch" href="/assets/js/403.790f264a.js"><link rel="prefetch" href="/assets/js/404.82e81932.js"><link rel="prefetch" href="/assets/js/405.441ea069.js"><link rel="prefetch" href="/assets/js/406.bfadbb65.js"><link rel="prefetch" href="/assets/js/407.38f3a5ec.js"><link rel="prefetch" href="/assets/js/408.ecbffdd6.js"><link rel="prefetch" href="/assets/js/409.cd8ec16c.js"><link rel="prefetch" href="/assets/js/41.206dc183.js"><link rel="prefetch" href="/assets/js/410.3eae7a5b.js"><link rel="prefetch" href="/assets/js/411.4f3a7f1b.js"><link rel="prefetch" href="/assets/js/412.69bf0344.js"><link rel="prefetch" href="/assets/js/413.8c53eacf.js"><link rel="prefetch" href="/assets/js/414.d61f85f6.js"><link rel="prefetch" href="/assets/js/415.89165bcc.js"><link rel="prefetch" href="/assets/js/416.4e791dfd.js"><link rel="prefetch" href="/assets/js/417.45f0c4b2.js"><link rel="prefetch" href="/assets/js/418.48807d9c.js"><link rel="prefetch" href="/assets/js/419.4152ed23.js"><link rel="prefetch" href="/assets/js/42.15a1375e.js"><link rel="prefetch" href="/assets/js/420.96e4dc4d.js"><link rel="prefetch" href="/assets/js/421.f2aa7333.js"><link rel="prefetch" href="/assets/js/422.eb34edb8.js"><link rel="prefetch" href="/assets/js/423.c775b42f.js"><link rel="prefetch" href="/assets/js/424.585c7a0f.js"><link rel="prefetch" href="/assets/js/425.01403622.js"><link rel="prefetch" href="/assets/js/426.7755d4a2.js"><link rel="prefetch" href="/assets/js/427.9f553119.js"><link rel="prefetch" href="/assets/js/428.c8dd4f0c.js"><link rel="prefetch" href="/assets/js/429.3ed285c0.js"><link rel="prefetch" href="/assets/js/43.a03afca7.js"><link rel="prefetch" href="/assets/js/430.467c7eaa.js"><link rel="prefetch" href="/assets/js/431.3cbbe034.js"><link rel="prefetch" href="/assets/js/432.9c40e1ea.js"><link rel="prefetch" href="/assets/js/433.9add6475.js"><link rel="prefetch" href="/assets/js/434.b6cff804.js"><link rel="prefetch" href="/assets/js/435.b1fd54d5.js"><link rel="prefetch" href="/assets/js/436.dcb99738.js"><link rel="prefetch" href="/assets/js/437.9562e869.js"><link rel="prefetch" href="/assets/js/438.1b87f7a1.js"><link rel="prefetch" href="/assets/js/439.51a7f392.js"><link rel="prefetch" href="/assets/js/44.08819acf.js"><link rel="prefetch" href="/assets/js/440.ba244e0b.js"><link rel="prefetch" href="/assets/js/441.6247c292.js"><link rel="prefetch" href="/assets/js/442.317331fe.js"><link rel="prefetch" href="/assets/js/443.66412722.js"><link rel="prefetch" href="/assets/js/444.f12bd7bb.js"><link rel="prefetch" href="/assets/js/445.8dd4cba1.js"><link rel="prefetch" href="/assets/js/446.dc2f7fe1.js"><link rel="prefetch" href="/assets/js/447.4024dc6d.js"><link rel="prefetch" href="/assets/js/448.9f473a57.js"><link rel="prefetch" href="/assets/js/449.2fde71a1.js"><link rel="prefetch" href="/assets/js/45.dbfa99cc.js"><link rel="prefetch" href="/assets/js/450.caa7dbd8.js"><link rel="prefetch" href="/assets/js/451.0509ac4e.js"><link rel="prefetch" href="/assets/js/452.f4535c29.js"><link rel="prefetch" href="/assets/js/453.8feab1b9.js"><link rel="prefetch" href="/assets/js/454.b85825f2.js"><link rel="prefetch" href="/assets/js/455.8398d19c.js"><link rel="prefetch" href="/assets/js/456.b50f3dd0.js"><link rel="prefetch" href="/assets/js/457.ada86b83.js"><link rel="prefetch" href="/assets/js/458.7f24755f.js"><link rel="prefetch" href="/assets/js/459.a5e5c3eb.js"><link rel="prefetch" href="/assets/js/46.8cad9b71.js"><link rel="prefetch" href="/assets/js/460.b42f4a81.js"><link rel="prefetch" href="/assets/js/461.67f0b35b.js"><link rel="prefetch" href="/assets/js/462.1ab358db.js"><link rel="prefetch" href="/assets/js/463.0ac7350c.js"><link rel="prefetch" href="/assets/js/464.45c469a9.js"><link rel="prefetch" href="/assets/js/465.cdd85a89.js"><link rel="prefetch" href="/assets/js/466.81d406f8.js"><link rel="prefetch" href="/assets/js/467.d566f183.js"><link rel="prefetch" href="/assets/js/468.50345fae.js"><link rel="prefetch" href="/assets/js/469.1c7dbd36.js"><link rel="prefetch" href="/assets/js/47.b613df2f.js"><link rel="prefetch" href="/assets/js/470.5cfc2898.js"><link rel="prefetch" href="/assets/js/48.7dd353ac.js"><link rel="prefetch" href="/assets/js/49.c6acb8a5.js"><link rel="prefetch" href="/assets/js/50.f98e787a.js"><link rel="prefetch" href="/assets/js/51.fca7ece9.js"><link rel="prefetch" href="/assets/js/52.dfd2418a.js"><link rel="prefetch" href="/assets/js/53.0547a2da.js"><link rel="prefetch" href="/assets/js/54.77c456cb.js"><link rel="prefetch" href="/assets/js/55.2ea7947c.js"><link rel="prefetch" href="/assets/js/56.93aa6440.js"><link rel="prefetch" href="/assets/js/57.e1c7aaa6.js"><link rel="prefetch" href="/assets/js/58.5368de52.js"><link rel="prefetch" href="/assets/js/59.fb2e12ff.js"><link rel="prefetch" href="/assets/js/6.fe5e508e.js"><link rel="prefetch" href="/assets/js/60.b8e6a986.js"><link rel="prefetch" href="/assets/js/61.fe69b359.js"><link rel="prefetch" href="/assets/js/62.74e87082.js"><link rel="prefetch" href="/assets/js/63.75ce37b4.js"><link rel="prefetch" href="/assets/js/64.3b4f72ef.js"><link rel="prefetch" href="/assets/js/65.3f53a9a4.js"><link rel="prefetch" href="/assets/js/66.8403887b.js"><link rel="prefetch" href="/assets/js/67.a2a1488d.js"><link rel="prefetch" href="/assets/js/68.f1c01bf8.js"><link rel="prefetch" href="/assets/js/69.ef3591d4.js"><link rel="prefetch" href="/assets/js/7.a65affc1.js"><link rel="prefetch" href="/assets/js/70.df41328b.js"><link rel="prefetch" href="/assets/js/71.d8cd75fb.js"><link rel="prefetch" href="/assets/js/72.e781e7e1.js"><link rel="prefetch" href="/assets/js/73.aaf45776.js"><link rel="prefetch" href="/assets/js/74.2a35588a.js"><link rel="prefetch" href="/assets/js/75.e8adcf85.js"><link rel="prefetch" href="/assets/js/76.16da36dd.js"><link rel="prefetch" href="/assets/js/77.201f553d.js"><link rel="prefetch" href="/assets/js/78.bb374675.js"><link rel="prefetch" href="/assets/js/79.7b92c1ff.js"><link rel="prefetch" href="/assets/js/8.08fdf9a5.js"><link rel="prefetch" href="/assets/js/80.273f2594.js"><link rel="prefetch" href="/assets/js/81.4fbbe071.js"><link rel="prefetch" href="/assets/js/82.4d39e160.js"><link rel="prefetch" href="/assets/js/83.24e0a19d.js"><link rel="prefetch" href="/assets/js/84.0c030198.js"><link rel="prefetch" href="/assets/js/85.00fc1248.js"><link rel="prefetch" href="/assets/js/86.7bd1bf53.js"><link rel="prefetch" href="/assets/js/87.5b28d027.js"><link rel="prefetch" href="/assets/js/88.8c5037f4.js"><link rel="prefetch" href="/assets/js/89.a06dc5bd.js"><link rel="prefetch" href="/assets/js/90.2df5d8ba.js"><link rel="prefetch" href="/assets/js/91.c3326db3.js"><link rel="prefetch" href="/assets/js/92.57931d85.js"><link rel="prefetch" href="/assets/js/93.bcda9957.js"><link rel="prefetch" href="/assets/js/94.43d71792.js"><link rel="prefetch" href="/assets/js/95.65bbe7b0.js"><link rel="prefetch" href="/assets/js/96.4d8b933c.js"><link rel="prefetch" href="/assets/js/97.9ef35d1d.js"><link rel="prefetch" href="/assets/js/98.94a4172c.js"><link rel="prefetch" href="/assets/js/99.9db6ba1a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6aa5acdd.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/index/book.png" alt="Haoyuan's blog" class="logo"> <span class="site-name can-hide">Haoyuan's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/navigation/" class="nav-link">导航站</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/java/" class="link-title">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/se/" class="nav-link">Java基础</a></li><li class="dropdown-subitem"><a href="/java/collection/" class="nav-link">Java集合</a></li><li class="dropdown-subitem"><a href="/java/se/reflect/" class="nav-link">Java反射</a></li><li class="dropdown-subitem"><a href="/java/juc/" class="nav-link">JavaJUC</a></li><li class="dropdown-subitem"><a href="/java/jvm/" class="nav-link">JavaJVM</a></li></ul></li><li class="dropdown-item"><h4>Java容器</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/javaweb/concept/" class="nav-link">JavaWeb</a></li></ul></li><li class="dropdown-item"><h4>Java版本新特性</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/new-features/" class="nav-link">Java新特性</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/database/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>SQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mysql/" class="nav-link">MySQL</a></li><li class="dropdown-subitem"><a href="/oracle/" class="nav-link">Oracle</a></li></ul></li><li class="dropdown-item"><h4>NoSQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/redis/" class="nav-link">Redis</a></li><li class="dropdown-subitem"><a href="/es/" class="nav-link">ElasticSearch</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><a href="/frames/" class="link-title">框架</a> <span class="title" style="display:none;">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mybatis/" class="nav-link">MyBatis</a></li><li class="dropdown-subitem"><a href="/mybatis-plus/" class="nav-link">MyBatis-Plus</a></li></ul></li><li class="dropdown-item"><h4>消息中间件</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/activemq/" class="nav-link">ActiveMQ</a></li><li class="dropdown-subitem"><a href="/rabbitmq/" class="nav-link">RabbitMQ</a></li><li class="dropdown-subitem"><a href="/rocketmq/" class="nav-link">RocketMQ</a></li><li class="dropdown-subitem"><a href="/kafka/" class="nav-link">Kafka</a></li></ul></li><li class="dropdown-item"><h4>进阶服务</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/nginx/" class="nav-link">Nginx</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring生态" class="dropdown-title"><a href="/spring-ecology/" class="link-title">Spring生态</a> <span class="title" style="display:none;">Spring生态</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/spring/" class="nav-link">Spring</a></li><li class="dropdown-item"><!----> <a href="/spring-boot/" class="nav-link">Spring Boot</a></li><li class="dropdown-item"><!----> <a href="/spring-security/" class="nav-link">Spring Security</a></li><li class="dropdown-item"><!----> <a href="/spring-cloud/" class="nav-link">Spring Cloud</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发" class="dropdown-title"><a href="/dev-guide/" class="link-title">开发</a> <span class="title" style="display:none;">开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/design-pattern/" class="nav-link">设计模式</a></li><li class="dropdown-item"><!----> <a href="/algorithm/" class="nav-link">算法</a></li><li class="dropdown-item"><!----> <a href="/knowledge/" class="nav-link router-link-active">知识</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><a href="/tool/" class="link-title">工具</a> <span class="title" style="display:none;">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>管理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/maven/" class="nav-link">Maven</a></li><li class="dropdown-subitem"><a href="/git/" class="nav-link">Git</a></li></ul></li><li class="dropdown-item"><h4>部署</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/linux/" class="nav-link">Linux</a></li><li class="dropdown-subitem"><a href="/docker/" class="nav-link">Docker</a></li><li class="dropdown-subitem"><a href="/jenkins/" class="nav-link">Jenkins</a></li><li class="dropdown-subitem"><a href="/kubernetes/" class="nav-link">Kubernetes</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/front/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>进阶</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/typescript/" class="nav-link">TypeScript</a></li></ul></li><li class="dropdown-item"><h4>框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/react/" class="nav-link">React</a></li><li class="dropdown-subitem"><a href="/vue2/" class="nav-link">Vue2</a></li><li class="dropdown-subitem"><a href="/vue3/" class="nav-link">Vue3</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/whells-use/" class="nav-link">轮子工具</a></li><li class="dropdown-item"><!----> <a href="/projects/" class="nav-link">项目工程</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>本站</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-subitem"><a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-subitem"><a href="/archives/" class="nav-link">归档</a></li></ul></li><li class="dropdown-item"><h4>我的</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/whell/web/" class="nav-link">收藏</a></li><li class="dropdown-subitem"><a href="/about/mdskill/" class="nav-link">关于</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/message-area/" class="nav-link">留言区</a></div> <a href="https://github.com/Somnus711/Somnus711.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.jsdelivr.net/gh/Somnus711/picx-image-hosting@master/blog-pic/avatar.2b7e13idyy9s.webp"> <div class="blogger-info"><h3>Somnus Haoyuan</h3> <span>Word is cheap, show me the code.</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/navigation/" class="nav-link">导航站</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/java/" class="link-title">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/se/" class="nav-link">Java基础</a></li><li class="dropdown-subitem"><a href="/java/collection/" class="nav-link">Java集合</a></li><li class="dropdown-subitem"><a href="/java/se/reflect/" class="nav-link">Java反射</a></li><li class="dropdown-subitem"><a href="/java/juc/" class="nav-link">JavaJUC</a></li><li class="dropdown-subitem"><a href="/java/jvm/" class="nav-link">JavaJVM</a></li></ul></li><li class="dropdown-item"><h4>Java容器</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/javaweb/concept/" class="nav-link">JavaWeb</a></li></ul></li><li class="dropdown-item"><h4>Java版本新特性</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/new-features/" class="nav-link">Java新特性</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/database/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>SQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mysql/" class="nav-link">MySQL</a></li><li class="dropdown-subitem"><a href="/oracle/" class="nav-link">Oracle</a></li></ul></li><li class="dropdown-item"><h4>NoSQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/redis/" class="nav-link">Redis</a></li><li class="dropdown-subitem"><a href="/es/" class="nav-link">ElasticSearch</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><a href="/frames/" class="link-title">框架</a> <span class="title" style="display:none;">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mybatis/" class="nav-link">MyBatis</a></li><li class="dropdown-subitem"><a href="/mybatis-plus/" class="nav-link">MyBatis-Plus</a></li></ul></li><li class="dropdown-item"><h4>消息中间件</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/activemq/" class="nav-link">ActiveMQ</a></li><li class="dropdown-subitem"><a href="/rabbitmq/" class="nav-link">RabbitMQ</a></li><li class="dropdown-subitem"><a href="/rocketmq/" class="nav-link">RocketMQ</a></li><li class="dropdown-subitem"><a href="/kafka/" class="nav-link">Kafka</a></li></ul></li><li class="dropdown-item"><h4>进阶服务</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/nginx/" class="nav-link">Nginx</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring生态" class="dropdown-title"><a href="/spring-ecology/" class="link-title">Spring生态</a> <span class="title" style="display:none;">Spring生态</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/spring/" class="nav-link">Spring</a></li><li class="dropdown-item"><!----> <a href="/spring-boot/" class="nav-link">Spring Boot</a></li><li class="dropdown-item"><!----> <a href="/spring-security/" class="nav-link">Spring Security</a></li><li class="dropdown-item"><!----> <a href="/spring-cloud/" class="nav-link">Spring Cloud</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发" class="dropdown-title"><a href="/dev-guide/" class="link-title">开发</a> <span class="title" style="display:none;">开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/design-pattern/" class="nav-link">设计模式</a></li><li class="dropdown-item"><!----> <a href="/algorithm/" class="nav-link">算法</a></li><li class="dropdown-item"><!----> <a href="/knowledge/" class="nav-link router-link-active">知识</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><a href="/tool/" class="link-title">工具</a> <span class="title" style="display:none;">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>管理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/maven/" class="nav-link">Maven</a></li><li class="dropdown-subitem"><a href="/git/" class="nav-link">Git</a></li></ul></li><li class="dropdown-item"><h4>部署</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/linux/" class="nav-link">Linux</a></li><li class="dropdown-subitem"><a href="/docker/" class="nav-link">Docker</a></li><li class="dropdown-subitem"><a href="/jenkins/" class="nav-link">Jenkins</a></li><li class="dropdown-subitem"><a href="/kubernetes/" class="nav-link">Kubernetes</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/front/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>进阶</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/typescript/" class="nav-link">TypeScript</a></li></ul></li><li class="dropdown-item"><h4>框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/react/" class="nav-link">React</a></li><li class="dropdown-subitem"><a href="/vue2/" class="nav-link">Vue2</a></li><li class="dropdown-subitem"><a href="/vue3/" class="nav-link">Vue3</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/whells-use/" class="nav-link">轮子工具</a></li><li class="dropdown-item"><!----> <a href="/projects/" class="nav-link">项目工程</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>本站</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-subitem"><a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-subitem"><a href="/archives/" class="nav-link">归档</a></li></ul></li><li class="dropdown-item"><h4>我的</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/whell/web/" class="nav-link">收藏</a></li><li class="dropdown-subitem"><a href="/about/mdskill/" class="nav-link">关于</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/message-area/" class="nav-link">留言区</a></div> <a href="https://github.com/Somnus711/Somnus711.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>知识</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/object/" class="sidebar-link">知识 - 对象</a></li><li><a href="/knowledge/idempotent/" class="sidebar-link">知识 - 幂等性</a></li><li><a href="/knowledge/translation/" class="sidebar-link">知识 - 分布式事务</a></li><li><a href="/knowledge/mapstruct/" class="sidebar-link">知识 - MapStruct</a></li><li><a href="/knowledge/mapstruct-plus/" class="sidebar-link">知识 - MapStructPlus</a></li><li><a href="/knowledge/completable-future/" aria-current="page" class="active sidebar-link">知识 - CompletableFuture</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/knowledge/completable-future/#future-vs-completablefuture" class="sidebar-link">Future VS CompletableFuture</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/knowledge/completable-future/#工具类" class="sidebar-link">工具类</a></li><li class="sidebar-sub-header level3"><a href="/knowledge/completable-future/#future-局限性" class="sidebar-link">Future 局限性</a></li><li class="sidebar-sub-header level3"><a href="/knowledge/completable-future/#completablefuture-优势" class="sidebar-link">CompletableFuture 优势</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/knowledge/completable-future/#创建异步任务" class="sidebar-link">创建异步任务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/knowledge/completable-future/#runasync-方法" class="sidebar-link">runAsync 方法</a></li><li class="sidebar-sub-header level3"><a href="/knowledge/completable-future/#supplyasync-方法" class="sidebar-link">supplyAsync 方法</a></li><li class="sidebar-sub-header level3"><a href="/knowledge/completable-future/#异步任务的线程池" class="sidebar-link">异步任务的线程池</a></li><li class="sidebar-sub-header level3"><a href="/knowledge/completable-future/#异步编程思想" class="sidebar-link">异步编程思想</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/knowledge/completable-future/#任务异步回调" class="sidebar-link">任务异步回调</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/knowledge/completable-future/#thenapply-方法" class="sidebar-link">thenApply 方法</a></li><li class="sidebar-sub-header level3"><a href="/knowledge/completable-future/#thenaccept-方法" class="sidebar-link">thenAccept 方法</a></li><li class="sidebar-sub-header level3"><a href="/knowledge/completable-future/#thenrun-方法" class="sidebar-link">thenRun 方法</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/knowledge/completable-future/#异步任务编排" class="sidebar-link">异步任务编排</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/knowledge/completable-future/#thencompose-方法" class="sidebar-link">thenCompose 方法</a></li><li class="sidebar-sub-header level3"><a href="/knowledge/completable-future/#thencombine-方法" class="sidebar-link">thenCombine 方法</a></li><li class="sidebar-sub-header level3"><a href="/knowledge/completable-future/#合并多个异步任务-allof" class="sidebar-link">合并多个异步任务 allOf</a></li><li class="sidebar-sub-header level3"><a href="/knowledge/completable-future/#合并多个异步任务-anyof" class="sidebar-link">合并多个异步任务 anyOf</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/knowledge/completable-future/#异步任务的异常处理" class="sidebar-link">异步任务的异常处理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/knowledge/completable-future/#exceptionally-方法" class="sidebar-link">exceptionally 方法</a></li><li class="sidebar-sub-header level3"><a href="/knowledge/completable-future/#handle-方法" class="sidebar-link">handle 方法</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/knowledge/completable-future/#异步任务的交互" class="sidebar-link">异步任务的交互</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/knowledge/completable-future/#applytoeither-方法" class="sidebar-link">applyToEither 方法</a></li><li class="sidebar-sub-header level3"><a href="/knowledge/completable-future/#accepteither" class="sidebar-link">acceptEither</a></li><li class="sidebar-sub-header level3"><a href="/knowledge/completable-future/#runaftereither" class="sidebar-link">runAfterEither</a></li><li class="sidebar-sub-header level3"><a href="/knowledge/completable-future/#runafterboth" class="sidebar-link">runAfterBoth</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/knowledge/completable-future/#get-和-join-区别" class="sidebar-link">get 和 join 区别</a></li><li class="sidebar-sub-header level2"><a href="/knowledge/completable-future/#parallelstream-vs-completablefuture" class="sidebar-link">ParallelStream VS CompletableFuture</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/knowledge/completable-future/#并行流的局限性" class="sidebar-link">并行流的局限性</a></li><li class="sidebar-sub-header level3"><a href="/knowledge/completable-future/#completablefuture-在流式操作的优势" class="sidebar-link">CompletableFuture 在流式操作的优势</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/knowledge/completable-future/#合理配置线程池中的线程数" class="sidebar-link">合理配置线程池中的线程数</a></li><li class="sidebar-sub-header level2"><a href="/knowledge/completable-future/#大数据商品比价案例" class="sidebar-link">大数据商品比价案例</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/knowledge/completable-future/#构建工具类和实体类" class="sidebar-link">构建工具类和实体类</a></li><li class="sidebar-sub-header level3"><a href="/knowledge/completable-future/#构建-httprequest" class="sidebar-link">构建 HttpRequest</a></li><li class="sidebar-sub-header level3"><a href="/knowledge/completable-future/#操作商品比价" class="sidebar-link">操作商品比价</a></li><li class="sidebar-sub-header level3"><a href="/knowledge/completable-future/#测试" class="sidebar-link">测试</a></li><li class="sidebar-sub-header level3"><a href="/knowledge/completable-future/#stream-api-操作批量商品比价" class="sidebar-link">Stream API 操作批量商品比价</a></li></ul></li></ul></li><li><a href="/knowledge/easy-excel/" class="sidebar-link">知识 - EasyExcel</a></li><li><a href="/knowledge/encrypt/" class="sidebar-link">知识 - Encrypt</a></li><li><a href="/knowledge/interface-idempotent/" class="sidebar-link">知识 - 接口幂等性</a></li><li><a href="/knowledge/sensitive/" class="sidebar-link">知识 - 数据脱敏</a></li><li><a href="/knowledge/websocket/" class="sidebar-link">知识 - WebSocket</a></li><li><a href="/knowledge/spring-cache/" class="sidebar-link">知识 - Spring Cache</a></li><li><a href="/knowledge/request-log/" class="sidebar-link">知识 - 请求日志输出</a></li><li><a href="/knowledge/rateLimit/" class="sidebar-link">知识 - 接口限流</a></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=%E5%BC%80%E5%8F%91" title="分类" data-v-06225672>开发</a></li><li data-v-06225672><a href="/categories/?category=%E7%9F%A5%E8%AF%86" title="分类" data-v-06225672>知识</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://www.denghaoyuan.com/" target="_blank" title="作者" class="beLink" data-v-06225672>Haoyuan</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-09-16</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">知识 - CompletableFuture<!----></h1> <!----> <div class="theme-vdoing-content content__default"><p></p><div class="table-of-contents"><ul><li><a href="#future-vs-completablefuture">Future VS CompletableFuture</a><ul><li><a href="#工具类">工具类</a></li><li><a href="#future-局限性">Future 局限性</a></li><li><a href="#completablefuture-优势">CompletableFuture 优势</a></li></ul></li><li><a href="#创建异步任务">创建异步任务</a><ul><li><a href="#runasync-方法">runAsync 方法</a></li><li><a href="#supplyasync-方法">supplyAsync 方法</a></li><li><a href="#异步任务的线程池">异步任务的线程池</a></li><li><a href="#异步编程思想">异步编程思想</a></li></ul></li><li><a href="#任务异步回调">任务异步回调</a><ul><li><a href="#thenapply-方法">thenApply 方法</a></li><li><a href="#thenaccept-方法">thenAccept 方法</a></li><li><a href="#thenrun-方法">thenRun 方法</a></li></ul></li><li><a href="#异步任务编排">异步任务编排</a><ul><li><a href="#thencompose-方法">thenCompose 方法</a></li><li><a href="#thencombine-方法">thenCombine 方法</a></li><li><a href="#合并多个异步任务-allof">合并多个异步任务 allOf</a></li><li><a href="#合并多个异步任务-anyof">合并多个异步任务 anyOf</a></li></ul></li><li><a href="#异步任务的异常处理">异步任务的异常处理</a><ul><li><a href="#exceptionally-方法">exceptionally 方法</a></li><li><a href="#handle-方法">handle 方法</a></li></ul></li><li><a href="#异步任务的交互">异步任务的交互</a><ul><li><a href="#applytoeither-方法">applyToEither 方法</a></li><li><a href="#accepteither">acceptEither</a></li><li><a href="#runaftereither">runAfterEither</a></li><li><a href="#runafterboth">runAfterBoth</a></li></ul></li><li><a href="#get-和-join-区别">get 和 join 区别</a></li><li><a href="#parallelstream-vs-completablefuture">ParallelStream VS CompletableFuture</a><ul><li><a href="#并行流的局限性">并行流的局限性</a></li><li><a href="#completablefuture-在流式操作的优势">CompletableFuture 在流式操作的优势</a></li></ul></li><li><a href="#合理配置线程池中的线程数">合理配置线程池中的线程数</a></li><li><a href="#大数据商品比价案例">大数据商品比价案例</a><ul><li><a href="#构建工具类和实体类">构建工具类和实体类</a></li><li><a href="#构建-httprequest">构建 HttpRequest</a></li><li><a href="#操作商品比价">操作商品比价</a></li><li><a href="#测试">测试</a></li><li><a href="#stream-api-操作批量商品比价">Stream API 操作批量商品比价</a></li></ul></li></ul></div><p></p> <h2 id="future-vs-completablefuture"><a href="#future-vs-completablefuture" class="header-anchor">#</a> Future VS CompletableFuture</h2> <h3 id="工具类"><a href="#工具类" class="header-anchor">#</a> 工具类</h3> <p>为了便于后续更好地调试和学习，我们需要定义一个工具类辅助我们对知识的理解。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommonUtils</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 根据指定路径读取文件内容
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> pathToFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">readAllBytes</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pathToFile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 睡眠都是毫秒
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sleepMillis</span><span class="token punctuation">(</span><span class="token keyword">long</span> millis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MICROSECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>millis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 睡眠都是秒
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sleepSeconds</span><span class="token punctuation">(</span><span class="token keyword">long</span> seconds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>seconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">LocalTime</span> now <span class="token operator">=</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> now<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">&quot;[HH:mm:ss.SSS]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 打印日志信息
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 时间戳 | 线程 ID、 线程名 | 日志信息</span>
        <span class="token class-name">StringJoiner</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringJoiner</span><span class="token punctuation">(</span><span class="token string">&quot; | &quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%2d&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><h3 id="future-局限性"><a href="#future-局限性" class="header-anchor">#</a> Future 局限性</h3> <p>需求: 替换新闻稿 <code>news.txt</code> 中敏感词汇，把敏感词汇替换成 <code>*</code>，敏感词存储在 <code>filter-words.txt</code> 中。</p> <p>我们在和 <code>pom.xml</code> 同级的目录下创建这两个文件。</p> <p><code>news.txt</code> 文件：</p> <div class="language-txt line-numbers-mode"><pre class="language-txt"><code>oh my god! CompletableFuture 真 TM 好用！
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>filter-words.txt</code> 文件：</p> <div class="language-txt line-numbers-mode"><pre class="language-txt"><code>TM
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后创建一个 Demo，测试 Future 的使用：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FutureDemo</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadPoolExecutor</span> threadPoolExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>AbortPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1：读取敏感词汇</span>
        <span class="token class-name">Future</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> filterWordFuture <span class="token operator">=</span> threadPoolExecutor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&quot;filter-words.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> content<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2：读取新闻稿</span>
        <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> newFuture <span class="token operator">=</span> threadPoolExecutor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&quot;news.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3：替换操作</span>
        <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> replaceFuture <span class="token operator">=</span> threadPoolExecutor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> words <span class="token operator">=</span> filterWordFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> news <span class="token operator">=</span> newFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> word <span class="token operator">:</span> words<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>news<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    news <span class="token operator">=</span> news<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> <span class="token string">&quot;**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> news<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4：打印替换后的新闻稿 </span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span>replaceFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">17</span><span class="token operator">:</span><span class="token number">13</span><span class="token operator">:</span><span class="token number">28.046</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> oh my god<span class="token operator">!</span> <span class="token class-name">CompletableFuture</span> 真 <span class="token operator">*</span><span class="token operator">*</span> 好用！
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>通过上面的代码，我们会发现，Future 相比于所有任务都直接在主线程处理，有很多优势，但同时也存在不足至少表现如下:</p> <ul><li><strong>在没有阻塞的情况下，无法对 Future 的结果执行进一步的操作</strong>。Future 不会告知你它什么时候完成，你如果想要得到结果，必须通过一个 <code>get()</code> 方法，该方法会阻塞直到结果可用为止。它不具备将回调函数附加到 Future 后并在 Future 的结果可用时自动调用回调的能力</li> <li><strong>无法解决任务相互依赖的问题</strong>。<code>filterWordFuture</code> 和 <code>newFuture</code> 的结果不能自动发送给 <code>replaceFuture</code>，需要在 <code>replaceFuture</code> 中手动获取，所以使用 Future 不能轻而易举地创建异步工作流</li> <li><strong>不能将多个 Future 合并在一起</strong>。假设你有多种不同的 Future，你想在它们全部并行完成后然后再运行某个函数，Future 很难独立完成这一需要</li> <li><strong>没有异常处理</strong>。Future 提供的方法中没有专门的 API 应对异常处理，还是需要开发者自己手动异常处理</li></ul> <h3 id="completablefuture-优势"><a href="#completablefuture-优势" class="header-anchor">#</a> CompletableFuture 优势</h3> <p><code>CompletableFuture</code> 实现了 <code>Future</code> 和 <code>CompletionStage</code> 接口</p> <p>CompletableFuture 相对于 Future 具有以下优势:</p> <ul><li>为快速创建、链接依赖和组合多个 Future 提供了大量的便利方法</li> <li>提供了适用于各种开发场景的回调函数，它还提供了非常全面的异常处理支持</li> <li>无缝衔接和亲和 Lambda 表达式和 <code>Stream - API</code></li> <li>我见过的真正意义上的异步编程，把异步编程和函数式编程、响应式编程多种高阶编程思维集于一身，设计上更优雅</li></ul> <h2 id="创建异步任务"><a href="#创建异步任务" class="header-anchor">#</a> 创建异步任务</h2> <h3 id="runasync-方法"><a href="#runasync-方法" class="header-anchor">#</a> runAsync 方法</h3> <p>如果你要异步运行某些耗时的后台任务，并且不想从任务中返回任何内容，则可以使用 <code>CompletableFuture.runAsync()</code> 方法。它接受一个 Runnable 接口的实现类对象，方法返回 <code>CompletableFuture&lt;Void&gt;</code> 对象。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> runnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>演示案例: 创建一个不从任务中返回任何内容的 CompletableFuture 异步任务对象</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RunAsyncDemo1</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// runAsync 启动异步任务</span>
        <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;读取文件开始&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 通过睡眠来模拟一个长时间的工作任务（例如读取文件、网络请求等）</span>
                <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">sleepSeconds</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;读取文件结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;这里阻塞，main continue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 等待 CompletableFuture.runAsync 执行完成，否则主线程结束后，异步任务自动销毁</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">sleepSeconds</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * CompletableFuture 中的异步任务底层通过开启线程的方式完成的
         */</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">17</span><span class="token operator">:</span><span class="token number">13</span><span class="token operator">:</span><span class="token number">46.028</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> main start
<span class="token number">17</span><span class="token operator">:</span><span class="token number">13</span><span class="token operator">:</span><span class="token number">46.044</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> 这里阻塞，main <span class="token keyword">continue</span>
<span class="token number">17</span><span class="token operator">:</span><span class="token number">13</span><span class="token operator">:</span><span class="token number">46.044</span> <span class="token operator">|</span> <span class="token number">20</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> 读取文件开始
<span class="token number">17</span><span class="token operator">:</span><span class="token number">13</span><span class="token operator">:</span><span class="token number">49.051</span> <span class="token operator">|</span> <span class="token number">20</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> 读取文件结束
<span class="token number">17</span><span class="token operator">:</span><span class="token number">13</span><span class="token operator">:</span><span class="token number">50.062</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> main end
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>我们也可以以 Lambda 表达式的形式传递 Runnable 接口实现类对象</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RunAsyncDemo1</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// runAsync 启动异步任务</span>
        <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;读取文件开始&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 通过睡眠来模拟一个长时间的工作任务（例如读取文件、网络请求等）</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">sleepSeconds</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;读取文件结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;这里阻塞，main continue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 等待 CompletableFuture.runAsync 执行完成，否则主线程结束后，异步任务自动销毁</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">sleepSeconds</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * CompletableFuture 中的异步任务底层通过开启线程的方式完成的
         */</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>需求：使用 CompletableFuture 开启异步任务读取 <code>news.txt</code> 文件中的新闻稿，并打印输出</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RunAsyncDemo2</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// runAsync 启动异步任务</span>
        <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;读取文件开始&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&quot;news.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;读取内容：&quot;</span> <span class="token operator">+</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;读取文件结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;这里阻塞，main continue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 等待 CompletableFuture.runAsync 执行完成，否则主线程结束后，异步任务自动销毁</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">sleepSeconds</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * 疑问：异步任务是并发执行还是并行执行？
         * 如果是单核 CPU，那么异常任务之间就是并发指向性，如果是多核 CPU，异步任务就是并行执行
         * 作为开发者，我们只需要清楚如何开启异步任务，CPU 硬件会把异步任务合理的分配给 CPU 上的核运行。
         */</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>Lambda 表达式会经常被使用。</p> <p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">17</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">07.771</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> main start
<span class="token number">17</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">07.786</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> 这里阻塞，main <span class="token keyword">continue</span>
<span class="token number">17</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">07.786</span> <span class="token operator">|</span> <span class="token number">20</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> 读取文件开始
<span class="token number">17</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">07.793</span> <span class="token operator">|</span> <span class="token number">20</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> 读取内容：oh my god<span class="token operator">!</span> <span class="token class-name">CompletableFuture</span> 真 <span class="token constant">TM</span> 好用！
<span class="token number">17</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">07.793</span> <span class="token operator">|</span> <span class="token number">20</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> 读取文件结束
<span class="token number">17</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">11.797</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> main end
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="supplyasync-方法"><a href="#supplyasync-方法" class="header-anchor">#</a> supplyAsync 方法</h3> <p><code>CompletableFuture.runAsync</code> 开启不带返回结果异步任务。但是，如果您想从后台的异步任务中返回一个结果怎么办？此时 <code>CompletableFuture.supplyAsync()</code> 是你最好的选择了。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> <span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> supplier<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>它入参一个 <code>Supplier&lt;U&gt;</code> 供给者，用于供给带返回值的异步任务并返回 <code>CompletableFuture&lt;U&gt;</code>，其中 <code>U</code> 是供给者给程序供给值的类型。</p> <p>需求: 开启异步任务读取 <code>news.txt</code> 文件中的新闻稿，返回文件中内容并在主线程打印输出。</p> <p>我们使用 Java8 的 Lambda 表达式使代码更简洁。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SupplyAsyncDemo1</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// supplyAsync 启动异步任务</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> newsFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&quot;news.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;这里阻塞，main continue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>newsFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">17</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">33.751</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> main start
<span class="token number">17</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">33.769</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> 这里阻塞，main <span class="token keyword">continue</span>
oh my god<span class="token operator">!</span> <span class="token class-name">CompletableFuture</span> 真 <span class="token constant">TM</span> 好用！
<span class="token number">17</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">33.774</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> main end
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>如果想要获取 <code>newsFuture</code> 结果，可以调用 <code>CompletableFuture.get()</code> 方法，<code>get</code> 方法将阻塞，直到 <code>newsFuture</code> 完成。</p> <h3 id="异步任务的线程池"><a href="#异步任务的线程池" class="header-anchor">#</a> 异步任务的线程池</h3> <p>大家已经知道，<code>runAsync()</code> 和 <code>supplyAsync()</code> 方法都是开启单独的线程中执行异步任务。但是，我们从未创建线程对吗？不是吗！</p> <p>CompletableFuture 会从全局的 <code>ForkJoinPool.commonPool()</code> 线程池获取线程来执行这些任务。</p> <p>当然，你也可以创建一个线程池，并将其传递给 <code>runAsync()</code> 和 <code>supplyAsync()</code> 方法，以使它们在从您指定的线程池获得的线程中执行任务。</p> <p>CompletableFuture API 中的所有方法都有两种变体，一种是接受传入的 Executor 参数作为指定的线程池，而另一种则使用默认的线程池  (<code>ForkJoinPool.commonPool()</code>)。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// runAsync() 的重载方法</span>
<span class="token keyword">static</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> runnabTe<span class="token punctuation">)</span>
<span class="token keyword">static</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> runnable<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">)</span>
  
<span class="token comment">// supplyAsync() 的重载方法</span>
<span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> <span class="token function">supplyAsync</span><span class="token punctuation">(</span>supplier<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> supplier<span class="token punctuation">)</span>
<span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> <span class="token function">supplyAsync</span><span class="token punctuation">(</span>supplier<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> supplier<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>需求: 指定线程池，开启异步任务读取 <code>news.txt</code> 中的新闻，返回文件中内容并在主线程打印输出</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ExecutorService</span> executor <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> newsFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;异步读取文件开始&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> news <span class="token operator">=</span> <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&quot;news.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;异步读取文件完成&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> news<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p>最佳实践: 创建属于自己的业务线程池</p> <p>如果所有 CompletableFuture 共享一个线程池，那么一旦有异步任务执行一些很慢的 I/O 操作，就会导致线程池中所有线程都阻塞在 I/O 操作上，从而造成线程饥饿，进而影响整个系统的性能。</p> <p>所以，强烈建议你要根据不同的业务类型创建不同的线程池，以避免互相千扰。</p></blockquote> <h3 id="异步编程思想"><a href="#异步编程思想" class="header-anchor">#</a> 异步编程思想</h3> <p>综合上述，看到了吧，我们没有显式地创建线程，更没有涉及线程通信的概念，整个过程根本就没涉及线程知识吧，以上专业的说法是: <strong>线程的创建和线程负责的任务进行解耦，它给我们带来的好处线程的创建和启动全部交给线程池负责，具体任务的编写就交给程序员，专人专事</strong>。</p> <p>异步编程是可以让程序并行（也可能是并发）运行的一种手段，其可以让程序中的一个工作单元作为异步任务与主线程分开独立运行，并且在异步任务运行结束后，会通知主线程它的运行结果或者失败原因，毫无疑问，一个异步任务其实就是开启一个线程来完成的，使用异步编程可以提高应用程序的性能和响应能力等。</p> <p>作为开发者，只需要有一个意识:</p> <p>开发者只需要把耗时的操作交给 CompletableFuture 开启一个异步任务，然后继续关注主线程业务，当异步任务运行完成时会通知主线程它的运行结果。我们把具备了这种编程思想的开发称为 <strong>异步编程思想</strong>。</p> <h2 id="任务异步回调"><a href="#任务异步回调" class="header-anchor">#</a> 任务异步回调</h2> <p><code>CompletableFuture.get()</code> 方法是阻塞的。调用时它会阻塞等待直到这个 Future 完成，并在完成后返回结果。但是，很多时候这不是我们想要的，对于构建异步系统，我们应该能够将回调附加到 CompletableFuture 上，当这个 Future 完成时，该回调应自动被调用。这样，我们就不必等待结果了，我们可以在 Future 的回调函数内部编写完成 Future 之后需要执行的逻辑。您可以使用 <code>thenApply()</code>、<code>thenAccept()</code> 和 <code>thenRun()</code> 方法将回调函数附到 CompletableFuture。</p> <h3 id="thenapply-方法"><a href="#thenapply-方法" class="header-anchor">#</a> thenApply 方法</h3> <p>使用 <code>thenApply()</code> 方法可以处理和转换 CompletableFuture 的结果。它以 <code>Funtion&lt;T，R&gt;</code> 作为参数。<code>Function&lt;T，R&gt;</code> 是一个函数式接口，表示一个转换操作，它接受类型 T 的参数并产生类型 R 的结果。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">thenApply</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> fn<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>需求:异步读取 <code>filter_words.txt</code> 文件中的内容，读取完成后，把内容转换成数组（敏感词数组），异步任务返回敏感词数组</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThenApplyDemo1</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> readFilesFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;读取 filter-words 文件&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&quot;filter-words.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CompletableFuture</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> filterWordsFuture <span class="token operator">=</span> readFilesFuture<span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>content <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;文件内容转换成敏感数组&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> content<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main continue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>filterWordsFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">17</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">02.575</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> main start
<span class="token number">17</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">02.592</span> <span class="token operator">|</span> <span class="token number">20</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> 读取 filter<span class="token operator">-</span>words 文件
<span class="token number">17</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">02.592</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> main <span class="token keyword">continue</span>
<span class="token number">17</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">02.596</span> <span class="token operator">|</span> <span class="token number">20</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> 文件内容转换成敏感数组
<span class="token number">17</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">02.597</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token constant">TM</span><span class="token punctuation">]</span>
<span class="token number">17</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">02.597</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> main end
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>你还可以通过附加一系列 <code>thenApply()</code> 回调方法，在 CompletableFuture 上编写一系列转换序列。一个 <code>thenApply()</code> 方法的结果可以传递给序列中的下一个，如果你对链式操作很了解，你会发现结果可以在链式操作上传递。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThenApplyDemo2</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">CompletableFuture</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> filterWordsFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;读取 filter-words 文件&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&quot;filter-words.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>content <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;文件内容转换成敏感数组&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> content<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main continue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>filterWordsFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>输出结果一样。</p> <h3 id="thenaccept-方法"><a href="#thenaccept-方法" class="header-anchor">#</a> thenAccept 方法</h3> <p>如果你不想从回调函数返回结果，而只想在 Future 完成后运行一些代码，则可以使用 <code>thenAccept()</code></p> <p>这些方法是入参一个 <code>Consumer&lt;T&gt;</code>，它可以对异步任务的执行结果进行消费使用，方法返回 <code>CompletableFuture&lt;Void&gt;</code>。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">thenAccept</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> action）
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>通常用作回调链中的最后一个回调。</p> <p>需求:异步读取 <code>filter-words.txt</code> 文件中的内容，读取完成后，转换成敏感词数组，然后打印敏感词数组</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThenAcceptDemo1</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;读取 filter-words 文件&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&quot;filter-words.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>content <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;文件内容转换成敏感数组&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> content<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenAccept</span><span class="token punctuation">(</span>content <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main continue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">sleepSeconds</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">17</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">37.951</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> main start
<span class="token number">17</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">37.970</span> <span class="token operator">|</span> <span class="token number">20</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> 读取 filter<span class="token operator">-</span>words 文件
<span class="token number">17</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">37.971</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> main <span class="token keyword">continue</span>
<span class="token number">17</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">37.974</span> <span class="token operator">|</span> <span class="token number">20</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> 文件内容转换成敏感数组
<span class="token number">17</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">37.974</span> <span class="token operator">|</span> <span class="token number">20</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token constant">TM</span><span class="token punctuation">]</span>
<span class="token number">17</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">41.983</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> main end
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="thenrun-方法"><a href="#thenrun-方法" class="header-anchor">#</a> thenRun 方法</h3> <p>前面我们已经知道，通过 <code>thenApply(Function&lt;T,R&gt;)</code> 对链式操作中的上一个异步任务的结果进行转换，返回一个新的结果。</p> <p>通过 <code>thenAccept(Consumer&lt;T&gt;)</code> 对链式操作中上一个异步任务的结果进行消费使用，不返回新结果。</p> <p>如果我们只是想从 <code>CompletableFuture</code> 的链式操作得到一个完成的通知，甚至都不使用上一步链式操作的结果，那么 <code>CompletableFuture.thenRun()</code> 会是你最佳的选择，它需要一个 Runnable 并返回 <code>CompletableFuture&lt;Void&gt;</code>。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">thenRun</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>演示案例：我们仅仅想知道 <code>filter-words.txt</code> 的文件是否读取完成</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThenRunDemo1</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;读取 filter-words 文件&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&quot;filter-words.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenRun</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;读取 filter-words 文件完成&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main continue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">sleepSeconds</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">17</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">52.647</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> main start
<span class="token number">17</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">52.664</span> <span class="token operator">|</span> <span class="token number">20</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> 读取 filter<span class="token operator">-</span>words 文件
<span class="token number">17</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">52.665</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> main <span class="token keyword">continue</span>
<span class="token number">17</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">52.668</span> <span class="token operator">|</span> <span class="token number">20</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> 读取 filter<span class="token operator">-</span>words 文件完成
<span class="token number">17</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">56.666</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> main end
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>更进一步提升并行化</p> <p><code>CompletableFuture</code> 提供的所有回调方法都有两个异步变体</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">CompTetabTeFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> <span class="token function">thenApp1y</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> fn<span class="token punctuation">)</span>
<span class="token comment">// 回调方法的异步变体(异步回调)</span>
<span class="token class-name">CompTetabTeFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> <span class="token function">thenApplyAsync</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> fn<span class="token punctuation">)</span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> <span class="token function">thenApplyAsync</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> fn<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>注意: 这些带了 Async 的异步回调 通过在单独的线程中执行回调任务 来帮助您进一步促进并行化计算。</p> <p>回顾需求: 异步读取 <code>flter-words.txt</code> 文件中的内容，读取完成后，转换成敏感词数组，主线程获取结果打印输出这个数组</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThenApplyDemo2</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">CompletableFuture</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> filterWordsFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;读取 filter-words 文件&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&quot;filter-words.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>content <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;文件内容转换成敏感数组&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> content<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main continue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>filterWordsFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 总结
     * 一般而言，commonPool 为了提高性能水
     *  thenApply 中回调任务和 supplyAsync 中的异步任务使用的是同一个线程
     *  特殊情况：如 supplyAsync 中的任务是立即返回结果(不是耗时的任务)，thenApply 回调任务也会在主线程执行
     */</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>要更好地控制执行回调任务的线程，可以使用异步回调。如果使用 <code>thenApplyAsync()</code> 回调，那么它将在 <code>ForkJoinPool.commonPool()</code> 获得的另一个线程中执行。</p> <div class="language-java line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThenApplyDemo2</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">CompletableFuture</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> filterWordsFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;读取 filter-words 文件&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&quot;filter-words.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenApplyAsync</span><span class="token punctuation">(</span>content <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;文件内容转换成敏感数组&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> content<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> executorService<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main continue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>filterWordsFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 总结
     * 一般而言，commonPool 为了提高性能水
     *  thenApply 中回调任务和 supplyAsync 中的异步任务使用的是同一个线程
     *  特殊情况：如 supplyAsync 中的任务是立即返回结果(不是耗时的任务)，thenApply 回调任务也会在主线程执行。
     */</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h2 id="异步任务编排"><a href="#异步任务编排" class="header-anchor">#</a> 异步任务编排</h2> <h3 id="thencompose-方法"><a href="#thencompose-方法" class="header-anchor">#</a> thenCompose 方法</h3> <p>thenCompose 方法作用是编排 2 个 <strong>依赖关系</strong> 的异步任务。</p> <p>回顾需求：异步读取 <code>filter-words.txt</code> 文件中的内容，读取完成后，转换成敏感词数组让主线程待用。</p> <p>关于读取和解析内容，假设使用以下的 <code>readFileFuture(String)</code> 和 <code>splitFuture(String)</code> 方法完成。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">readFileFuture</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">CompletableFuture</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token function">splitFuture</span><span class="token punctuation">(</span><span class="token class-name">String</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> context<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>现在，让我们先了解如果使用 <code>thenApp1y()</code> 结果会发生什么</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">CompletableFuture</span><span class="token operator">&lt;</span><span class="token class-name">CompletableFuture</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;&gt;</span> future <span class="token operator">=</span> <span class="token function">readFileFuture</span><span class="token punctuation">(</span><span class="token string">&quot;filter-words .txt&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>context <span class="token operator">-&gt;</span> <span class="token function">splitFuture</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>回顾在之前的案例中，<code>thenApply(FunctionT,R)</code> 中 Function 回调会对上一步任务结果转换后得到一个简单值，但现在这种情况下，最终结果是嵌套的 CompletableFuture，所以这是不符合预期的，那怎么办呢?</p> <p>我们想要的是：把上一步异步任务的结里，转成一个 CompletableFuture 对象，这个 CompletableFuture 对象中包含本次异步任务外理后的结果。也就是说，<strong>我们想组合上一步异步任务的结果到下一个新的异步任务中，结果由这个新的异步任务返回</strong>。</p> <p>此时，你需要使用 <code>thenCompose()</code> 方法代替，我们可以把它理解为异步任务的组合。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">thenCompose</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> func<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>所以，<code>thencompose()</code> 用来连接两个有依赖关系的异步任务，结果由第二个任务返回</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">CompletableFuture</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> future <span class="token operator">=</span> <span class="token function">readFileFuture</span><span class="token punctuation">(</span><span class="token string">&quot;filter-words.txt&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">thenCompose</span><span class="token punctuation">(</span>context <span class="token operator">-&gt;</span> <span class="token function">splitFuture</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>因此，这里积累了一个经验:</p> <p>如果我们想连接（编排）两个依关系的异步任务（CompletableFuture 对象），请使用 <code>thenCompose()</code> 方法当然，<code>thenCompose</code> 也存在异步回调变体版本:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">thenCompose</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> fn<span class="token punctuation">)</span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">thenComposeAsync</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> fn<span class="token punctuation">)</span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">thenComposeAsync</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> fn<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="thencombine-方法"><a href="#thencombine-方法" class="header-anchor">#</a> thenCombine 方法</h3> <p>thenCombine 方法作用是编排 2 个 <strong>非依赖关系</strong> 的异步任务。</p> <p>我们已经知道，当其中一个 Future 依赖于另一个 Future，使用 <code>thenCompose</code> 用于组合两 Future，如果两 Future 之间没有依赖关系，你希望两个 Future 独立运行并在两者都完成之后执行回调操作时，则使用 <code>thenCombine()</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// T 是第一个任务的结果，U 是第二个任务的结果，V 是经 BiFunction 应用转换后的结果</span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span>v<span class="token punctuation">&gt;</span></span> <span class="token function">thenCombine</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span>u<span class="token punctuation">&gt;</span></span> other<span class="token punctuation">,</span> <span class="token class-name">BiFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span><span class="token class-name">U</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> func<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>需求:替换新闻稿 <code>news.txt</code> 中敏感词汇，把敏感词汇替换成 <code>*</code>，敏感词存储在 <code>flter-words.txt</code> 中</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThenComposeDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CompletableFuture</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> filterWordsFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;读取 filter-words 文件&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&quot;filter-words.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenCompose</span><span class="token punctuation">(</span>content <span class="token operator">-&gt;</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;文件内容转换成敏感数组&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> content<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> newsFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;读取 news.txt 文件&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&quot;news.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> combineFuture <span class="token operator">=</span> filterWordsFuture<span class="token punctuation">.</span><span class="token function">thenCombine</span><span class="token punctuation">(</span>newsFuture<span class="token punctuation">,</span> <span class="token punctuation">(</span>filterWords<span class="token punctuation">,</span> newsContent<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;替换操作&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> filterWord <span class="token operator">:</span> filterWords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>newsContent<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>filterWord<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    newsContent <span class="token operator">=</span> newsContent<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>filterWord<span class="token punctuation">,</span> <span class="token string">&quot;**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> newsContent<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main continue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span>combineFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;main end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">17</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">03.648</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> main start
<span class="token number">17</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">03.667</span> <span class="token operator">|</span> <span class="token number">20</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> 读取 filter<span class="token operator">-</span>words 文件
<span class="token number">17</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">03.667</span> <span class="token operator">|</span> <span class="token number">21</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">18</span> <span class="token operator">|</span> 读取 news<span class="token punctuation">.</span>txt 文件
<span class="token number">17</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">03.668</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> main <span class="token keyword">continue</span>
<span class="token number">17</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">03.672</span> <span class="token operator">|</span> <span class="token number">21</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">18</span> <span class="token operator">|</span> 文件内容转换成敏感数组
<span class="token number">17</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">03.672</span> <span class="token operator">|</span> <span class="token number">21</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">18</span> <span class="token operator">|</span> 替换操作
<span class="token number">17</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">03.673</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> oh my god<span class="token operator">!</span> <span class="token class-name">CompletableFuture</span> 真 <span class="token operator">*</span><span class="token operator">*</span> 好用！
<span class="token number">17</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">03.673</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> main end
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="合并多个异步任务-allof"><a href="#合并多个异步任务-allof" class="header-anchor">#</a> 合并多个异步任务 allOf</h3> <p>我们使用 <code>thenCompose()</code> 和 <code>thencombine()</code> 将两个 CompletableFuture 组合和合并在一起。</p> <p>如果要编排任意数量的 CompletableFuture 怎么办? 可以使用以下方法来组合任意数量的 CompletableFuture。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">alOf</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> cfs<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>CompletableFuture.allOf()</code> 用于以下情形中: 有多人需要独立并行运行的 Future，并在所有这些 Future 都完成后执行一些操作。</p> <p>需求: 统计 <code>news1.txt</code>、<code>new2.txt</code>、<code>new3.txt</code> 文件中包含 CompletableFuture 关键字的文件的个数。</p> <p><code>new1.txt</code> 文件：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>测试 <span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>new2.txt</code> 文件：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>测试 <span class="token number">2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>new3.txt</code> 文件：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>测试 <span class="token number">3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>代码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AllOfDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1、创建 List 集合存储文件名</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> fileList <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;news1.txt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;news2.txt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;news3.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2、根据文件名调用 readFileFuture 创建多个 CompletableFuture，并存入 List 集合中</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> readFileFutureList <span class="token operator">=</span> fileList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>fileName <span class="token operator">-&gt;</span> <span class="token function">readFileFuture</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3、把 List 集合转换成数组待用，以便传人 allOf 方法中</span>
        <span class="token class-name">CompletableFuture</span><span class="token punctuation">[</span><span class="token punctuation">]</span> readFileFutureArr <span class="token operator">=</span> readFileFutureList<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4、AllOf 成功回调读取结果</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> allOfFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>readFileFutureArr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 5、当多个异步任务都完成后，使用回调操作文件结果，统计符合条件的文件个数</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> sizeFuture <span class="token operator">=</span> allOfFuture<span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>v <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            readFileFutureList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>file <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> content <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;内容：&quot;</span> <span class="token operator">+</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> readFileFutureList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 6、主线程打印输出文件个数</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;长度：&quot;</span> <span class="token operator">+</span> sizeFuture<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * aLlOf 特别适合合并多个异步任务，当所有异步任务都完成时可以进一步操
         */</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">readFileFuture</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>内容：测试 <span class="token number">1</span>
内容：测试 <span class="token number">2</span>
内容：测试 <span class="token number">3</span>
长度：<span class="token number">3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="合并多个异步任务-anyof"><a href="#合并多个异步任务-anyof" class="header-anchor">#</a> 合并多个异步任务 anyOf</h3> <p>顾名思义，当给定的多个异步任务中的有任意 Future 一个完成时，需要执行一些操作，可以使用 <code>anyOf</code> 方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">anyOf</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> cfs<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>anyOf()</code> 返回一个新的 CompletableFuture, 新的 CompletableFuture 的结果和 cfs 中已完成的那个异步任务结果相同。</p> <p>演示案例: <code>anyOf</code> 执行过程</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AnyOfDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> allOfFuture1 <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">sleepSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">&quot;结果 1&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> allOfFuture2 <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">sleepSeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">&quot;结果 2&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> allOfFuture3 <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">sleepSeconds</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">&quot;结果 3&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 任意一个 异步任务 完成，则返回结果</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> anyOfFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">anyOf</span><span class="token punctuation">(</span>allOfFuture1<span class="token punctuation">,</span> allOfFuture2<span class="token punctuation">,</span> allOfFuture3<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> result <span class="token operator">=</span> anyOfFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 结果 1</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>结果 <span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在上面的示例中，当三个 CompletableFuture 中的任意一人完成时，anyOfFuture 就完成了。由于 allOfFuture1 的睡眠时间最少，因此它将首先完成，最终结果将是 <strong>结果 1</strong>。</p> <p>注意：</p> <ul><li><code>anyOf()</code> 方法返回类型必须是 <code>CompletableFuture&lt;Object&gt;</code></li> <li><code>anyOf()</code> 的问题在于，如果您拥有返回不同类型结果的 CompletableFuture，那么您将不知道最终 CompletableFuture 的类型</li></ul> <h2 id="异步任务的异常处理"><a href="#异步任务的异常处理" class="header-anchor">#</a> 异步任务的异常处理</h2> <p>在前面的章节中，我们并没有更多地关心异常处理的问题，其实，CompletableFuture 提供了优化处理异常的方式。</p> <p>首先，让我们了解 <strong>异常如何在回调链中传播</strong>。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExceptionChainDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;result 1&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>result <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> result <span class="token operator">+</span> <span class="token string">&quot; result 2&quot;</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>result <span class="token operator">-&gt;</span> result <span class="token operator">+</span> <span class="token string">&quot; result 3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>如果在 <code>supplyAsync</code> 任务中出现异常，后续的 thenApply 和 thenAccept 回调都不会执行，CompletableFuture 将转入异常处理。</p> <p>如果在第一个 thenApply 任务中出现异常，第二个 thenApply 和最后的 thenAccept 回调不会被执行，CompletableFuture 将转入异常外理，依次类推。</p> <h3 id="exceptionally-方法"><a href="#exceptionally-方法" class="header-anchor">#</a> exceptionally 方法</h3> <p>exceptionally 用于处理回调链上的异常，回调链上出现的任何异常，回调链不继续向下执行，都在 exceptionally 中处理异常。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// Throwable 表示具体的异常对象 e</span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">exceptionally</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token operator">&lt;</span><span class="token class-name">Throwable</span>，<span class="token class-name">R</span><span class="token operator">&gt;</span> func<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Demo</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExceptionChainDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        
        <span class="token comment">/**
         * 如果回调链中出现任意异常，回调链不再向下执行，而是立即转入异常处理 exceptionally，并将异常处理的返回值进行返回
         */</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;result 1&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>result <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> result <span class="token operator">+</span> <span class="token string">&quot; result 2&quot;</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>result <span class="token operator">-&gt;</span> result <span class="token operator">+</span> <span class="token string">&quot; result 3&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">exceptionally</span><span class="token punctuation">(</span>exception <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;出现异常：&quot;</span> <span class="token operator">+</span> exception<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token string">&quot;UnKnown&quot;</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>出现异常：<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ArithmeticException</span><span class="token operator">:</span> <span class="token operator">/</span> by zero
<span class="token class-name">UnKnown</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>因为 exceptionally 只处理一次异常，所以常常用在回调链的末端。</p> <h3 id="handle-方法"><a href="#handle-方法" class="header-anchor">#</a> handle 方法</h3> <p>CompletableFuture APl 还提供了一种更通用的方法 <code>handle()</code> 表示从异常中恢复。</p> <p><code>handle()</code> 常常被用来恢复回调链中的一次特定的异常，回调链恢复后可以进一步向下传递。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HandleDemo1</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">/**
         * 异步任务不管是否发生异常，handle 方法都会执行，第一个参数是异步任务的返回值，如果出现异常，则异常信息在第二个参数里
         * 所以，handle 核心作用在于对上一步异步任务进行现场恢复
         */</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;result 1&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>result <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> result <span class="token operator">+</span> <span class="token string">&quot; result 2&quot;</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>result <span class="token operator">-&gt;</span> result <span class="token operator">+</span> <span class="token string">&quot; result 3&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> exception<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;处理异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;出现异常：&quot;</span> <span class="token operator">+</span> exception<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token string">&quot;UnKnown&quot;</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">18</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">48.231</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> 处理异常
出现异常：<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ArithmeticException</span><span class="token operator">:</span> <span class="token operator">/</span> by zero
<span class="token class-name">UnKnown</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果发生异常，则 result 参数将为 null，否则 exception 参数将为 null。</p> <p>需求：对回调链中的一次异常进行恢复处理</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HandleDemo2</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">/**
         * 异步任务不管是否发生异常，handle 方法都会执行，第一个参数是异步任务的返回值，如果出现异常，则异常信息在第二个参数里
         * 所以，handle 核心作用在于对上一步异步任务进行现场恢复
         */</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token string">&quot;result 1&quot;</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> exception<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;出现异常：&quot;</span> <span class="token operator">+</span> exception<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token string">&quot;UnKnown1&quot;</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>result <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> result <span class="token operator">+</span> <span class="token string">&quot; result 2&quot;</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> exception<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;出现异常：&quot;</span> <span class="token operator">+</span> exception<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token string">&quot;UnKnown2&quot;</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>result <span class="token operator">-&gt;</span> result <span class="token operator">+</span> <span class="token string">&quot; result 3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>出现异常：<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ArithmeticException</span><span class="token operator">:</span> <span class="token operator">/</span> by zero
出现异常：<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ArithmeticException</span><span class="token operator">:</span> <span class="token operator">/</span> by zero
<span class="token class-name">UnKnown2</span> result <span class="token number">3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>和以往一样，为了提升并行化，异常处理可以方法单独的线程执行，以下是它们的异步回调版本</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">CompTetabTeFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">exceptionally</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Throwable</span><span class="token punctuation">,</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> fn<span class="token punctuation">)</span>
<span class="token class-name">CompTetabTeFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">exceptionallyAsync</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Throwable</span><span class="token punctuation">,</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> fn<span class="token punctuation">)</span> <span class="token comment">// jdk17+</span>
<span class="token class-name">CompTetabTeFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">exceptionallyAsync</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Throwable</span><span class="token punctuation">,</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> fn<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">)</span> <span class="token comment">// jdk17+</span>
  
<span class="token class-name">CompTetabTeFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">BiFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span><span class="token class-name">Throwable</span><span class="token punctuation">,</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> fn<span class="token punctuation">)</span>
<span class="token class-name">CompTetabTeFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">handleAsync</span><span class="token punctuation">(</span><span class="token class-name">BiFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span><span class="token class-name">Throwable</span><span class="token punctuation">,</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> fn<span class="token punctuation">)</span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">handleAsync</span><span class="token punctuation">(</span><span class="token class-name">BiFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span><span class="token class-name">Throwable</span><span class="token punctuation">,</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> fn<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="异步任务的交互"><a href="#异步任务的交互" class="header-anchor">#</a> 异步任务的交互</h2> <p>异步任务交互指将异步任务对 <strong>获取结果的速度相比较</strong>，按一定的规则（<strong>先到先用</strong>）进行下一步处理。</p> <h3 id="applytoeither-方法"><a href="#applytoeither-方法" class="header-anchor">#</a> applyToEither 方法</h3> <p><code>applyToEither()</code> 把两个异步任务做比较，异步任务先到结果的，就对先到的结果进行下一步的操作。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">applyToEither</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> other<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> func<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>演示案例: 使用最先完成的异步任务的结果：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> applyEitherDemo <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> future1 <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">sleepSeconds</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;任务 1 耗时：&quot;</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">&quot; 秒&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> x<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> future2 <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">sleepSeconds</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;任务 2 耗时：&quot;</span> <span class="token operator">+</span> y <span class="token operator">+</span> <span class="token string">&quot; 秒&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> y<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> future1<span class="token punctuation">.</span><span class="token function">applyToEither</span><span class="token punctuation">(</span>future2<span class="token punctuation">,</span> result <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;最先到达的结果：&quot;</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">sleepSeconds</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;最终结果：&quot;</span> <span class="token operator">+</span> future<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">/**
         * 异步任务交互指两个异步任务，哪个结果先到，就使用哪个结果（先到先用）
         */</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">19</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">55.946</span> <span class="token operator">|</span> <span class="token number">20</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> 任务 <span class="token number">1</span> 耗时：<span class="token number">1</span> 秒
<span class="token number">19</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">55.946</span> <span class="token operator">|</span> <span class="token number">21</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">18</span> <span class="token operator">|</span> 任务 <span class="token number">2</span> 耗时：<span class="token number">2</span> 秒
<span class="token number">19</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">55.956</span> <span class="token operator">|</span> <span class="token number">20</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> 最先到达的结果：<span class="token number">1</span>
最终结果：<span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>速记心法：任务 1、任务 2 就像两辆公交，哪路公交先到，就乘坐（使用）哪路公交</p> <p>以下是 applyToEither 和其对应的异步回调版本</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">applyToEither</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> other， <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> func<span class="token punctuation">)</span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">applyToEitherAsync</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> other<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> func<span class="token punctuation">)</span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">applyToEitherAsync</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span>t<span class="token punctuation">&gt;</span></span> other<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> func<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="accepteither"><a href="#accepteither" class="header-anchor">#</a> acceptEither</h3> <p><code>acceptEither()</code> 把两个异步任务做比较，异步任务先到结果的，就对先到的结果进行下一步操作（消费使用）。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">acceptEither</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> other<span class="token punctuation">,</span> <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> action<span class="token punctuation">)</span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">acceptEitherAsync</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> other<span class="token punctuation">,</span> <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> action<span class="token punctuation">)</span>
completableFuture<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">acceptEitherAsync</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> other<span class="token punctuation">,</span> <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> action<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>演示案例：使用最先完成的异步任务的结果</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> acceptEitherDemo <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> future1 <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">sleepSeconds</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;任务 1 耗时：&quot;</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">&quot; 秒&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> x<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> future2 <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">sleepSeconds</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;任务 2 耗时：&quot;</span> <span class="token operator">+</span> y <span class="token operator">+</span> <span class="token string">&quot; 秒&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> y<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        future1<span class="token punctuation">.</span><span class="token function">acceptEither</span><span class="token punctuation">(</span>future2<span class="token punctuation">,</span> result <span class="token operator">-&gt;</span> <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;最先到达的结果：&quot;</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        future1<span class="token punctuation">.</span><span class="token function">acceptEitherAsync</span><span class="token punctuation">(</span>future2<span class="token punctuation">,</span> result <span class="token operator">-&gt;</span> <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;最先到达的结果（Async 调用）：&quot;</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">,</span> executorService<span class="token punctuation">)</span><span class="token punctuation">;</span>
        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">sleepSeconds</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">19</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">47.716</span> <span class="token operator">|</span> <span class="token number">21</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">18</span> <span class="token operator">|</span> 任务 <span class="token number">2</span> 耗时：<span class="token number">2</span> 秒
<span class="token number">19</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">47.716</span> <span class="token operator">|</span> <span class="token number">20</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> 任务 <span class="token number">1</span> 耗时：<span class="token number">2</span> 秒
<span class="token number">19</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">47.725</span> <span class="token operator">|</span> <span class="token number">20</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> 最先到达的结果：<span class="token number">2</span>
<span class="token number">19</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">47.725</span> <span class="token operator">|</span> <span class="token number">22</span> <span class="token operator">|</span> pool<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">|</span> 最先到达的结果（<span class="token class-name">Async</span> 调用）：<span class="token number">2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="runaftereither"><a href="#runaftereither" class="header-anchor">#</a> runAfterEither</h3> <p>如果不关心最先到达的结果，只想在有一个异步任务先完成时得到完成的通知，可以使用 <code>runAfterEither()</code> ，以下是它的相关方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">runAfterEither</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> other<span class="token punctuation">,</span> <span class="token class-name">Runnable</span> action<span class="token punctuation">)</span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">runAfterEitherAsync</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> other<span class="token punctuation">,</span> <span class="token class-name">Runnable</span> action<span class="token punctuation">)</span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">runAfterEitherAsync</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> other<span class="token punctuation">,</span> <span class="token class-name">Runnable</span> action<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>提示</p> <p>异步任务交互的三个方法和之前学习的异步的回调方法 <code>thenApply</code>、<code>thenAccept</code>、<code>thenRun</code> 有异曲同工之妙。</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RuntEitherDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> future1 <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">sleepSeconds</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;任务 1 耗时：&quot;</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">&quot; 秒&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> x<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> future2 <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">sleepSeconds</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;任务 2 耗时：&quot;</span> <span class="token operator">+</span> y <span class="token operator">+</span> <span class="token string">&quot; 秒&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> y<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// acceptEither 方法</span>
        future1<span class="token punctuation">.</span><span class="token function">runAfterEither</span><span class="token punctuation">(</span>future2<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;有一个异步任务完成了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">sleepSeconds</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">19</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">01.480</span> <span class="token operator">|</span> <span class="token number">21</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">18</span> <span class="token operator">|</span> 任务 <span class="token number">2</span> 耗时：<span class="token number">0</span> 秒
<span class="token number">19</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">01.480</span> <span class="token operator">|</span> <span class="token number">20</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> 任务 <span class="token number">1</span> 耗时：<span class="token number">0</span> 秒
<span class="token number">19</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">01.494</span> <span class="token operator">|</span> <span class="token number">21</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">18</span> <span class="token operator">|</span> 有一个异步任务完成了
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="runafterboth"><a href="#runafterboth" class="header-anchor">#</a> runAfterBoth</h3> <p>和 <code>runAfterEither</code> 相反的方法是 <code>runAfterBoth</code>，所有异步任务都完成了，才得到通知。</p> <h2 id="get-和-join-区别"><a href="#get-和-join-区别" class="header-anchor">#</a> get 和 join 区别</h2> <p><code>get()</code> 和 <code>join()</code> 都是 CompletableFuture 提供的以阻塞方式。</p> <p>获取结果的方法那么该如何选用呢? 请看如下案例：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GetOrJoinDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">String</span> getResult <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// 抛出检查时异常，必须手动处理</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            getResult <span class="token operator">=</span> future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;result = &quot;</span> <span class="token operator">+</span> getResult<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 抛出运行时异常，可以不处理</span>
        <span class="token class-name">String</span> joinResult <span class="token operator">=</span> future<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;join = &quot;</span> <span class="token operator">+</span> joinResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>result <span class="token operator">=</span> hello
join <span class="token operator">=</span> hello
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>使用时，我们发现，<code>get()</code> 抛出检查时异常，需要程序必须处理；而 <code>join()</code> 方法抛出运行时异常，程序可以不处理。所以 <code>join()</code> 更适合用在流式编程中。</p> <h2 id="parallelstream-vs-completablefuture"><a href="#parallelstream-vs-completablefuture" class="header-anchor">#</a> ParallelStream VS CompletableFuture</h2> <p>CompletableFuture 虽然提高了任务并行处理的能力，如果它和 Stream API 结合使用，能否进一步多个任务的并行处理能力呢？</p> <p>同时，对于 Stream API 本身就提供了并行流 ParallelStream，它们有什么不同呢？</p> <p>我们将通过一个耗时的任务来体现它们的不同，更重要地是，我们能进一步加强 CompletableFuture 和 Stream API 的结合使用，同时搞清楚 CompletableFuture 在流式操作的优势。</p> <p>需求: 创建 10 个 MyTask 耗时的任务，统计它们执行完的总耗时。</p> <p>定义一个 MyTask 类，来模拟耗时的长任务</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyTask</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">int</span> duration<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MyTask</span><span class="token punctuation">(</span><span class="token keyword">int</span> duration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>duration <span class="token operator">=</span> duration<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;doWork&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">sleepSeconds</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> duration<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>同时，我们创建 10 个任务，每个持续 1 秒</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SequenceDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 需求：创建 10 个 MyTask 耗时任务，统计执行完的耗时长</span>

        <span class="token comment">// 创建 10 个 MyTask 对象，每个任务持续 1s。存入 List 集合</span>
        <span class="token class-name">IntStream</span> range <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MyTask</span><span class="token punctuation">&gt;</span></span> tasks <span class="token operator">=</span> range<span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">MyTask</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> results <span class="token operator">=</span> tasks<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>myTask <span class="token operator">-&gt;</span> myTask<span class="token punctuation">.</span><span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;任务数：&quot;</span> <span class="token operator">+</span> tasks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;，耗时：&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">19</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">00.753</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> doWork
<span class="token number">19</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">01.772</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> doWork
<span class="token number">19</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">02.786</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> doWork
<span class="token number">19</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">03.798</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> doWork
<span class="token number">19</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">04.806</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> doWork
<span class="token number">19</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">05.820</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> doWork
<span class="token number">19</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">06.834</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> doWork
<span class="token number">19</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">07.844</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> doWork
<span class="token number">19</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">08.857</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> doWork
<span class="token number">19</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">09.870</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> doWork
任务数：<span class="token number">10</span>，耗时：<span class="token number">10.144</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>它花费了 10 秒，因为每个任务在主线程一个接一个的执行。</p> <h3 id="并行流的局限性"><a href="#并行流的局限性" class="header-anchor">#</a> 并行流的局限性</h3> <p>因为涉及 Stream API，而且存在耗时的长任务，所以，我们可以使用 <code>para1lelstream()</code>。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ParallelStreamDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建 10 个 MyTask 耗时任务，统计执行完的耗时长</span>

        <span class="token comment">// 创建 10 个 MyTask 对象，每个任务持续 1s。存入 List 集合</span>
        <span class="token class-name">IntStream</span> range <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MyTask</span><span class="token punctuation">&gt;</span></span> tasks <span class="token operator">=</span> range<span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">MyTask</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// parallelStream 并行执行，如果电脑有 10 个核，则只需要 1s 左右，每个核都能处理一个 map 循环</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> results <span class="token operator">=</span> tasks<span class="token punctuation">.</span><span class="token function">parallelStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>myTask <span class="token operator">-&gt;</span> myTask<span class="token punctuation">.</span><span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;任务数：&quot;</span> <span class="token operator">+</span> tasks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;，耗时：&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">19</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">43.983</span> <span class="token operator">|</span> <span class="token number">24</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">22</span> <span class="token operator">|</span> doWork
<span class="token number">19</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">43.983</span> <span class="token operator">|</span> <span class="token number">28</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">|</span> doWork
<span class="token number">19</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">43.983</span> <span class="token operator">|</span> <span class="token number">25</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">29</span> <span class="token operator">|</span> doWork
<span class="token number">19</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">43.983</span> <span class="token operator">|</span> <span class="token number">26</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">15</span> <span class="token operator">|</span> doWork
<span class="token number">19</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">43.983</span> <span class="token operator">|</span> <span class="token number">23</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">4</span> <span class="token operator">|</span> doWork
<span class="token number">19</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">43.983</span> <span class="token operator">|</span> <span class="token number">22</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">11</span> <span class="token operator">|</span> doWork
<span class="token number">19</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">43.983</span> <span class="token operator">|</span> <span class="token number">21</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">18</span> <span class="token operator">|</span> doWork
<span class="token number">19</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">43.983</span> <span class="token operator">|</span> <span class="token number">27</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">8</span> <span class="token operator">|</span> doWork
<span class="token number">19</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">43.983</span> <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> main <span class="token operator">|</span> doWork
<span class="token number">19</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">43.983</span> <span class="token operator">|</span> <span class="token number">20</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> doWork
任务数：<span class="token number">10</span>，耗时：<span class="token number">1.034</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>它花费了 1 秒多，因为此次并行执行使用了 10 个线程，9 个是 ForkJoinPool 线程池中的，一个是 main 线程)，需要注意是: 运行结果由自己电
脑 CPU 的核数决定。</p> <h3 id="completablefuture-在流式操作的优势"><a href="#completablefuture-在流式操作的优势" class="header-anchor">#</a> CompletableFuture 在流式操作的优势</h3> <p>让我们看看使用 CompletableFuture  是否执行的更有效率</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CompletableFutureDemo1</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 需求：创建 10 个 MyTask 耗时任务，统计执行完的耗时长</span>

        <span class="token comment">// 1、创建 10 个 MyTask 对象，每个任务持续 1s。存入 List 集合</span>
        <span class="token class-name">IntStream</span> range <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MyTask</span><span class="token punctuation">&gt;</span></span> tasks <span class="token operator">=</span> range<span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">MyTask</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 获取电脑线程池数量</span>
        <span class="token keyword">int</span> <span class="token constant">CPU_N</span> <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 准备线程池</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>tasks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">CPU_N</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 2、根据 MyTask 对象创建 10 个异步任务</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> futures <span class="token operator">=</span> tasks<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>myTask <span class="token operator">-&gt;</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> myTask<span class="token punctuation">.</span><span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> executorService<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3、执行异步任务，执行完成后，获取异步任务的结果，存入 List 集合中，统计总耗时</span>
        <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> results <span class="token operator">=</span> futures<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>future <span class="token operator">-&gt;</span> future<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;任务数：&quot;</span> <span class="token operator">+</span> tasks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;，耗时：&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 关闭线程池</span>
        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">19</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">47.813</span> <span class="token operator">|</span> <span class="token number">27</span> <span class="token operator">|</span> pool<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">8</span> <span class="token operator">|</span> doWork
<span class="token number">19</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">47.813</span> <span class="token operator">|</span> <span class="token number">23</span> <span class="token operator">|</span> pool<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">4</span> <span class="token operator">|</span> doWork
<span class="token number">19</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">47.813</span> <span class="token operator">|</span> <span class="token number">20</span> <span class="token operator">|</span> pool<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">|</span> doWork
<span class="token number">19</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">47.813</span> <span class="token operator">|</span> <span class="token number">28</span> <span class="token operator">|</span> pool<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">9</span> <span class="token operator">|</span> doWork
<span class="token number">19</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">47.813</span> <span class="token operator">|</span> <span class="token number">21</span> <span class="token operator">|</span> pool<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">2</span> <span class="token operator">|</span> doWork
<span class="token number">19</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">47.813</span> <span class="token operator">|</span> <span class="token number">29</span> <span class="token operator">|</span> pool<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">10</span> <span class="token operator">|</span> doWork
<span class="token number">19</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">47.813</span> <span class="token operator">|</span> <span class="token number">26</span> <span class="token operator">|</span> pool<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">7</span> <span class="token operator">|</span> doWork
<span class="token number">19</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">47.812</span> <span class="token operator">|</span> <span class="token number">22</span> <span class="token operator">|</span> pool<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">3</span> <span class="token operator">|</span> doWork
<span class="token number">19</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">47.812</span> <span class="token operator">|</span> <span class="token number">24</span> <span class="token operator">|</span> pool<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">5</span> <span class="token operator">|</span> doWork
<span class="token number">19</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">47.812</span> <span class="token operator">|</span> <span class="token number">25</span> <span class="token operator">|</span> pool<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">6</span> <span class="token operator">|</span> doWork
任务数：<span class="token number">10</span>，耗时：<span class="token number">1.033</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>测试代码时，如果电脑配置是 10 核，当创建的线程池中线程数最少也是 10 个，每个线程负责一个任务（耗时），总体来说处理 10 个任务总共需要约 1 秒。</p> <h2 id="合理配置线程池中的线程数"><a href="#合理配置线程池中的线程数" class="header-anchor">#</a> 合理配置线程池中的线程数</h2> <p>正如我们看到的，CompletableFuture 可以更好地控制线程池中线程的数量，而 ParallelStream 不能。</p> <blockquote><p>问题 1: 如何选用 CompletableFuture 和 ParallelStream</p></blockquote> <p>如果你的任务是 IO 密集型的，你应该使用 CompletableFuture。</p> <p>如果你的任务是 CPU 密集型的，使用比处理器更多的线程是没有意义的，所以选择 Parallelstream ，因为它不需要创建线程池，更容易使用。</p> <blockquote><p>问题 2: IO 密集型任务和 CPU 密集型任务的区别</p></blockquote> <p>CPU 密集型也叫计算密集型，此时，系统运行时大部分的状况是 CPU 占用率近乎 100%，IO 在很短的时间就可以完成，而 CPU 还有许多运算要处理，CPU 使用率很高。比如说要计算 <code>1 + 2 + 3 + ... + 10 万亿</code>、天文计算、圆周率后几十位等，都是属于 CPU 密集型程序。</p> <p>CPU 密集型任务的特点: 大量计算，CPU 占用率一般都很高，IO 时间很短</p> <p>IO 密集型指大部分的状况是 CPU 在等 IO（硬盘/内存）的读写操作，但 CPU 的使用率不高。</p> <p>简单的说，就是需要大量的输入输出，例如读写文件、传输文件、网络请求。</p> <p>IO 密集型任务的特点: 大量网络请求，文件操作，CPU 运算少，很多时候 CPU 在等待资源才能进一步操作。</p> <blockquote><p>问题 3: 既然要控制线程池的数量，多少合适呢</p></blockquote> <p>如果是 CPU 密集型任务，就需要尽量压榨 CPU，参考值可以设为 <code>Ncpu + 1</code>。</p> <p>如果是 IO 密集型任务，参考值可以设置为 <code>2 * Ncpu</code>，其中 Ncpu 表示 CPU 核心数。</p> <p>注意的是：以上给的是参考值，具体业务具体分析。</p> <h2 id="大数据商品比价案例"><a href="#大数据商品比价案例" class="header-anchor">#</a> 大数据商品比价案例</h2> <p>需求描述：实现一个大数据比价服务，价格数据可以从京东、天猫、拼多多等平台去获取指定商品的价格、优惠金额，然后计算出实际付款金额（商品价格优惠金额），最终返回价格最优的平台与价格信息。</p> <h3 id="构建工具类和实体类"><a href="#构建工具类和实体类" class="header-anchor">#</a> 构建工具类和实体类</h3> <p>价格实体类（用到了 Lombok）：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Setter</span>
<span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PriceResult</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> price<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> discount<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> realPrice<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> platform<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">PriceResult</span><span class="token punctuation">(</span><span class="token class-name">String</span> platform<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>platform <span class="token operator">=</span> platform<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;PriceResult{&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;平台='&quot;</span> <span class="token operator">+</span> platform <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span>
                <span class="token string">&quot;, 价格=&quot;</span> <span class="token operator">+</span> price <span class="token operator">+</span>
                <span class="token string">&quot;, 折扣=&quot;</span> <span class="token operator">+</span> discount <span class="token operator">+</span>
                <span class="token string">&quot;, 最终价=&quot;</span> <span class="token operator">+</span> realPrice <span class="token operator">+</span>
                <span class="token char">'}'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>工具类依然不变：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommonUtils</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 根据指定路径读取文件内容
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> pathToFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">readAllBytes</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pathToFile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 睡眠都是毫秒
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sleepMillis</span><span class="token punctuation">(</span><span class="token keyword">long</span> millis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MICROSECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>millis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 睡眠都是秒
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sleepSeconds</span><span class="token punctuation">(</span><span class="token keyword">long</span> seconds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>seconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">LocalTime</span> now <span class="token operator">=</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> now<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">&quot;[HH:mm:ss.SSS]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 打印日志信息
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 时间戳 | 线程 ID、 线程名 | 日志信息</span>
        <span class="token class-name">StringJoiner</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringJoiner</span><span class="token punctuation">(</span><span class="token string">&quot; | &quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%2d&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>   
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><h3 id="构建-httprequest"><a href="#构建-httprequest" class="header-anchor">#</a> 构建 HttpRequest</h3> <p>HttpRequest 用于模拟网络请求（耗时的操作）</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>ublic <span class="token keyword">class</span> <span class="token class-name">HttpRequest</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mockCostTimeOperations</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">sleepSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 过去淘宝平台的商品价格
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">PriceResult</span> <span class="token function">getTaoBaoPrice</span><span class="token punctuation">(</span><span class="token class-name">String</span> productName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;获取淘宝上 &quot;</span> <span class="token operator">+</span> productName <span class="token operator">+</span> <span class="token string">&quot; 价格&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">mockCostTimeOperations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">PriceResult</span> priceResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PriceResult</span><span class="token punctuation">(</span><span class="token string">&quot;淘宝&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        priceResult<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token number">5199</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;获取淘宝上 &quot;</span> <span class="token operator">+</span> productName <span class="token operator">+</span> <span class="token string">&quot; 价格完成：5199&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> priceResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取淘宝平台的优惠
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">getTaoBaoDiscount</span><span class="token punctuation">(</span><span class="token class-name">String</span> productName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;获取淘宝上 &quot;</span> <span class="token operator">+</span> productName <span class="token operator">+</span> <span class="token string">&quot; 优惠&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">mockCostTimeOperations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;获取淘宝上 &quot;</span> <span class="token operator">+</span> productName <span class="token operator">+</span> <span class="token string">&quot; 优惠完成：-200&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">200</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取京东平台的商品价格
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">PriceResult</span> <span class="token function">getJDongPrice</span><span class="token punctuation">(</span><span class="token class-name">String</span> productName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;获取京东上 &quot;</span> <span class="token operator">+</span> productName <span class="token operator">+</span> <span class="token string">&quot; 价格&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">mockCostTimeOperations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">PriceResult</span> priceResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PriceResult</span><span class="token punctuation">(</span><span class="token string">&quot;京东&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        priceResult<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token number">5299</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;获取京东上 &quot;</span> <span class="token operator">+</span> productName <span class="token operator">+</span> <span class="token string">&quot; 价格完成：5299&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> priceResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * 获取京东平台的优惠
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">getJDongDiscount</span><span class="token punctuation">(</span><span class="token class-name">String</span> productName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;获取京东上 &quot;</span> <span class="token operator">+</span> productName <span class="token operator">+</span> <span class="token string">&quot; 优惠&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">mockCostTimeOperations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;获取京东上 &quot;</span> <span class="token operator">+</span> productName <span class="token operator">+</span> <span class="token string">&quot; 优惠完成：-150&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">150</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取拼多多平台的商品价格
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">PriceResult</span> <span class="token function">getPDDPrice</span><span class="token punctuation">(</span><span class="token class-name">String</span> productName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;获取拼多多上 &quot;</span> <span class="token operator">+</span> productName <span class="token operator">+</span> <span class="token string">&quot; 价格&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">mockCostTimeOperations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">PriceResult</span> priceResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PriceResult</span><span class="token punctuation">(</span><span class="token string">&quot;拼多多&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        priceResult<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token number">5399</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;获取拼多多上 &quot;</span> <span class="token operator">+</span> productName <span class="token operator">+</span> <span class="token string">&quot; 价格完成：5399&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> priceResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取拼多多平台的优惠
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">getPDDDiscount</span><span class="token punctuation">(</span><span class="token class-name">String</span> productName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;获取拼多多上 &quot;</span> <span class="token operator">+</span> productName <span class="token operator">+</span> <span class="token string">&quot; 优惠&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">mockCostTimeOperations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span><span class="token string">&quot;获取拼多多上 &quot;</span> <span class="token operator">+</span> productName <span class="token operator">+</span> <span class="token string">&quot; 优惠完成：-5300&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">5300</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div><h3 id="操作商品比价"><a href="#操作商品比价" class="header-anchor">#</a> 操作商品比价</h3> <p>下面有三种方案进行比价：</p> <ul><li>串行方式</li> <li>Future + 线程池方式</li> <li>CompletableFuture 方式</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ComparePriceService</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 方案一：串行方式操作商品比价
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">PriceResult</span> <span class="token function">getCheapestPlatformPrice1</span><span class="token punctuation">(</span><span class="token class-name">String</span> productName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">PriceResult</span> priceResult<span class="token punctuation">;</span>
        <span class="token keyword">int</span> discount<span class="token punctuation">;</span>
        <span class="token comment">// 获取淘宝平台的商品价格和优惠</span>
        priceResult <span class="token operator">=</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">.</span><span class="token function">getTaoBaoPrice</span><span class="token punctuation">(</span>productName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        discount <span class="token operator">=</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">.</span><span class="token function">getTaoBaoDiscount</span><span class="token punctuation">(</span>productName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PriceResult</span> taoaoPriceResult <span class="token operator">=</span> <span class="token function">computeRealPrice</span><span class="token punctuation">(</span>priceResult<span class="token punctuation">,</span> discount<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取京东平台的商品价格和优惠</span>
        priceResult <span class="token operator">=</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">.</span><span class="token function">getJDongPrice</span><span class="token punctuation">(</span>productName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        discount <span class="token operator">=</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">.</span><span class="token function">getJDongDiscount</span><span class="token punctuation">(</span>productName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PriceResult</span> jDongPriceResult <span class="token operator">=</span> <span class="token function">computeRealPrice</span><span class="token punctuation">(</span>priceResult<span class="token punctuation">,</span> discount<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取拼多多平台的商品价格和优惠</span>
        priceResult <span class="token operator">=</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">.</span><span class="token function">getPDDPrice</span><span class="token punctuation">(</span>productName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        discount <span class="token operator">=</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">.</span><span class="token function">getPDDDiscount</span><span class="token punctuation">(</span>productName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PriceResult</span> pddPriceResult <span class="token operator">=</span> <span class="token function">computeRealPrice</span><span class="token punctuation">(</span>priceResult<span class="token punctuation">,</span> discount<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 计算最优的平台和价格</span>
        <span class="token keyword">return</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>taoaoPriceResult<span class="token punctuation">,</span> jDongPriceResult<span class="token punctuation">,</span> pddPriceResult<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token punctuation">.</span><span class="token function">comparing</span><span class="token punctuation">(</span><span class="token class-name">PriceResult</span><span class="token operator">::</span><span class="token function">getRealPrice</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 方案二：使用 Future + 线程池并行方式操作商品比价
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">PriceResult</span> <span class="token function">getCheapestPlatformPrice2</span><span class="token punctuation">(</span><span class="token class-name">String</span> productName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 线程池</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取淘宝平台的商品价格和优惠</span>
        <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PriceResult</span><span class="token punctuation">&gt;</span></span> taoBaoFuture <span class="token operator">=</span> executorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">PriceResult</span> priceResult <span class="token operator">=</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">.</span><span class="token function">getTaoBaoPrice</span><span class="token punctuation">(</span>productName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> discount <span class="token operator">=</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">.</span><span class="token function">getTaoBaoDiscount</span><span class="token punctuation">(</span>productName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">computeRealPrice</span><span class="token punctuation">(</span>priceResult<span class="token punctuation">,</span> discount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取京东平台的商品价格和优惠</span>
        <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PriceResult</span><span class="token punctuation">&gt;</span></span> jDongFuture <span class="token operator">=</span> executorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">PriceResult</span> priceResult <span class="token operator">=</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">.</span><span class="token function">getJDongPrice</span><span class="token punctuation">(</span>productName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> discount <span class="token operator">=</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">.</span><span class="token function">getJDongDiscount</span><span class="token punctuation">(</span>productName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">computeRealPrice</span><span class="token punctuation">(</span>priceResult<span class="token punctuation">,</span> discount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取拼多多平台的商品价格和优惠</span>
        <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PriceResult</span><span class="token punctuation">&gt;</span></span> pddFuture <span class="token operator">=</span> executorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">PriceResult</span> priceResult <span class="token operator">=</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">.</span><span class="token function">getPDDPrice</span><span class="token punctuation">(</span>productName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> discount <span class="token operator">=</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">.</span><span class="token function">getPDDDiscount</span><span class="token punctuation">(</span>productName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">computeRealPrice</span><span class="token punctuation">(</span>priceResult<span class="token punctuation">,</span> discount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 计算最优的平台和价格</span>
        <span class="token keyword">return</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>taoBaoFuture<span class="token punctuation">,</span> jDongFuture<span class="token punctuation">,</span> pddFuture<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>future <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        executorService<span class="token punctuation">.</span><span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token operator">::</span><span class="token function">nonNull</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token punctuation">.</span><span class="token function">comparing</span><span class="token punctuation">(</span><span class="token class-name">PriceResult</span><span class="token operator">::</span><span class="token function">getRealPrice</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 方案三：使用 CompletableFuture 方式操作商品比价
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">PriceResult</span> <span class="token function">getCheapestPlatformPrice3</span><span class="token punctuation">(</span><span class="token class-name">String</span> productName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取淘宝平台的商品价格和优惠</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PriceResult</span><span class="token punctuation">&gt;</span></span> taoBaoCompletableFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">.</span><span class="token function">getTaoBaoPrice</span><span class="token punctuation">(</span>productName<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">thenCombine</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">.</span><span class="token function">getTaoBaoDiscount</span><span class="token punctuation">(</span>productName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">computeRealPrice</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取京东平台的商品价格和优惠</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PriceResult</span><span class="token punctuation">&gt;</span></span> jDongCompletableFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">.</span><span class="token function">getJDongPrice</span><span class="token punctuation">(</span>productName<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">thenCombine</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">.</span><span class="token function">getJDongDiscount</span><span class="token punctuation">(</span>productName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">computeRealPrice</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取拼多多平台的商品价格和优惠</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PriceResult</span><span class="token punctuation">&gt;</span></span> pddCompletableFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">.</span><span class="token function">getPDDPrice</span><span class="token punctuation">(</span>productName<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">thenCombine</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">.</span><span class="token function">getPDDDiscount</span><span class="token punctuation">(</span>productName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">computeRealPrice</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 计算最优的平台和价格</span>
        <span class="token keyword">return</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>taoBaoCompletableFuture<span class="token punctuation">,</span> jDongCompletableFuture<span class="token punctuation">,</span> pddCompletableFuture<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token operator">::</span><span class="token function">join</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token operator">::</span><span class="token function">nonNull</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token punctuation">.</span><span class="token function">comparing</span><span class="token punctuation">(</span><span class="token class-name">PriceResult</span><span class="token operator">::</span><span class="token function">getRealPrice</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 计算商品的最终价格 = 平台价格 - 优惠价
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">PriceResult</span> <span class="token function">computeRealPrice</span><span class="token punctuation">(</span><span class="token class-name">PriceResult</span> priceResult<span class="token punctuation">,</span> <span class="token keyword">int</span> discount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        priceResult<span class="token punctuation">.</span><span class="token function">setRealPrice</span><span class="token punctuation">(</span>priceResult<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> discount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        priceResult<span class="token punctuation">.</span><span class="token function">setDiscount</span><span class="token punctuation">(</span>discount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommonUtils</span><span class="token punctuation">.</span><span class="token function">printThreadLog</span><span class="token punctuation">(</span>priceResult<span class="token punctuation">.</span><span class="token function">getPlatform</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;最终价格计算完成：&quot;</span> <span class="token operator">+</span> priceResult<span class="token punctuation">.</span><span class="token function">getRealPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> priceResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br></div></div><h3 id="测试"><a href="#测试" class="header-anchor">#</a> 测试</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ComparePriceDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 方案一耗时 6.123s</span>
        <span class="token comment">// test1();</span>
        
        <span class="token comment">// 方案二耗时 2.067s</span>
        <span class="token comment">// test2();</span>

        <span class="token comment">// 方案三耗时 1.059s</span>
        <span class="token comment">// test3();</span>
        
        <span class="token comment">// 异步任务的批量操作</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;iPhone14 黑色&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;iPhone14 白色&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;iPhone14 玫瑰红&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ComparePriceService</span> comparePriceService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComparePriceService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PriceResult</span> priceResult <span class="token operator">=</span> comparePriceService<span class="token punctuation">.</span><span class="token function">batchComparePrice</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;priceResult = &quot;</span> <span class="token operator">+</span> priceResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 方案一测试：串行方式操作商品比价
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ComparePriceService</span> comparePriceService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComparePriceService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PriceResult</span> priceResult <span class="token operator">=</span> comparePriceService<span class="token punctuation">.</span><span class="token function">getCheapestPlatformPrice1</span><span class="token punctuation">(</span><span class="token string">&quot;iPhone14&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;耗时：&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;priceResult = &quot;</span> <span class="token operator">+</span> priceResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 方案二测试；使用 Future + 线程池并行方式操作商品比价
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ComparePriceService</span> comparePriceService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComparePriceService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PriceResult</span> priceResult <span class="token operator">=</span> comparePriceService<span class="token punctuation">.</span><span class="token function">getCheapestPlatformPrice2</span><span class="token punctuation">(</span><span class="token string">&quot;iPhone14&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;耗时：&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;priceResult = &quot;</span> <span class="token operator">+</span> priceResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 方案三测试：使用 CompletableFuture 方式操作商品比价
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ComparePriceService</span> comparePriceService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComparePriceService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PriceResult</span> priceResult <span class="token operator">=</span> comparePriceService<span class="token punctuation">.</span><span class="token function">getCheapestPlatformPrice3</span><span class="token punctuation">(</span><span class="token string">&quot;iPhone14&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;耗时：&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;priceResult = &quot;</span> <span class="token operator">+</span> priceResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><p>最终发现 CompletableFuture 方法耗时是最短的。</p> <p>耗时方案对比：串行方式（6.123s） &lt; Future（2.067s） + 线程池方式 &lt; CompletableFuture 方式（1.059s）。</p> <h3 id="stream-api-操作批量商品比价"><a href="#stream-api-操作批量商品比价" class="header-anchor">#</a> Stream API 操作批量商品比价</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ComparePriceService</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">PriceResult</span> <span class="token function">batchComparePrice</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> productNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1、遍历每个商品的名字，根据商品名称开启异步任务获取最终价，归集到 List 集合中</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">PriceResult</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> completableFutures <span class="token operator">=</span> productNames<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>productName <span class="token operator">-&gt;</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">.</span><span class="token function">getTaoBaoPrice</span><span class="token punctuation">(</span>productName<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">thenCombine</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">.</span><span class="token function">getTaoBaoDiscount</span><span class="token punctuation">(</span>productName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">computeRealPrice</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 把多个商品的最终价格进行排序获取最小值</span>
        <span class="token keyword">return</span> completableFutures<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token operator">::</span><span class="token function">join</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token punctuation">.</span><span class="token function">comparing</span><span class="token punctuation">(</span><span class="token class-name">PriceResult</span><span class="token operator">::</span><span class="token function">getRealPrice</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>测试</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ComparePriceDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 异步任务的批量操作</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;iPhone14 黑色&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;iPhone14 白色&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;iPhone14 玫瑰红&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ComparePriceService</span> comparePriceService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComparePriceService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PriceResult</span> priceResult <span class="token operator">=</span> comparePriceService<span class="token punctuation">.</span><span class="token function">batchComparePrice</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;priceResult = &quot;</span> <span class="token operator">+</span> priceResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>输出：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">20</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">16.317</span> <span class="token operator">|</span> <span class="token number">20</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> 获取淘宝上 iPhone14 黑色 价格
<span class="token number">20</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">16.317</span> <span class="token operator">|</span> <span class="token number">22</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">11</span> <span class="token operator">|</span> 获取淘宝上 iPhone14 白色 价格
<span class="token number">20</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">16.317</span> <span class="token operator">|</span> <span class="token number">23</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">4</span> <span class="token operator">|</span> 获取淘宝上 iPhone14 白色 优惠
<span class="token number">20</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">16.317</span> <span class="token operator">|</span> <span class="token number">21</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">18</span> <span class="token operator">|</span> 获取淘宝上 iPhone14 黑色 优惠
<span class="token number">20</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">16.317</span> <span class="token operator">|</span> <span class="token number">24</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">22</span> <span class="token operator">|</span> 获取淘宝上 iPhone14 玫瑰红 价格
<span class="token number">20</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">16.317</span> <span class="token operator">|</span> <span class="token number">25</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">29</span> <span class="token operator">|</span> 获取淘宝上 iPhone14 玫瑰红 优惠
<span class="token number">20</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">17.322</span> <span class="token operator">|</span> <span class="token number">21</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">18</span> <span class="token operator">|</span> 获取淘宝上 iPhone14 黑色 优惠完成：<span class="token operator">-</span><span class="token number">200</span>
<span class="token number">20</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">17.322</span> <span class="token operator">|</span> <span class="token number">20</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> 获取淘宝上 iPhone14 黑色 价格完成：<span class="token number">5199</span>
<span class="token number">20</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">17.322</span> <span class="token operator">|</span> <span class="token number">22</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">11</span> <span class="token operator">|</span> 获取淘宝上 iPhone14 白色 价格完成：<span class="token number">5199</span>
<span class="token number">20</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">17.322</span> <span class="token operator">|</span> <span class="token number">24</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">22</span> <span class="token operator">|</span> 获取淘宝上 iPhone14 玫瑰红 价格完成：<span class="token number">5199</span>
<span class="token number">20</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">17.322</span> <span class="token operator">|</span> <span class="token number">25</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">29</span> <span class="token operator">|</span> 获取淘宝上 iPhone14 玫瑰红 优惠完成：<span class="token operator">-</span><span class="token number">200</span>
<span class="token number">20</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">17.322</span> <span class="token operator">|</span> <span class="token number">23</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">4</span> <span class="token operator">|</span> 获取淘宝上 iPhone14 白色 优惠完成：<span class="token operator">-</span><span class="token number">200</span>
<span class="token number">20</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">17.322</span> <span class="token operator">|</span> <span class="token number">25</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">29</span> <span class="token operator">|</span> 淘宝最终价格计算完成：<span class="token number">4999</span>
<span class="token number">20</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">17.322</span> <span class="token operator">|</span> <span class="token number">20</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> 淘宝最终价格计算完成：<span class="token number">4999</span>
<span class="token number">20</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">17.322</span> <span class="token operator">|</span> <span class="token number">23</span> <span class="token operator">|</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>commonPool<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">4</span> <span class="token operator">|</span> 淘宝最终价格计算完成：<span class="token number">4999</span>
priceResult <span class="token operator">=</span> <span class="token class-name">PriceResult</span><span class="token punctuation">{</span>平台<span class="token operator">=</span><span class="token char">'淘宝'</span><span class="token punctuation">,</span> 价格<span class="token operator">=</span><span class="token number">5199</span><span class="token punctuation">,</span> 折扣<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span> 最终价<span class="token operator">=</span><span class="token number">4999</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/Somnus711/Somnus711.github.io/edit/master/docs/45.开发/30.知识/12.知识 - CompletableFuture.md" target="_blank" rel="noopener noreferrer">编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=knowledge" title="标签">#knowledge</a></div> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">2025/04/06, 01:04:59</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/knowledge/mapstruct-plus/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">知识 - MapStructPlus</div></a> <a href="/knowledge/easy-excel/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">知识 - EasyExcel</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/knowledge/mapstruct-plus/" class="prev">知识 - MapStructPlus</a></span> <span class="next"><a href="/knowledge/easy-excel/">知识 - EasyExcel</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/ep/magic-change/"><div>
            技术随笔 - Element Plus 修改包名
            <span class="title-tag">
              原创
            </span></div></a> <span class="date">11-02</span></dt></dl><dl><dd>02</dd> <dt><a href="/reactor/extensibility/"><div>
            Reactor - 扩展性
            <!----></div></a> <span class="date">11-02</span></dt></dl><dl><dd>03</dd> <dt><a href="/reactor/best-practices/"><div>
            Reactor - 最佳实践
            <!----></div></a> <span class="date">11-02</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:haoyuan1996@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/Somnus711" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2025
    <span>Somnus Haoyuan | <a href="https://github.com/Somnus711/Somnus711.github.io/blob/main/LICENSE" target="_blank">MIT
            License</a><br />
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010802034042"
            style="display:inline-block;text-decoration:none;height:20px;line-height:20px;"><img
                src="https://cdn.jsdelivr.net/gh/Somnus711/picx-image-hosting@master/blog-pic/备案图标.3ph98jsceq0w.webp" style="float:left;" />
            <span>京公网安备 11010802034042号</span>
        </a>
        <a target="_blank" href="https://beian.miit.gov.cn"
            style="display:inline-block;text-decoration:none;height:20px;line-height:20px;padding-left: 10px;">
            <span>京ICP备2025120692号-1</span></a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div></div><div></div><div></div><div id="tcomment"></div><!----><div></div></div></div>
    <script src="/assets/js/app.40d6eb57.js" defer></script><script src="/assets/js/2.84f16386.js" defer></script><script src="/assets/js/373.4a798498.js" defer></script><script src="/assets/js/15.107d5767.js" defer></script><script src="/assets/js/5.1ffba6c1.js" defer></script><script src="/assets/js/9.dba8a9bf.js" defer></script><script src="/assets/js/12.3f1ed9aa.js" defer></script>
  </body>
</html>
